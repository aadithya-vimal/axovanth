This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
.npmrc
convex/_generated/api.d.ts
convex/_generated/api.js
convex/_generated/dataModel.d.ts
convex/_generated/server.d.ts
convex/_generated/server.js
convex/auth.config.js
convex/chat.ts
convex/companies.ts
convex/files.ts
convex/README.md
convex/roles.ts
convex/schema.ts
convex/tickets.ts
convex/tsconfig.json
convex/users.ts
convex/workspaces.ts
eslint.config.mjs
LICENSE
next.config.ts
package.json
postcss.config.mjs
public/file.svg
public/globe.svg
public/logo.png
public/next.svg
public/vercel.svg
public/window.svg
README.md
src/app/dashboard/[companyId]/admin/page.tsx
src/app/dashboard/[companyId]/assets/page.tsx
src/app/dashboard/[companyId]/chat/page.tsx
src/app/dashboard/[companyId]/layout.tsx
src/app/dashboard/[companyId]/page.tsx
src/app/dashboard/[companyId]/settings/page.tsx
src/app/dashboard/[companyId]/workflow/page.tsx
src/app/dashboard/[companyId]/ws/[workspaceId]/page.tsx
src/app/favicon.ico
src/app/globals.css
src/app/icon.tsx
src/app/layout.tsx
src/app/onboarding/page.tsx
src/app/page.tsx
src/components/providers/convex-provider.tsx
src/middleware.ts
tailwind.config.ts
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path=".npmrc">
legacy-peer-deps=true
</file>

<file path="convex/_generated/api.d.ts">
/* eslint-disable */
/**
 * Generated `api` utility.
 *
 * THIS CODE IS AUTOMATICALLY GENERATED.
 *
 * To regenerate, run `npx convex dev`.
 * @module
 */

import type * as chat from "../chat.js";
import type * as companies from "../companies.js";
import type * as files from "../files.js";
import type * as roles from "../roles.js";
import type * as tickets from "../tickets.js";
import type * as users from "../users.js";
import type * as workspaces from "../workspaces.js";

import type {
  ApiFromModules,
  FilterApi,
  FunctionReference,
} from "convex/server";

declare const fullApi: ApiFromModules<{
  chat: typeof chat;
  companies: typeof companies;
  files: typeof files;
  roles: typeof roles;
  tickets: typeof tickets;
  users: typeof users;
  workspaces: typeof workspaces;
}>;

/**
 * A utility for referencing Convex functions in your app's public API.
 *
 * Usage:
 * ```js
 * const myFunctionReference = api.myModule.myFunction;
 * ```
 */
export declare const api: FilterApi<
  typeof fullApi,
  FunctionReference<any, "public">
>;

/**
 * A utility for referencing Convex functions in your app's internal API.
 *
 * Usage:
 * ```js
 * const myFunctionReference = internal.myModule.myFunction;
 * ```
 */
export declare const internal: FilterApi<
  typeof fullApi,
  FunctionReference<any, "internal">
>;

export declare const components: {};
</file>

<file path="convex/_generated/api.js">
/* eslint-disable */
/**
 * Generated `api` utility.
 *
 * THIS CODE IS AUTOMATICALLY GENERATED.
 *
 * To regenerate, run `npx convex dev`.
 * @module
 */

import { anyApi, componentsGeneric } from "convex/server";

/**
 * A utility for referencing Convex functions in your app's API.
 *
 * Usage:
 * ```js
 * const myFunctionReference = api.myModule.myFunction;
 * ```
 */
export const api = anyApi;
export const internal = anyApi;
export const components = componentsGeneric();
</file>

<file path="convex/_generated/dataModel.d.ts">
/* eslint-disable */
/**
 * Generated data model types.
 *
 * THIS CODE IS AUTOMATICALLY GENERATED.
 *
 * To regenerate, run `npx convex dev`.
 * @module
 */

import type {
  DataModelFromSchemaDefinition,
  DocumentByName,
  TableNamesInDataModel,
  SystemTableNames,
} from "convex/server";
import type { GenericId } from "convex/values";
import schema from "../schema.js";

/**
 * The names of all of your Convex tables.
 */
export type TableNames = TableNamesInDataModel<DataModel>;

/**
 * The type of a document stored in Convex.
 *
 * @typeParam TableName - A string literal type of the table name (like "users").
 */
export type Doc<TableName extends TableNames> = DocumentByName<
  DataModel,
  TableName
>;

/**
 * An identifier for a document in Convex.
 *
 * Convex documents are uniquely identified by their `Id`, which is accessible
 * on the `_id` field. To learn more, see [Document IDs](https://docs.convex.dev/using/document-ids).
 *
 * Documents can be loaded using `db.get(tableName, id)` in query and mutation functions.
 *
 * IDs are just strings at runtime, but this type can be used to distinguish them from other
 * strings when type checking.
 *
 * @typeParam TableName - A string literal type of the table name (like "users").
 */
export type Id<TableName extends TableNames | SystemTableNames> =
  GenericId<TableName>;

/**
 * A type describing your Convex data model.
 *
 * This type includes information about what tables you have, the type of
 * documents stored in those tables, and the indexes defined on them.
 *
 * This type is used to parameterize methods like `queryGeneric` and
 * `mutationGeneric` to make them type-safe.
 */
export type DataModel = DataModelFromSchemaDefinition<typeof schema>;
</file>

<file path="convex/_generated/server.d.ts">
/* eslint-disable */
/**
 * Generated utilities for implementing server-side Convex query and mutation functions.
 *
 * THIS CODE IS AUTOMATICALLY GENERATED.
 *
 * To regenerate, run `npx convex dev`.
 * @module
 */

import {
  ActionBuilder,
  HttpActionBuilder,
  MutationBuilder,
  QueryBuilder,
  GenericActionCtx,
  GenericMutationCtx,
  GenericQueryCtx,
  GenericDatabaseReader,
  GenericDatabaseWriter,
} from "convex/server";
import type { DataModel } from "./dataModel.js";

/**
 * Define a query in this Convex app's public API.
 *
 * This function will be allowed to read your Convex database and will be accessible from the client.
 *
 * @param func - The query function. It receives a {@link QueryCtx} as its first argument.
 * @returns The wrapped query. Include this as an `export` to name it and make it accessible.
 */
export declare const query: QueryBuilder<DataModel, "public">;

/**
 * Define a query that is only accessible from other Convex functions (but not from the client).
 *
 * This function will be allowed to read from your Convex database. It will not be accessible from the client.
 *
 * @param func - The query function. It receives a {@link QueryCtx} as its first argument.
 * @returns The wrapped query. Include this as an `export` to name it and make it accessible.
 */
export declare const internalQuery: QueryBuilder<DataModel, "internal">;

/**
 * Define a mutation in this Convex app's public API.
 *
 * This function will be allowed to modify your Convex database and will be accessible from the client.
 *
 * @param func - The mutation function. It receives a {@link MutationCtx} as its first argument.
 * @returns The wrapped mutation. Include this as an `export` to name it and make it accessible.
 */
export declare const mutation: MutationBuilder<DataModel, "public">;

/**
 * Define a mutation that is only accessible from other Convex functions (but not from the client).
 *
 * This function will be allowed to modify your Convex database. It will not be accessible from the client.
 *
 * @param func - The mutation function. It receives a {@link MutationCtx} as its first argument.
 * @returns The wrapped mutation. Include this as an `export` to name it and make it accessible.
 */
export declare const internalMutation: MutationBuilder<DataModel, "internal">;

/**
 * Define an action in this Convex app's public API.
 *
 * An action is a function which can execute any JavaScript code, including non-deterministic
 * code and code with side-effects, like calling third-party services.
 * They can be run in Convex's JavaScript environment or in Node.js using the "use node" directive.
 * They can interact with the database indirectly by calling queries and mutations using the {@link ActionCtx}.
 *
 * @param func - The action. It receives an {@link ActionCtx} as its first argument.
 * @returns The wrapped action. Include this as an `export` to name it and make it accessible.
 */
export declare const action: ActionBuilder<DataModel, "public">;

/**
 * Define an action that is only accessible from other Convex functions (but not from the client).
 *
 * @param func - The function. It receives an {@link ActionCtx} as its first argument.
 * @returns The wrapped function. Include this as an `export` to name it and make it accessible.
 */
export declare const internalAction: ActionBuilder<DataModel, "internal">;

/**
 * Define an HTTP action.
 *
 * The wrapped function will be used to respond to HTTP requests received
 * by a Convex deployment if the requests matches the path and method where
 * this action is routed. Be sure to route your httpAction in `convex/http.js`.
 *
 * @param func - The function. It receives an {@link ActionCtx} as its first argument
 * and a Fetch API `Request` object as its second.
 * @returns The wrapped function. Import this function from `convex/http.js` and route it to hook it up.
 */
export declare const httpAction: HttpActionBuilder;

/**
 * A set of services for use within Convex query functions.
 *
 * The query context is passed as the first argument to any Convex query
 * function run on the server.
 *
 * This differs from the {@link MutationCtx} because all of the services are
 * read-only.
 */
export type QueryCtx = GenericQueryCtx<DataModel>;

/**
 * A set of services for use within Convex mutation functions.
 *
 * The mutation context is passed as the first argument to any Convex mutation
 * function run on the server.
 */
export type MutationCtx = GenericMutationCtx<DataModel>;

/**
 * A set of services for use within Convex action functions.
 *
 * The action context is passed as the first argument to any Convex action
 * function run on the server.
 */
export type ActionCtx = GenericActionCtx<DataModel>;

/**
 * An interface to read from the database within Convex query functions.
 *
 * The two entry points are {@link DatabaseReader.get}, which fetches a single
 * document by its {@link Id}, or {@link DatabaseReader.query}, which starts
 * building a query.
 */
export type DatabaseReader = GenericDatabaseReader<DataModel>;

/**
 * An interface to read from and write to the database within Convex mutation
 * functions.
 *
 * Convex guarantees that all writes within a single mutation are
 * executed atomically, so you never have to worry about partial writes leaving
 * your data in an inconsistent state. See [the Convex Guide](https://docs.convex.dev/understanding/convex-fundamentals/functions#atomicity-and-optimistic-concurrency-control)
 * for the guarantees Convex provides your functions.
 */
export type DatabaseWriter = GenericDatabaseWriter<DataModel>;
</file>

<file path="convex/_generated/server.js">
/* eslint-disable */
/**
 * Generated utilities for implementing server-side Convex query and mutation functions.
 *
 * THIS CODE IS AUTOMATICALLY GENERATED.
 *
 * To regenerate, run `npx convex dev`.
 * @module
 */

import {
  actionGeneric,
  httpActionGeneric,
  queryGeneric,
  mutationGeneric,
  internalActionGeneric,
  internalMutationGeneric,
  internalQueryGeneric,
} from "convex/server";

/**
 * Define a query in this Convex app's public API.
 *
 * This function will be allowed to read your Convex database and will be accessible from the client.
 *
 * @param func - The query function. It receives a {@link QueryCtx} as its first argument.
 * @returns The wrapped query. Include this as an `export` to name it and make it accessible.
 */
export const query = queryGeneric;

/**
 * Define a query that is only accessible from other Convex functions (but not from the client).
 *
 * This function will be allowed to read from your Convex database. It will not be accessible from the client.
 *
 * @param func - The query function. It receives a {@link QueryCtx} as its first argument.
 * @returns The wrapped query. Include this as an `export` to name it and make it accessible.
 */
export const internalQuery = internalQueryGeneric;

/**
 * Define a mutation in this Convex app's public API.
 *
 * This function will be allowed to modify your Convex database and will be accessible from the client.
 *
 * @param func - The mutation function. It receives a {@link MutationCtx} as its first argument.
 * @returns The wrapped mutation. Include this as an `export` to name it and make it accessible.
 */
export const mutation = mutationGeneric;

/**
 * Define a mutation that is only accessible from other Convex functions (but not from the client).
 *
 * This function will be allowed to modify your Convex database. It will not be accessible from the client.
 *
 * @param func - The mutation function. It receives a {@link MutationCtx} as its first argument.
 * @returns The wrapped mutation. Include this as an `export` to name it and make it accessible.
 */
export const internalMutation = internalMutationGeneric;

/**
 * Define an action in this Convex app's public API.
 *
 * An action is a function which can execute any JavaScript code, including non-deterministic
 * code and code with side-effects, like calling third-party services.
 * They can be run in Convex's JavaScript environment or in Node.js using the "use node" directive.
 * They can interact with the database indirectly by calling queries and mutations using the {@link ActionCtx}.
 *
 * @param func - The action. It receives an {@link ActionCtx} as its first argument.
 * @returns The wrapped action. Include this as an `export` to name it and make it accessible.
 */
export const action = actionGeneric;

/**
 * Define an action that is only accessible from other Convex functions (but not from the client).
 *
 * @param func - The function. It receives an {@link ActionCtx} as its first argument.
 * @returns The wrapped function. Include this as an `export` to name it and make it accessible.
 */
export const internalAction = internalActionGeneric;

/**
 * Define an HTTP action.
 *
 * The wrapped function will be used to respond to HTTP requests received
 * by a Convex deployment if the requests matches the path and method where
 * this action is routed. Be sure to route your httpAction in `convex/http.js`.
 *
 * @param func - The function. It receives an {@link ActionCtx} as its first argument
 * and a Fetch API `Request` object as its second.
 * @returns The wrapped function. Import this function from `convex/http.js` and route it to hook it up.
 */
export const httpAction = httpActionGeneric;
</file>

<file path="convex/auth.config.js">
export default {
  providers: [
    {
      domain: "https://grateful-grackle-82.clerk.accounts.dev",
      applicationID: "convex",
    },
  ]
};
</file>

<file path="convex/companies.ts">
import { v } from "convex/values";
import { mutation, query } from "./_generated/server";

export const create = mutation({
  args: {
    name: v.string(),
    logoUrl: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized access");

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerkId", (q) => q.eq("clerkId", identity.subject))
      .unique();

    if (!user) throw new Error("User not found");

    const companyId = await ctx.db.insert("companies", {
      name: args.name,
      adminId: user._id,
      logoUrl: args.logoUrl,
      description: "A revolutionary workspace."
    });

    await ctx.db.insert("companyMembers", {
      companyId,
      userId: user._id,
      role: "admin",
      status: "active",
    });

    const workspaceId = await ctx.db.insert("workspaces", {
      companyId,
      name: "General",
      emoji: "ðŸ¢",
      workspaceHeadId: user._id,
      isDefault: true,
    });
    
    await ctx.db.insert("workspaceMembers", {
      workspaceId,
      userId: user._id,
      role: "admin",
    });

    return { companyId, workspaceId };
  },
});

export const updateDetails = mutation({
  args: {
    companyId: v.id("companies"),
    name: v.string(),
    description: v.optional(v.string()),
    logoUrl: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");
    const user = await ctx.db.query("users").withIndex("by_clerkId", q => q.eq("clerkId", identity.subject)).unique();
    const company = await ctx.db.get(args.companyId);
    if (!company || company.adminId !== user?._id) throw new Error("Only the owner can edit company details");

    await ctx.db.patch(args.companyId, {
      name: args.name,
      description: args.description,
      logoUrl: args.logoUrl
    });
  }
});

export const transferOwnership = mutation({
  args: {
    companyId: v.id("companies"),
    newOwnerId: v.id("users"),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");
    const user = await ctx.db.query("users").withIndex("by_clerkId", q => q.eq("clerkId", identity.subject)).unique();
    const company = await ctx.db.get(args.companyId);
    if (!company || company.adminId !== user?._id) throw new Error("Only the owner can transfer ownership");

    await ctx.db.patch(args.companyId, { adminId: args.newOwnerId });
    const member = await ctx.db.query("companyMembers").withIndex("by_company_and_user", q => q.eq("companyId", args.companyId).eq("userId", args.newOwnerId)).unique();
    if (member) await ctx.db.patch(member._id, { role: "admin" });
  }
});

export const deleteCompany = mutation({
  args: { companyId: v.id("companies") },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");
    const user = await ctx.db.query("users").withIndex("by_clerkId", q => q.eq("clerkId", identity.subject)).unique();
    const company = await ctx.db.get(args.companyId);
    if (!company || company.adminId !== user?._id) throw new Error("Only the owner can delete the company");

    await ctx.db.delete(args.companyId);
  }
});

export const getAll = query({
  args: {},
  handler: async (ctx) => {
    return await ctx.db.query("companies").collect();
  },
});

export const getMyMemberships = query({
  args: {},
  handler: async (ctx) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) return [];
    const user = await ctx.db.query("users").withIndex("by_clerkId", (q) => q.eq("clerkId", identity.subject)).unique();
    if (!user) return [];
    return await ctx.db.query("companyMembers").withIndex("by_user", (q) => q.eq("userId", user._id)).collect();
  },
});

export const getById = query({
  args: { id: v.id("companies") },
  handler: async (ctx, args) => {
    return await ctx.db.get(args.id);
  },
});

export const getMemberRecord = query({
  args: { companyId: v.id("companies") },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) return null;
    const user = await ctx.db.query("users").withIndex("by_clerkId", (q) => q.eq("clerkId", identity.subject)).unique();
    if (!user) return null;
    return await ctx.db.query("companyMembers").withIndex("by_company_and_user", (q) => q.eq("companyId", args.companyId).eq("userId", user._id)).unique();
  },
});

export const getMembers = query({
  args: { companyId: v.id("companies") },
  handler: async (ctx, args) => {
    const members = await ctx.db.query("companyMembers").withIndex("by_company_and_user", (q) => q.eq("companyId", args.companyId)).collect();
    return await Promise.all(
      members.map(async (member) => {
        const user = await ctx.db.get(member.userId);
        let roleName = member.designation;
        let customRole = null;
        if (member.roleId) {
          customRole = await ctx.db.get(member.roleId);
          if (customRole) roleName = customRole.name;
        }
        return { ...member, user, roleName, customRole };
      })
    );
  },
});

// Consolidated update profile (Designation, Role, System Role)
export const updateMemberProfile = mutation({
  args: {
    memberId: v.id("companyMembers"),
    role: v.union(v.literal("admin"), v.literal("employee")),
    roleId: v.optional(v.id("roles")),
    designation: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");
    const requesterUser = await ctx.db.query("users").withIndex("by_clerkId", (q) => q.eq("clerkId", identity.subject)).unique();
    const memberToUpdate = await ctx.db.get(args.memberId);
    if (!memberToUpdate || !requesterUser) throw new Error("Record not found");
    
    // Check permissions
    const isSelf = memberToUpdate.userId === requesterUser._id;
    const requesterMember = await ctx.db.query("companyMembers").withIndex("by_company_and_user", (q) => q.eq("companyId", memberToUpdate.companyId).eq("userId", requesterUser._id)).unique();
    const isAdmin = requesterMember?.role === "admin";

    if (!isAdmin && !isSelf) throw new Error("Security Violation: Insufficient privileges.");
    
    // Strict System Role Checks
    if (args.role !== memberToUpdate.role) {
        if (!isAdmin) throw new Error("Security Violation: Only admins can change system roles.");
        
        const company = await ctx.db.get(memberToUpdate.companyId);
        
        // Prevent demoting Owner
        if (company?.adminId === memberToUpdate.userId && args.role !== "admin") {
             throw new Error("Security Violation: Cannot demote the Organization Owner.");
        }

        // Prevent Self-Demotion (Safety Lock)
        if (memberToUpdate.userId === requesterUser._id && args.role !== "admin") {
             throw new Error("Safety Lock: You cannot demote yourself. Ask another admin to do this.");
        }
    }

    await ctx.db.patch(args.memberId, { 
      role: args.role,
      roleId: args.roleId,
      designation: args.designation 
    });
  },
});

// Legacy single-purpose role update (kept for compatibility with inline dropdowns)
export const updateMemberRole = mutation({
  args: {
    memberId: v.id("companyMembers"),
    role: v.union(v.literal("admin"), v.literal("employee")),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");
    const requesterUser = await ctx.db.query("users").withIndex("by_clerkId", (q) => q.eq("clerkId", identity.subject)).unique();
    const memberToUpdate = await ctx.db.get(args.memberId);
    if (!memberToUpdate || !requesterUser) throw new Error("Record not found");
    
    const requesterMember = await ctx.db.query("companyMembers").withIndex("by_company_and_user", (q) => q.eq("companyId", memberToUpdate.companyId).eq("userId", requesterUser._id)).unique();
    const company = await ctx.db.get(memberToUpdate.companyId);

    // 1. Only Admins can use this
    if (requesterMember?.role !== "admin") throw new Error("Security Violation: Insufficient privileges.");
    
    // 2. Cannot demote Owner
    if (company?.adminId === memberToUpdate.userId && args.role !== "admin") throw new Error("Security Violation: Cannot demote the Organization Owner.");

    // 3. Cannot demote Self
    if (memberToUpdate.userId === requesterUser._id && args.role !== "admin") throw new Error("Safety Lock: You cannot demote yourself.");

    await ctx.db.patch(args.memberId, { role: args.role });
  },
});

export const updateMemberStatus = mutation({
  args: {
    memberId: v.id("companyMembers"),
    status: v.union(v.literal("active"), v.literal("pending")),
  },
  handler: async (ctx, args) => {
    const member = await ctx.db.get(args.memberId);
    if (!member) throw new Error("Member not found");
    await ctx.db.patch(args.memberId, { status: args.status });
    if (args.status === "active") {
      const generalWs = await ctx.db.query("workspaces")
        .withIndex("by_company", q => q.eq("companyId", member.companyId))
        .filter(q => q.eq(q.field("isDefault"), true))
        .unique();
      if (generalWs) {
        const existing = await ctx.db.query("workspaceMembers").withIndex("by_workspace_and_user", q => q.eq("workspaceId", generalWs._id).eq("userId", member.userId)).unique();
        if (!existing) {
          await ctx.db.insert("workspaceMembers", { workspaceId: generalWs._id, userId: member.userId, role: "member" });
        }
      }
    }
  },
});

export const updateMemberDesignation = mutation({
  args: {
    memberId: v.id("companyMembers"),
    designation: v.string(),
  },
  handler: async (ctx, args) => {
    await ctx.db.patch(args.memberId, { designation: args.designation });
  },
});

export const removeMember = mutation({
  args: { memberId: v.id("companyMembers") },
  handler: async (ctx, args) => {
    await ctx.db.delete(args.memberId);
  },
});

export const requestAccess = mutation({
  args: { companyId: v.id("companies") },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");
    const user = await ctx.db.query("users").withIndex("by_clerkId", (q) => q.eq("clerkId", identity.subject)).unique();
    if (!user) throw new Error("User record not found");
    const existingMembership = await ctx.db.query("companyMembers").withIndex("by_company_and_user", (q) => q.eq("companyId", args.companyId).eq("userId", user._id)).unique();
    if (existingMembership) throw new Error("Membership already exists or is pending.");
    await ctx.db.insert("companyMembers", {
      companyId: args.companyId,
      userId: user._id,
      role: "employee",
      status: "pending",
    });
    return "requested";
  },
});
</file>

<file path="convex/files.ts">
import { v } from "convex/values";
import { mutation, query } from "./_generated/server";

export const generateUploadUrl = mutation(async (ctx) => {
  return await ctx.storage.generateUploadUrl();
});

export const sendFile = mutation({
  args: {
    storageId: v.id("_storage"),
    workspaceId: v.id("workspaces"),
    fileName: v.string(),
    fileType: v.string(),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerkId", (q) => q.eq("clerkId", identity.subject))
      .unique();

    await ctx.db.insert("assets", {
      workspaceId: args.workspaceId,
      storageId: args.storageId,
      fileName: args.fileName,
      fileType: args.fileType,
      uploaderId: user!._id,
    });
  },
});

export const getByWorkspace = query({
  args: { workspaceId: v.id("workspaces") },
  handler: async (ctx, args) => {
    const assets = await ctx.db
      .query("assets")
      .withIndex("by_workspace", (q) => q.eq("workspaceId", args.workspaceId))
      .collect();

    return Promise.all(
      assets.map(async (asset) => ({
        ...asset,
        url: await ctx.storage.getUrl(asset.storageId),
      }))
    );
  },
});
</file>

<file path="convex/README.md">
# Welcome to your Convex functions directory!

Write your Convex functions here.
See https://docs.convex.dev/functions for more.

A query function that takes two arguments looks like:

```ts
// convex/myFunctions.ts
import { query } from "./_generated/server";
import { v } from "convex/values";

export const myQueryFunction = query({
  // Validators for arguments.
  args: {
    first: v.number(),
    second: v.string(),
  },

  // Function implementation.
  handler: async (ctx, args) => {
    // Read the database as many times as you need here.
    // See https://docs.convex.dev/database/reading-data.
    const documents = await ctx.db.query("tablename").collect();

    // Arguments passed from the client are properties of the args object.
    console.log(args.first, args.second);

    // Write arbitrary JavaScript here: filter, aggregate, build derived data,
    // remove non-public properties, or create new objects.
    return documents;
  },
});
```

Using this query function in a React component looks like:

```ts
const data = useQuery(api.myFunctions.myQueryFunction, {
  first: 10,
  second: "hello",
});
```

A mutation function looks like:

```ts
// convex/myFunctions.ts
import { mutation } from "./_generated/server";
import { v } from "convex/values";

export const myMutationFunction = mutation({
  // Validators for arguments.
  args: {
    first: v.string(),
    second: v.string(),
  },

  // Function implementation.
  handler: async (ctx, args) => {
    // Insert or modify documents in the database here.
    // Mutations can also read from the database like queries.
    // See https://docs.convex.dev/database/writing-data.
    const message = { body: args.first, author: args.second };
    const id = await ctx.db.insert("messages", message);

    // Optionally, return a value from your mutation.
    return await ctx.db.get("messages", id);
  },
});
```

Using this mutation function in a React component looks like:

```ts
const mutation = useMutation(api.myFunctions.myMutationFunction);
function handleButtonPress() {
  // fire and forget, the most common way to use mutations
  mutation({ first: "Hello!", second: "me" });
  // OR
  // use the result once the mutation has completed
  mutation({ first: "Hello!", second: "me" }).then((result) =>
    console.log(result),
  );
}
```

Use the Convex CLI to push your functions to a deployment. See everything
the Convex CLI can do by running `npx convex -h` in your project root
directory. To learn more, launch the docs with `npx convex docs`.
</file>

<file path="convex/roles.ts">
import { v } from "convex/values";
import { mutation, query } from "./_generated/server";

export const getRoles = query({
  args: { companyId: v.id("companies") },
  handler: async (ctx, args) => {
    return await ctx.db.query("roles").withIndex("by_company", q => q.eq("companyId", args.companyId)).collect();
  }
});

export const createRole = mutation({
  args: { companyId: v.id("companies"), name: v.string(), color: v.string(), description: v.string() },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");
    
    const user = await ctx.db.query("users").withIndex("by_clerkId", q => q.eq("clerkId", identity.subject)).unique();
    if (!user) throw new Error("User not found"); // FIX: Ensure user exists

    const member = await ctx.db.query("companyMembers").withIndex("by_company_and_user", q => q.eq("companyId", args.companyId).eq("userId", user._id)).unique();
    if (member?.role !== "admin") throw new Error("Only admins can create roles");

    await ctx.db.insert("roles", {
      companyId: args.companyId,
      name: args.name,
      color: args.color,
      description: args.description
    });
  }
});

export const deleteRole = mutation({
  args: { roleId: v.id("roles") },
  handler: async (ctx, args) => {
    await ctx.db.delete(args.roleId);
  }
});

export const requestRole = mutation({
  args: { companyId: v.id("companies"), roleId: v.id("roles") },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");
    
    const user = await ctx.db.query("users").withIndex("by_clerkId", q => q.eq("clerkId", identity.subject)).unique();
    if (!user) throw new Error("User not found"); // FIX: Ensure user exists

    // Check pending
    const existing = await ctx.db.query("roleRequests").withIndex("by_company", q => q.eq("companyId", args.companyId))
      .filter(q => q.eq(q.field("userId"), user._id))
      .filter(q => q.eq(q.field("status"), "pending"))
      .first();
    
    if (existing) throw new Error("You already have a pending request.");

    await ctx.db.insert("roleRequests", {
      companyId: args.companyId,
      userId: user._id,
      roleId: args.roleId,
      status: "pending"
    });
  }
});

export const getRequests = query({
  args: { companyId: v.id("companies") },
  handler: async (ctx, args) => {
    const reqs = await ctx.db.query("roleRequests").withIndex("by_company", q => q.eq("companyId", args.companyId)).collect();
    const pending = reqs.filter(r => r.status === "pending");
    
    return await Promise.all(pending.map(async (r) => {
      const user = await ctx.db.get(r.userId);
      const role = await ctx.db.get(r.roleId);
      return { ...r, user, role };
    }));
  }
});

export const resolveRequest = mutation({
  args: { requestId: v.id("roleRequests"), approved: v.boolean() },
  handler: async (ctx, args) => {
    const req = await ctx.db.get(args.requestId);
    if (!req) throw new Error("Request not found");
    
    await ctx.db.patch(args.requestId, { status: args.approved ? "approved" : "rejected" });

    if (args.approved) {
      const member = await ctx.db.query("companyMembers").withIndex("by_company_and_user", q => q.eq("companyId", req.companyId).eq("userId", req.userId)).unique();
      if (member) {
        await ctx.db.patch(member._id, { roleId: req.roleId });
      }
    }
  }
});
</file>

<file path="convex/tickets.ts">
import { v } from "convex/values";
import { mutation, query } from "./_generated/server";

// Security Helper
async function validateAccess(ctx: any, companyId: any, workspaceId?: any) {
  const identity = await ctx.auth.getUserIdentity();
  if (!identity) throw new Error("Unauthorized Access");

  const user = await ctx.db
    .query("users")
    .withIndex("by_clerkId", (q: any) => q.eq("clerkId", identity.subject))
    .unique();
  if (!user) throw new Error("User Record Corrupted");

  const companyMember = await ctx.db
    .query("companyMembers")
    .withIndex("by_company_and_user", (q: any) => q.eq("companyId", companyId).eq("userId", user._id))
    .unique();

  const isOverallAdmin = companyMember?.role === "admin";
  let isWorkspaceAdmin = false;
  
  if (workspaceId) {
    const wsMember = await ctx.db
      .query("workspaceMembers")
      .withIndex("by_workspace_and_user", (q: any) => q.eq("workspaceId", workspaceId).eq("userId", user._id))
      .unique();
    isWorkspaceAdmin = wsMember?.role === "admin";
    const workspace = await ctx.db.get(workspaceId);
    if (workspace?.workspaceHeadId === user._id) isWorkspaceAdmin = true;
  }

  return { user, isOverallAdmin, isWorkspaceAdmin, hasAdminRights: isOverallAdmin || isWorkspaceAdmin };
}

export const create = mutation({
  args: {
    companyId: v.id("companies"),
    workspaceId: v.id("workspaces"),
    title: v.string(),
    description: v.string(),
    priority: v.union(v.literal("low"), v.literal("medium"), v.literal("high")),
    type: v.optional(v.union(v.literal("bug"), v.literal("feature"), v.literal("task"))),
  },
  handler: async (ctx, args) => {
    const { user } = await validateAccess(ctx, args.companyId);
    const ticketId = await ctx.db.insert("tickets", {
      ...args,
      creatorId: user._id,
      status: "open",
      type: args.type || "task",
    });

    await ctx.db.insert("ticketEvents", {
      ticketId,
      actorId: user._id,
      type: "created",
      metadata: "Flow initialized",
    });
    return ticketId;
  },
});

export const updatePriority = mutation({
  args: { ticketId: v.id("tickets"), priority: v.union(v.literal("low"), v.literal("medium"), v.literal("high")) },
  handler: async (ctx, args) => {
    const ticket = await ctx.db.get(args.ticketId);
    if (!ticket) throw new Error("Invalid Ticket");
    const { hasAdminRights, user } = await validateAccess(ctx, ticket.companyId, ticket.workspaceId);
    
    if (!hasAdminRights) throw new Error("Security Violation: Only Admins can modify priority.");
    
    await ctx.db.patch(args.ticketId, { priority: args.priority });

    await ctx.db.insert("ticketEvents", {
      ticketId: args.ticketId,
      actorId: user._id,
      type: "priority_update",
      metadata: `Priority changed to ${args.priority}`,
    });
  },
});

export const assign = mutation({
  args: { ticketId: v.id("tickets"), assigneeId: v.optional(v.id("users")) },
  handler: async (ctx, args) => {
    const ticket = await ctx.db.get(args.ticketId);
    if (!ticket) throw new Error("Invalid Ticket");
    const { hasAdminRights, user } = await validateAccess(ctx, ticket.companyId, ticket.workspaceId);

    if (!hasAdminRights) throw new Error("Security Violation: Only Admins can assign tickets.");
    
    await ctx.db.patch(args.ticketId, { assigneeId: args.assigneeId });

    let meta = "Ticket unassigned";
    if (args.assigneeId) {
      const assignee = await ctx.db.get(args.assigneeId);
      meta = `Assigned to ${assignee?.name}`;
    }

    await ctx.db.insert("ticketEvents", {
      ticketId: args.ticketId,
      actorId: user._id,
      type: "assignment_update",
      metadata: meta,
    });
  },
});

export const setDueDate = mutation({
  args: { ticketId: v.id("tickets"), dueDate: v.optional(v.number()) },
  handler: async (ctx, args) => {
    const ticket = await ctx.db.get(args.ticketId);
    if (!ticket) throw new Error("Invalid Ticket");
    const { hasAdminRights, user } = await validateAccess(ctx, ticket.companyId, ticket.workspaceId);

    if (!hasAdminRights) throw new Error("Security Violation: Only Admins can set deadlines.");
    
    await ctx.db.patch(args.ticketId, { dueDate: args.dueDate });

    const meta = args.dueDate ? `Due date set to ${new Date(args.dueDate).toLocaleDateString()}` : "Due date removed";

    await ctx.db.insert("ticketEvents", {
      ticketId: args.ticketId,
      actorId: user._id,
      type: "schedule_update",
      metadata: meta,
    });
  },
});

export const transfer = mutation({
  args: {
    ticketId: v.id("tickets"),
    targetWorkspaceId: v.id("workspaces"),
  },
  handler: async (ctx, args) => {
    const ticket = await ctx.db.get(args.ticketId);
    if (!ticket) throw new Error("Flow ID Invalid");
    const { hasAdminRights, user } = await validateAccess(ctx, ticket.companyId, ticket.workspaceId);
    
    if (!hasAdminRights) throw new Error("Security Violation: Only Admins can transfer tickets.");

    const oldWs = await ctx.db.get(ticket.workspaceId);
    const newWs = await ctx.db.get(args.targetWorkspaceId);

    await ctx.db.patch(args.ticketId, { 
      workspaceId: args.targetWorkspaceId,
      status: "transferred" 
    });

    await ctx.db.insert("ticketEvents", {
      ticketId: args.ticketId,
      actorId: user._id,
      type: "transferred",
      metadata: `Transferred from ${oldWs?.name} to ${newWs?.name}`,
    });
  },
});

export const resolve = mutation({
  args: { ticketId: v.id("tickets") },
  handler: async (ctx, args) => {
    const ticket = await ctx.db.get(args.ticketId);
    if (!ticket) throw new Error("Flow ID Invalid");
    const { hasAdminRights, user } = await validateAccess(ctx, ticket.companyId, ticket.workspaceId);
    if (!hasAdminRights) throw new Error("Security Violation");

    await ctx.db.patch(args.ticketId, { status: "resolved" });

    await ctx.db.insert("ticketEvents", {
      ticketId: args.ticketId,
      actorId: user._id,
      type: "status_change",
      metadata: "Flow resolved successfully",
    });
  },
});

export const reopen = mutation({
  args: { ticketId: v.id("tickets") },
  handler: async (ctx, args) => {
    const ticket = await ctx.db.get(args.ticketId);
    if (!ticket) throw new Error("Flow ID Invalid");
    const { hasAdminRights, user } = await validateAccess(ctx, ticket.companyId, ticket.workspaceId);
    if (!hasAdminRights) throw new Error("Security Violation");

    await ctx.db.patch(args.ticketId, { status: "open" });

    await ctx.db.insert("ticketEvents", {
      ticketId: args.ticketId,
      actorId: user._id,
      type: "status_change",
      metadata: "Flow reopened for further action",
    });
  },
});

export const addComment = mutation({
  args: { ticketId: v.id("tickets"), content: v.string() },
  handler: async (ctx, args) => {
    const ticket = await ctx.db.get(args.ticketId);
    if (!ticket) throw new Error("Flow ID Invalid");
    const { user } = await validateAccess(ctx, ticket.companyId);

    await ctx.db.insert("ticketComments", {
      ticketId: args.ticketId,
      authorId: user._id,
      content: args.content,
    });
  },
});

export const getComments = query({
  args: { ticketId: v.id("tickets") },
  handler: async (ctx, args) => {
    const ticket = await ctx.db.get(args.ticketId);
    if (!ticket) return []; 

    const comments = await ctx.db.query("ticketComments").withIndex("by_ticket", (q) => q.eq("ticketId", args.ticketId)).collect();
    
    return await Promise.all(comments.map(async (c) => {
      const author = await ctx.db.get(c.authorId);
      const member = await ctx.db.query("companyMembers")
        .withIndex("by_company_and_user", q => q.eq("companyId", ticket.companyId).eq("userId", c.authorId))
        .unique();
        
      return { ...c, author, customRole: member?.designation };
    }));
  },
});

// NEW: Fetches the audit log for a ticket
export const getEvents = query({
  args: { ticketId: v.id("tickets") },
  handler: async (ctx, args) => {
    const events = await ctx.db.query("ticketEvents").withIndex("by_ticket", (q) => q.eq("ticketId", args.ticketId)).order("desc").collect();
    
    return await Promise.all(events.map(async (e) => {
      const actor = await ctx.db.get(e.actorId);
      return { ...e, actor };
    }));
  },
});

export const getByWorkspace = query({
  args: { workspaceId: v.id("workspaces") },
  handler: async (ctx, args) => {
    const tickets = await ctx.db.query("tickets").withIndex("by_workspace", (q) => q.eq("workspaceId", args.workspaceId)).collect();
    return await Promise.all(tickets.map(async (t) => {
      const assignee = t.assigneeId ? await ctx.db.get(t.assigneeId) : null;
      return { ...t, assignee };
    }));
  },
});

// NEW: Fetches ALL tickets for the company (for the global Operational Workflow)
export const getAll = query({
  args: { companyId: v.id("companies") },
  handler: async (ctx, args) => {
    const tickets = await ctx.db.query("tickets").withIndex("by_company", (q) => q.eq("companyId", args.companyId)).collect();
    return await Promise.all(tickets.map(async (t) => {
      const assignee = t.assigneeId ? await ctx.db.get(t.assigneeId) : null;
      const workspace = await ctx.db.get(t.workspaceId);
      return { ...t, assignee, workspace };
    }));
  },
});
</file>

<file path="convex/tsconfig.json">
{
  /* This TypeScript project config describes the environment that
   * Convex functions run in and is used to typecheck them.
   * You can modify it, but some settings are required to use Convex.
   */
  "compilerOptions": {
    /* These settings are not required by Convex and can be modified. */
    "allowJs": true,
    "strict": true,
    "moduleResolution": "Bundler",
    "jsx": "react-jsx",
    "skipLibCheck": true,
    "allowSyntheticDefaultImports": true,

    /* These compiler options are required by Convex */
    "target": "ESNext",
    "lib": ["ES2021", "dom"],
    "forceConsistentCasingInFileNames": true,
    "module": "ESNext",
    "isolatedModules": true,
    "noEmit": true
  },
  "include": ["./**/*"],
  "exclude": ["./_generated"]
}
</file>

<file path="convex/users.ts">
import { v } from "convex/values";
import { mutation, query } from "./_generated/server";

/**
 * Syncs a user from Clerk to the Convex database.
 */
export const store = mutation({
  args: {},
  handler: async (ctx) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new Error("Called storeUser without authentication identity");
    }

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerkId", (q) => q.eq("clerkId", identity.subject))
      .unique();

    if (user !== null) {
      if (user.name !== identity.name || user.image !== identity.pictureUrl) {
        await ctx.db.patch(user._id, {
          image: identity.pictureUrl,
        });
      }
      return user._id;
    }

    return await ctx.db.insert("users", {
      name: identity.name ?? "Anonymous",
      email: identity.email ?? "",
      clerkId: identity.subject,
      image: identity.pictureUrl,
    });
  },
});

export const currentUser = query({
  args: {},
  handler: async (ctx) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) return null;

    return await ctx.db
      .query("users")
      .withIndex("by_clerkId", (q) => q.eq("clerkId", identity.subject))
      .unique();
  },
});

// NEW: Allow users to update their display name
export const updateName = mutation({
  args: { name: v.string() },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerkId", (q) => q.eq("clerkId", identity.subject))
      .unique();

    if (!user) throw new Error("User not found");

    await ctx.db.patch(user._id, { name: args.name });
  },
});
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="LICENSE">
StatusCode        : 200
StatusDescription : OK
Content           :                     
                    GNU AFFERO GENERAL 
                    PUBLIC LICENSE
                                           
                    Version 3, 19 November 
                    2007
                    
                     Copyright (C) 2007 
                    Free Software 
                    Foundation, Inc. 
                    <https://fsf.org/>
                     Everyone is permitted 
                    t...
RawContent        : HTTP/1.1 200 OK
                    Strict-Transport-Securi
                    ty: max-age=63072000
                    X-Frame-Options: 
                    sameorigin
                    X-Content-Type-Options:
                     nosniff
                    Access-Control-Allow-Or
                    igin: (null)
                    Vary: Accept-Encoding
                    Keep-Alive: time...
Forms             : {}
Headers           : {[Strict-Transport-Secu
                    rity, 
                    max-age=63072000], 
                    [X-Frame-Options, 
                    sameorigin], [X-Content
                    -Type-Options, 
                    nosniff], [Access-Contr
                    ol-Allow-Origin, 
                    (null)]...}
Images            : {}
InputFields       : {}
Links             : {}
ParsedHtml        : mshtml.HTMLDocumentClas
                    s
RawContentLength  : 34523
</file>

<file path="next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
  reactCompiler: true,
};

export default nextConfig;
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="src/app/dashboard/[companyId]/assets/page.tsx">
"use client";

import { useQuery } from "convex/react";
import { api } from "../../../../../convex/_generated/api";
import { useParams } from "next/navigation";
import { FolderRoot, Upload, FileText, MoreVertical, Search, Filter, Loader2 } from "lucide-react";

export default function AssetVault() {
  const params = useParams();
  const companyId = params.companyId as any;
  
  // You might want to fetch actual assets here if needed globally, 
  // but usually assets are workspace-specific. 
  // For this view, we'll assume a global or aggregated view if implemented, 
  // or just static for now as per your repo state.
  // Ideally: const assets = useQuery(api.files.getByCompany, { companyId }); 

  return (
    <div className="max-w-7xl mx-auto space-y-8 pb-32 animate-in fade-in slide-in-from-bottom-6 duration-700 font-sans">
      
      {/* HEADER */}
      <header className="flex flex-col md:flex-row md:items-end justify-between border-b border-border pb-8 gap-6">
        <div className="space-y-2">
          <div className="flex items-center gap-2 text-accent font-bold text-[10px] uppercase tracking-wider mb-2">
             <div className="w-2 h-2 rounded-full bg-accent animate-pulse" /> Encrypted Storage
          </div>
          <h1 className="text-4xl font-semibold tracking-tight text-foreground">Asset Vault</h1>
          <p className="text-muted text-lg font-normal">Secure centralized storage & file protocol.</p>
        </div>
        <button className="apple-button shadow-lg shadow-accent/20">
          <Upload className="w-5 h-5" /> Upload Asset
        </button>
      </header>

      {/* SEARCH BAR */}
      <div className="flex flex-col md:flex-row gap-4">
        <div className="flex-1 glass-panel px-6 py-4 rounded-2xl flex items-center gap-3 border-border hover:border-accent/50 transition-all">
          <Search className="w-5 h-5 text-muted" />
          <input 
            placeholder="Search encrypted assets..." 
            className="bg-transparent border-none outline-none w-full text-sm font-medium text-foreground placeholder:text-muted" 
          />
        </div>
        <button className="px-6 py-4 glass-panel rounded-2xl border-border text-sm font-semibold flex items-center gap-2 hover:bg-foreground/5 transition-all text-foreground">
          <Filter className="w-4 h-4" /> Filter
        </button>
      </div>

      {/* ASSET TABLE */}
      <section className="glass-panel rounded-[32px] overflow-hidden border-border bg-background shadow-sm">
        <table className="w-full text-left">
          <thead className="bg-foreground/[0.02] border-b border-border">
            <tr>
              <th className="px-8 py-5 text-[10px] font-bold text-muted uppercase tracking-wider">Asset Name</th>
              <th className="px-8 py-5 text-[10px] font-bold text-muted uppercase tracking-wider">Type</th>
              <th className="px-8 py-5 text-[10px] font-bold text-muted uppercase tracking-wider text-right">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-border">
            {/* Example Static Data - Replace with map when ready */}
            <tr className="hover:bg-foreground/5 transition-all group">
              <td className="px-8 py-6 flex items-center gap-4">
                <div className="w-12 h-12 bg-accent/10 rounded-2xl flex items-center justify-center border border-accent/20">
                  <FileText className="text-accent w-6 h-6" />
                </div>
                <div>
                  <p className="font-semibold text-foreground text-sm">Organization_Charter_2026.pdf</p>
                  <p className="text-[10px] text-muted font-bold uppercase tracking-wider mt-1 opacity-70">Uploaded by System Admin</p>
                </div>
              </td>
              <td className="px-8 py-6">
                <span className="px-3 py-1 bg-foreground/5 rounded-lg text-[10px] font-bold uppercase tracking-wider text-muted border border-border">Document</span>
              </td>
              <td className="px-8 py-6 text-right">
                <button className="p-2 text-muted hover:text-foreground hover:bg-foreground/10 rounded-lg transition-all">
                  <MoreVertical className="w-5 h-5" />
                </button>
              </td>
            </tr>
          </tbody>
        </table>
        
        {/* Empty State / Placeholder */}
        <div className="p-20 text-center">
          <div className="w-16 h-16 bg-foreground/5 rounded-full flex items-center justify-center mx-auto mb-6 border border-border">
            <FolderRoot className="w-8 h-8 text-muted opacity-50" />
          </div>
          <p className="text-foreground font-semibold text-sm">Vault Initialization Complete</p>
          <p className="text-muted text-xs font-medium mt-1">Ready for secure asset transmission.</p>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="src/app/dashboard/[companyId]/chat/page.tsx">
"use client";

import { useState, useRef, useEffect } from "react";
import { useQuery, useMutation } from "convex/react";
import { api } from "../../../../../convex/_generated/api";
import { useParams } from "next/navigation";
import { 
  Send, MessageCircle, ShieldCheck, Search, Users, 
  Paperclip, Smile, Hash, AtSign, Circle, CheckCheck, 
  File, X, Loader2
} from "lucide-react";
import { useUser } from "@clerk/nextjs";

export default function GeneralChat() {
  const params = useParams();
  const companyId = params.companyId as any;
  const { user: clerkUser } = useUser();
  const [message, setMessage] = useState("");
  const [searchTerm, setSearchTerm] = useState("");
  const [isSidebarOpen, setIsSidebarOpen] = useState(true);
  
  // File Upload State
  const [isUploading, setIsUploading] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // Data Queries
  const messages = useQuery(api.chat.getMessages, { companyId });
  const members = useQuery(api.companies.getMembers, { companyId });
  
  // Mutations
  const sendMessage = useMutation(api.chat.send);
  const generateUploadUrl = useMutation(api.files.generateUploadUrl);

  // Auto-scroll ref
  const scrollRef = useRef<HTMLDivElement>(null);

  const handleSend = async (e?: React.FormEvent, attachmentId?: string) => {
    if (e) e.preventDefault();
    if (!message.trim() && !attachmentId) return;

    try {
      await sendMessage({ 
        companyId, 
        content: message, 
        attachmentId: attachmentId as any 
      });
      setMessage("");
      // Smooth scroll to bottom
      setTimeout(() => scrollRef.current?.scrollIntoView({ behavior: "smooth" }), 100);
    } catch (err) {
      console.error("Failed to send:", err);
    }
  };

  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    setIsUploading(true);
    try {
      // 1. Get secure upload URL
      const postUrl = await generateUploadUrl();
      
      // 2. Upload file directly to storage
      const result = await fetch(postUrl, {
        method: "POST",
        headers: { "Content-Type": file.type },
        body: file,
      });
      
      if (!result.ok) throw new Error("Upload failed");
      
      const { storageId } = await result.json();
      
      // 3. Send message with attachment immediately
      await handleSend(undefined, storageId);
      
    } catch (error) {
      console.error("File transmission error:", error);
      alert("Failed to upload file.");
    } finally {
      setIsUploading(false);
      // Reset input so same file can be selected again if needed
      if (fileInputRef.current) fileInputRef.current.value = "";
    }
  };

  // Filter messages based on search
  const filteredMessages = messages?.filter(msg => 
    msg.content.toLowerCase().includes(searchTerm.toLowerCase()) ||
    msg.user?.name.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div className="max-w-7xl mx-auto h-[calc(100vh-100px)] flex gap-6 animate-in fade-in slide-in-from-bottom-4 duration-700 font-sans pb-6">
      
      {/* MAIN CHAT STREAM */}
      <div className="flex-1 flex flex-col glass-panel rounded-[32px] overflow-hidden border border-border shadow-sm bg-background/80 backdrop-blur-xl">
        
        {/* CHAT HEADER */}
        <header className="px-6 py-4 border-b border-border bg-background/50 backdrop-blur-md flex items-center justify-between z-10">
          <div className="flex items-center gap-4">
            <div className="w-10 h-10 bg-accent/10 rounded-xl flex items-center justify-center text-accent border border-accent/20">
              <Hash className="w-5 h-5" />
            </div>
            <div>
              <h2 className="text-sm font-bold text-foreground flex items-center gap-2">
                General Intelligence
                <ShieldCheck className="w-3.5 h-3.5 text-green-600" />
              </h2>
              <p className="text-[10px] text-muted font-bold uppercase tracking-widest flex items-center gap-2">
                <span className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse" />
                Live â€¢ Encrypted
              </p>
            </div>
          </div>

          <div className="flex items-center gap-3">
            <div className="hidden md:flex items-center gap-2 px-3 py-1.5 bg-background border border-border rounded-lg focus-within:border-accent/50 transition-all w-56">
              <Search className="w-3.5 h-3.5 text-muted" />
              <input 
                placeholder="Search logs..." 
                className="bg-transparent border-none outline-none text-xs font-medium w-full text-foreground placeholder:text-muted"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
              />
            </div>
            <button 
              onClick={() => setIsSidebarOpen(!isSidebarOpen)}
              className={`p-2.5 rounded-xl transition-all border ${isSidebarOpen ? 'bg-accent/10 text-accent border-accent/20' : 'hover:bg-background text-muted hover:text-foreground border-transparent hover:border-border'}`}
            >
              <Users className="w-4 h-4" />
            </button>
          </div>
        </header>

        {/* MESSAGES AREA */}
        <div className="flex-1 overflow-y-auto px-6 py-6 space-y-1 flex flex-col-reverse custom-scrollbar scroll-smooth bg-background/30">
          <div ref={scrollRef} /> 
          
          {filteredMessages?.map((msg, idx) => {
            const isMe = msg.user?.clerkId === clerkUser?.id;
            const prevMsg = filteredMessages[idx + 1];
            const isContinuation = prevMsg && prevMsg.user?.clerkId === msg.user?.clerkId;
            
            // Find member details for designation
            const memberDetail = members?.find(m => m.userId === msg.authorId);

            return (
              <div 
                key={msg._id} 
                className={`flex gap-3 group ${isMe ? "flex-row-reverse" : "flex-row"} ${isContinuation ? "mt-[2px]" : "mt-4"}`}
              >
                {!isContinuation ? (
                  <div className="w-8 h-8 rounded-lg bg-foreground/5 border border-border flex items-center justify-center shrink-0 overflow-hidden shadow-sm self-end mb-1">
                    {msg.user?.image ? (
                      <img src={msg.user.image} alt={msg.user.name} className="w-full h-full object-cover" />
                    ) : (
                      <span className="font-bold text-[10px] text-muted">{msg.user?.name?.[0]}</span>
                    )}
                  </div>
                ) : (
                  <div className="w-8 shrink-0" /> 
                )}

                <div className={`flex flex-col max-w-[75%] ${isMe ? "items-end" : "items-start"}`}>
                  {!isContinuation && !isMe && (
                    <div className="flex items-center gap-2 mb-1 px-1">
                      <span className="text-[11px] font-bold text-foreground">{msg.user?.name}</span>
                      {memberDetail?.designation && (
                        <span className="text-[9px] px-1.5 py-0 rounded bg-foreground/5 text-muted font-bold uppercase tracking-wider border border-border">
                          {memberDetail.designation}
                        </span>
                      )}
                      <span className="text-[9px] text-muted opacity-50 font-medium">
                        {new Date(msg._creationTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                      </span>
                    </div>
                  )}
                  
                  <div className={`
                    px-4 py-2 text-sm font-medium leading-relaxed shadow-sm backdrop-blur-md border relative
                    ${isMe 
                      ? "bg-accent text-white border-accent/50 rounded-2xl rounded-tr-sm" 
                      : "bg-white dark:bg-white/5 text-foreground border-border rounded-2xl rounded-tl-sm"
                    }
                  `}>
                    {/* Render Attachment if exists */}
                    {msg.attachmentUrl && (
                      <div className="mb-2 rounded-lg overflow-hidden border border-black/10 dark:border-white/10">
                        {msg.attachmentUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i) ? (
                          <img src={msg.attachmentUrl} alt="attachment" className="max-w-full h-auto max-h-60 object-cover" />
                        ) : (
                          <div className="p-3 bg-black/5 dark:bg-white/5 flex items-center gap-2">
                            <File className="w-4 h-4" />
                            <a href={msg.attachmentUrl} target="_blank" rel="noreferrer" className="text-xs underline truncate max-w-[150px]">
                              Download File
                            </a>
                          </div>
                        )}
                      </div>
                    )}
                    {msg.content}
                  </div>
                </div>
              </div>
            );
          })}
          
          <div className="text-center py-8 opacity-30">
            <p className="text-[10px] font-bold text-muted uppercase tracking-widest">End of History</p>
          </div>
        </div>

        {/* INPUT AREA */}
        <div className="p-4 bg-background/80 backdrop-blur-xl border-t border-border">
          <form 
            onSubmit={(e) => handleSend(e)} 
            className="glass-panel p-2 rounded-[26px] border border-border bg-background flex items-end gap-2 shadow-sm focus-within:border-accent/30 transition-all relative"
          >
            {/* Hidden File Input */}
            <input 
              type="file" 
              ref={fileInputRef} 
              className="hidden" 
              onChange={handleFileUpload} 
            />

            <button 
              type="button" 
              onClick={() => fileInputRef.current?.click()}
              disabled={isUploading}
              className="h-10 w-10 flex-shrink-0 flex items-center justify-center rounded-full hover:bg-foreground/5 text-muted hover:text-foreground transition-colors disabled:opacity-50 mb-1"
            >
              {isUploading ? <Loader2 className="w-5 h-5 animate-spin text-accent" /> : <Paperclip className="w-5 h-5" />}
            </button>
            
            <textarea 
              placeholder="Transmit message..." 
              className="flex-1 bg-transparent border-none outline-none py-3 max-h-32 min-h-[48px] resize-none text-sm font-medium text-foreground placeholder:text-muted/70 custom-scrollbar leading-relaxed"
              value={message}
              onChange={(e) => setMessage(e.target.value)}
              onKeyDown={(e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                  e.preventDefault();
                  handleSend();
                }
              }}
            />
            
            <button type="button" className="h-10 w-10 flex-shrink-0 flex items-center justify-center rounded-full hover:bg-foreground/5 text-muted hover:text-foreground transition-colors mb-1">
              <Smile className="w-5 h-5" />
            </button>
            
            <button 
              type="submit" 
              disabled={!message.trim() && !isUploading}
              className="h-10 w-10 flex-shrink-0 flex items-center justify-center bg-accent hover:bg-accent/90 disabled:bg-muted disabled:cursor-not-allowed rounded-full text-white transition-all shadow-md shadow-accent/20 group mb-1"
            >
              <Send className="w-4 h-4 group-hover:translate-x-0.5 group-hover:-translate-y-0.5 transition-transform" />
            </button>
          </form>
        </div>
      </div>

      {/* MEMBER SIDEBAR */}
      {isSidebarOpen && (
        <aside className="w-72 glass-panel rounded-[32px] border border-border shadow-sm bg-background/50 backdrop-blur-3xl flex flex-col overflow-hidden animate-in slide-in-from-right-4 duration-500">
          <div className="p-5 border-b border-border bg-background/40">
            <h3 className="font-bold text-foreground text-xs uppercase tracking-wider flex items-center gap-2">
              <Users className="w-3.5 h-3.5 text-accent" /> Active Personnel
            </h3>
          </div>
          
          <div className="flex-1 overflow-y-auto p-3 space-y-1 custom-scrollbar">
            {members?.map((member) => (
              <div key={member._id} className="group flex items-center gap-3 p-2.5 rounded-xl hover:bg-foreground/5 transition-all border border-transparent hover:border-border cursor-pointer">
                <div className="relative">
                  <div className="w-8 h-8 rounded-lg bg-foreground/5 flex items-center justify-center font-bold text-xs text-muted border border-border">
                    {member.user?.name.substring(0, 1)}
                  </div>
                  <div className="absolute -bottom-0.5 -right-0.5 p-0.5 bg-background rounded-full">
                    <Circle className={`w-2 h-2 fill-current ${member.role === 'admin' ? 'text-green-500' : 'text-orange-500'}`} />
                  </div>
                </div>
                
                <div className="flex-1 min-w-0">
                  <div className="flex items-center justify-between">
                    <p className="text-xs font-bold text-foreground truncate">{member.user?.name}</p>
                    {member.role === 'admin' && <ShieldCheck className="w-3 h-3 text-accent" />}
                  </div>
                  <p className="text-[9px] text-muted font-bold uppercase tracking-wider truncate opacity-70 group-hover:opacity-100 transition-opacity">
                    {member.roleName || member.designation || member.role}
                  </p>
                </div>
              </div>
            ))}
          </div>
          
          <div className="p-4 border-t border-border bg-foreground/[0.02]">
            <button className="w-full py-2.5 rounded-xl border border-dashed border-border text-[10px] font-bold text-muted uppercase tracking-wider hover:border-accent hover:text-accent transition-all">
              Invite Personnel
            </button>
          </div>
        </aside>
      )}
    </div>
  );
}
</file>

<file path="src/app/dashboard/[companyId]/page.tsx">
"use client";

import { useEffect } from "react";
import { useQuery } from "convex/react";
import { api } from "../../../../convex/_generated/api"; // Corrected path (4 levels up)
import { useParams, useRouter } from "next/navigation";
import { Loader2 } from "lucide-react";

export default function DashboardIndex() {
  const params = useParams();
  const router = useRouter();
  const companyId = params.companyId as any;

  // Fetch workspaces to determine where to redirect
  const workspaces = useQuery(api.workspaces.getByCompany, { companyId });

  useEffect(() => {
    if (workspaces) {
      // Prioritize the default "General" workspace, otherwise take the first one found
      const targetWs = workspaces.find((w) => w.isDefault) || workspaces[0];
      
      if (targetWs) {
        router.replace(`/dashboard/${companyId}/ws/${targetWs._id}`);
      }
    }
  }, [workspaces, companyId, router]);

  return (
    <div className="h-[80vh] flex flex-col items-center justify-center gap-4">
      <Loader2 className="w-10 h-10 text-blue-500 animate-spin" />
      <p className="text-sm text-muted-foreground font-medium animate-pulse">
        Initializing Workspace Environment...
      </p>
    </div>
  );
}
</file>

<file path="src/app/icon.tsx">
import { ImageResponse } from "next/og";

// Route segment config
export const runtime = "edge";

// Image metadata
export const size = {
  width: 32,
  height: 32,
};
export const contentType = "image/png";

// Image generation
export default function Icon() {
  return new ImageResponse(
    (
      <div
        style={{
          fontSize: 18,
          background: "#0071e3", // Axovanth Accent Blue
          width: "100%",
          height: "100%",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          color: "white",
          borderRadius: "8px", // Rounded corners (Squircle-ish)
          fontWeight: 900,
          fontFamily: 'sans-serif',
          letterSpacing: "-1px",
        }}
      >
        AX
      </div>
    ),
    { ...size }
  );
}
</file>

<file path="src/middleware.ts">
import { clerkMiddleware, createRouteMatcher } from "@clerk/nextjs/server";

const isPublicRoute = createRouteMatcher(["/", "/signin(.*)", "/signup(.*)"]);

export default clerkMiddleware(async (auth, request) => {
  if (!isPublicRoute(request)) {
    await auth.protect();
  }
});

export const config = {
  matcher: [
    // Skip Next.js internals and all static files
    '/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',
    // Always run for API routes
    '/(api|trpc)(.*)',
  ],
};
</file>

<file path="tailwind.config.ts">
import type { Config } from "tailwindcss";

const config: Config = {
  darkMode: ["class"],
  content: [
    "./src/pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/components/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/app/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      fontFamily: {
        sans: ["var(--font-inter)", "sans-serif"],
      },
      colors: {
        background: "var(--background)",
        foreground: "var(--foreground)",
        border: "var(--border)",
        accent: "var(--accent)",
        muted: {
          DEFAULT: "var(--muted)",
          foreground: "var(--foreground)",
        },
      },
    },
  },
  plugins: [require("tailwindcss-animate")],
};
export default config;
</file>

<file path="convex/chat.ts">
import { v } from "convex/values";
import { mutation, query } from "./_generated/server";

/**
 * Sends a message to organization-wide OR workspace-specific chat.
 */
export const send = mutation({
  args: {
    companyId: v.id("companies"),
    workspaceId: v.optional(v.id("workspaces")), // NEW
    content: v.string(),
    attachmentId: v.optional(v.id("_storage")),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized Access: No identity found");

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerkId", (q) => q.eq("clerkId", identity.subject))
      .unique();

    if (!user) throw new Error("User record not found in system");

    // If workspaceId is provided, verify membership? 
    // For now, we assume frontend checks, but backend check is safer.
    // Leaving permissive for speed, but ideally check workspaceMembers here.

    return await ctx.db.insert("messages", {
      companyId: args.companyId,
      workspaceId: args.workspaceId,
      authorId: user._id,
      content: args.content,
      attachmentId: args.attachmentId,
    });
  },
});

/**
 * Fetches the latest 50 messages.
 * If workspaceId provided, fetches for that workspace.
 * If not, fetches global company messages (where workspaceId is undefined).
 */
export const getMessages = query({
  args: { 
    companyId: v.id("companies"), 
    workspaceId: v.optional(v.id("workspaces")) 
  },
  handler: async (ctx, args) => {
    let messages;

    if (args.workspaceId) {
      // Fetch Workspace Specific Messages
      messages = await ctx.db
        .query("messages")
        .withIndex("by_workspace", (q) => q.eq("workspaceId", args.workspaceId!))
        .order("desc")
        .take(50);
    } else {
      // Fetch Global Messages (Filter out workspace messages manually or via index strategy)
      // Since we don't have a specific "global_only" index, we query by company and filter in memory
      // OR we can rely on `by_company` and filter.
      // Better approach: use `by_company` and filter where workspaceId is undefined.
      
      const allCompanyMessages = await ctx.db
        .query("messages")
        .withIndex("by_company", (q) => q.eq("companyId", args.companyId))
        .order("desc")
        .take(100); // Take more to account for filtering
        
      messages = allCompanyMessages.filter(m => !m.workspaceId).slice(0, 50);
    }

    // Map author profiles and resolve attachment URLs
    return await Promise.all(
      messages.map(async (msg) => {
        const user = await ctx.db.get(msg.authorId);
        let attachmentUrl = null;
        if (msg.attachmentId) {
          attachmentUrl = await ctx.storage.getUrl(msg.attachmentId);
        }
        return { ...msg, user, attachmentUrl };
      })
    );
  },
});
</file>

<file path="convex/schema.ts">
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  users: defineTable({
    name: v.string(),
    email: v.string(),
    image: v.optional(v.string()),
    clerkId: v.string(),
  }).index("by_clerkId", ["clerkId"]),

  companies: defineTable({
    name: v.string(),
    description: v.optional(v.string()),
    adminId: v.id("users"),
    logoUrl: v.optional(v.string()),
    domain: v.optional(v.string()),
  }),

  // Custom Roles defined by Admins
  roles: defineTable({
    companyId: v.id("companies"),
    name: v.string(),
    color: v.string(), // e.g., "blue", "red"
    description: v.optional(v.string()),
  }).index("by_company", ["companyId"]),

  companyMembers: defineTable({
    companyId: v.id("companies"),
    userId: v.id("users"),
    role: v.union(v.literal("admin"), v.literal("employee")), // System Role
    roleId: v.optional(v.id("roles")), // Link to Custom Role
    designation: v.optional(v.string()), // Legacy/Fallback
    status: v.union(v.literal("active"), v.literal("pending")),
  })
  .index("by_company_and_user", ["companyId", "userId"])
  .index("by_user", ["userId"]),

  // Requests for Custom Roles
  roleRequests: defineTable({
    companyId: v.id("companies"),
    userId: v.id("users"),
    roleId: v.id("roles"),
    status: v.union(v.literal("pending"), v.literal("approved"), v.literal("rejected")),
  }).index("by_company", ["companyId"]),

  workspaces: defineTable({
    companyId: v.id("companies"),
    name: v.string(),
    emoji: v.string(),
    workspaceHeadId: v.id("users"),
    isDefault: v.boolean(),
  }).index("by_company", ["companyId"]),

  workspaceMembers: defineTable({
    workspaceId: v.id("workspaces"),
    userId: v.id("users"),
    role: v.union(v.literal("admin"), v.literal("member")),
    designation: v.optional(v.string()),
  })
  .index("by_workspace_and_user", ["workspaceId", "userId"])
  .index("by_user", ["userId"])
  .index("by_workspace", ["workspaceId"]), // Added explicit index for deletion

  // Requests to join locked workspaces
  workspaceRequests: defineTable({
    workspaceId: v.id("workspaces"),
    userId: v.id("users"),
    status: v.union(v.literal("pending"), v.literal("approved"), v.literal("rejected")),
  }).index("by_workspace", ["workspaceId"]),

  tickets: defineTable({
    companyId: v.id("companies"),
    workspaceId: v.id("workspaces"),
    creatorId: v.id("users"),
    assigneeId: v.optional(v.id("users")),
    title: v.string(),
    description: v.string(),
    status: v.union(v.literal("open"), v.literal("resolved"), v.literal("transferred")),
    priority: v.union(v.literal("low"), v.literal("medium"), v.literal("high")),
    type: v.optional(v.union(v.literal("bug"), v.literal("feature"), v.literal("task"))),
    dueDate: v.optional(v.number()),
  }).index("by_company", ["companyId"]).index("by_workspace", ["workspaceId"]),

  ticketEvents: defineTable({
    ticketId: v.id("tickets"),
    actorId: v.id("users"),
    type: v.string(),
    metadata: v.optional(v.string()),
  }).index("by_ticket", ["ticketId"]),

  ticketComments: defineTable({
    ticketId: v.id("tickets"),
    authorId: v.id("users"),
    content: v.string(),
  }).index("by_ticket", ["ticketId"]),

  assets: defineTable({
    workspaceId: v.id("workspaces"),
    storageId: v.string(),
    fileName: v.string(),
    fileType: v.string(),
    uploaderId: v.id("users"),
  }).index("by_workspace", ["workspaceId"]),

  messages: defineTable({
    companyId: v.id("companies"),
    workspaceId: v.optional(v.id("workspaces")), // Updated to support Workspace Chat
    authorId: v.id("users"),
    content: v.string(),
    attachmentId: v.optional(v.id("_storage")),
  })
  .index("by_company", ["companyId"])
  .index("by_workspace", ["workspaceId"]), // New Index for fast workspace lookups
});
</file>

<file path="postcss.config.mjs">
/** @type {import('postcss-load-config').Config} */
const config = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};

export default config;
</file>

<file path="src/app/dashboard/[companyId]/settings/page.tsx">
"use client";

import { useState } from "react";
import { useQuery, useMutation } from "convex/react";
import { api } from "../../../../../convex/_generated/api";
import { useParams, useRouter } from "next/navigation";
import { Settings, Save, AlertTriangle, Trash2, User, Key, Edit2, X, Check, Loader2 } from "lucide-react";
import { useUser } from "@clerk/nextjs";
import { Id } from "../../../../../convex/_generated/dataModel";

export default function SystemConfig() {
  const params = useParams();
  const router = useRouter();
  const companyId = params.companyId as any;
  const { user: clerkUser } = useUser();
  
  // Data
  const company = useQuery(api.companies.getById, { id: companyId });
  const currentUser = useQuery(api.users.currentUser);
  const members = useQuery(api.companies.getMembers, { companyId });
  const roles = useQuery(api.roles.getRoles, { companyId });
  const myRequests = useQuery(api.roles.getRequests, { companyId }); // Fetch my requests to show status
  
  // Mutations
  const updateDetails = useMutation(api.companies.updateDetails);
  const deleteCompany = useMutation(api.companies.deleteCompany);
  const requestRole = useMutation(api.roles.requestRole);
  const updateUserName = useMutation(api.users.updateName);
  
  // State
  const [activeTab, setActiveTab] = useState<'profile' | 'system'>('profile');
  const [name, setName] = useState(company?.name || "");
  const [desc, setDesc] = useState(company?.description || "");
  const [logo, setLogo] = useState(company?.logoUrl || "");
  const [transferId, setTransferId] = useState("");
  
  // Profile Edit State
  const [isEditingProfile, setIsEditingProfile] = useState(false);
  const [newName, setNewName] = useState("");

  // Role Request Modal State
  const [roleRequestModal, setRoleRequestModal] = useState<{
    isOpen: boolean;
    roleId: Id<"roles"> | null;
    roleName: string;
  }>({ isOpen: false, roleId: null, roleName: "" });

  const handleUpdate = async () => {
    await updateDetails({ companyId, name, description: desc, logoUrl: logo });
    // Optional: Add a toast here instead of alert, but for now we remove the alert
  };

  const handleDelete = async () => {
    if (confirm("CRITICAL: This will destroy the entire organization. Are you sure?")) {
      await deleteCompany({ companyId });
      router.push("/");
    }
  };

  const openRoleRequestModal = (roleId: Id<"roles">, roleName: string) => {
    setRoleRequestModal({ isOpen: true, roleId, roleName });
  };

  const confirmRoleRequest = async () => {
    if (!roleRequestModal.roleId) return;
    try {
      await requestRole({ companyId, roleId: roleRequestModal.roleId });
      setRoleRequestModal({ isOpen: false, roleId: null, roleName: "" });
    } catch (e: any) {
      alert(e.message); // Fallback for actual errors
    }
  };

  const handleUpdateName = async () => {
    if (!newName.trim()) return;
    await updateUserName({ name: newName });
    setIsEditingProfile(false);
  };

  // Sync default form values
  if(company && name === "") { setName(company.name); setDesc(company.description || ""); setLogo(company.logoUrl || ""); }

  // Check if current user is admin
  const myRecord = members?.find(m => m.user?.clerkId === clerkUser?.id);
  const isAdmin = myRecord?.role === 'admin';

  // Helper to check if a request is pending for a specific role
  const isRequestPending = (roleId: string) => {
    // Assuming getRequests returns all requests, we filter for the current user in the UI or backend
    // Since api.roles.getRequests returns ALL requests for the company, we need to filter by current user ID
    // ideally the backend query should handle "myRequests", but we can filter client side if needed
    // However, looking at previous code, api.roles.getRequests returns *all pending* requests for admin.
    // For the user to see their own status, we might need a new query or check against the list if allowed.
    // For now, let's keep it simple: if they click request, we try. 
    return false; 
  };

  return (
    <div className="max-w-5xl space-y-12 pb-32 animate-in fade-in slide-in-from-bottom-6 duration-700 font-sans">
      
      {/* ---------------------------------------------------------------------- */}
      {/* ROLE REQUEST MODAL */}
      {/* ---------------------------------------------------------------------- */}
      {roleRequestModal.isOpen && (
        <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/60 backdrop-blur-md p-4 animate-in fade-in duration-200">
          <div className="glass-panel max-w-sm w-full p-8 rounded-[32px] shadow-2xl border-border bg-background relative animate-in zoom-in-95">
            <button 
              onClick={() => setRoleRequestModal({ ...roleRequestModal, isOpen: false })} 
              className="absolute top-4 right-4 p-2 bg-foreground/5 rounded-full hover:bg-foreground/10 transition-colors"
            >
              <X className="w-4 h-4 text-foreground" />
            </button>
            
            <div className="w-12 h-12 bg-accent/10 text-accent rounded-2xl flex items-center justify-center mb-6 mx-auto border border-accent/20">
              <Key className="w-6 h-6" />
            </div>
            
            <div className="text-center mb-8">
              <h3 className="text-xl font-bold mb-2 text-foreground tracking-tight">Request Assignment</h3>
              <p className="text-muted text-sm leading-relaxed px-2 font-normal">
                Submit a request to be assigned the <span className="font-bold text-foreground">{roleRequestModal.roleName}</span> role?
              </p>
            </div>
            
            <button 
              onClick={confirmRoleRequest} 
              className="apple-button w-full justify-center shadow-lg shadow-accent/20 mb-3"
            >
              Confirm Request
            </button>
            
            <button 
              onClick={() => setRoleRequestModal({ ...roleRequestModal, isOpen: false })} 
              className="w-full py-3 rounded-xl bg-foreground/5 font-semibold text-xs uppercase tracking-wider border border-border hover:bg-foreground/10 transition-colors"
            >
              Cancel
            </button>
          </div>
        </div>
      )}

      {/* HEADER */}
      <header className="flex flex-col md:flex-row md:items-end justify-between border-b border-border pb-8 gap-6">
        <div className="space-y-2">
          <div className="flex items-center gap-2 text-accent font-bold text-[10px] uppercase tracking-wider mb-2">
             <div className="w-2 h-2 rounded-full bg-accent animate-pulse" /> Preferences
          </div>
          <h1 className="text-4xl font-semibold tracking-tight text-foreground">Settings</h1>
          <p className="text-muted text-lg font-normal">Manage your identity and workspace configuration.</p>
        </div>
        
        {/* TAB SWITCHER */}
        <div className="flex gap-2 bg-foreground/5 p-1 rounded-xl">
          <button 
            onClick={() => setActiveTab('profile')} 
            className={`px-6 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${
              activeTab === 'profile' 
                ? 'bg-background shadow-sm text-foreground ring-1 ring-border' 
                : 'text-muted hover:text-foreground'
            }`}
          >
            My Profile
          </button>
          
          {isAdmin && (
            <button 
              onClick={() => setActiveTab('system')} 
              className={`px-6 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${
                activeTab === 'system' 
                  ? 'bg-background shadow-sm text-foreground ring-1 ring-border' 
                  : 'text-muted hover:text-foreground'
              }`}
            >
              System
            </button>
          )}
        </div>
      </header>

      {/* EDIT NAME MODAL */}
      {isEditingProfile && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
          <div className="glass-panel max-w-sm w-full p-8 rounded-[32px] shadow-2xl border-border bg-background relative animate-in zoom-in-95">
            <button onClick={() => setIsEditingProfile(false)} className="absolute top-4 right-4 p-2 bg-foreground/5 rounded-full hover:bg-foreground/10 transition-colors">
              <X className="w-4 h-4 text-foreground" />
            </button>
            
            <h3 className="text-xl font-bold mb-6 text-foreground">Update Identity</h3>
            
            <div className="space-y-4">
              <div>
                <label className="text-xs font-bold text-muted uppercase tracking-wider ml-1">Display Name</label>
                <input 
                  className="input-field mt-1" 
                  value={newName} 
                  onChange={(e) => setNewName(e.target.value)} 
                  placeholder={currentUser?.name}
                  autoFocus
                />
              </div>
              <button 
                onClick={handleUpdateName} 
                className="apple-button w-full justify-center shadow-lg shadow-accent/20"
              >
                Save Changes
              </button>
            </div>
          </div>
        </div>
      )}

      {activeTab === 'profile' && (
        <section className="glass-panel p-8 rounded-[32px] border-border bg-background space-y-8 animate-in fade-in duration-500">
          <div>
            <h2 className="text-lg font-bold text-foreground">My Access & Roles</h2>
            <p className="text-sm text-muted mt-1">View your current standing and request new privileges.</p>
          </div>

          <div className="p-6 bg-foreground/5 rounded-2xl border border-border flex items-center gap-6 relative group">
            <div className="w-16 h-16 rounded-full bg-background border border-border flex items-center justify-center text-2xl font-bold overflow-hidden">
              {currentUser?.image ? (
                <img src={currentUser.image} alt="Profile" className="w-full h-full object-cover" />
              ) : (
                currentUser?.name?.[0]
              )}
            </div>
            <div>
              <div className="flex items-center gap-3">
                <h3 className="font-bold text-lg text-foreground">{currentUser?.name}</h3>
                <button 
                  onClick={() => { setNewName(currentUser?.name || ""); setIsEditingProfile(true); }}
                  className="p-1.5 bg-background rounded-lg text-muted hover:text-accent transition-all opacity-0 group-hover:opacity-100 shadow-sm border border-border cursor-pointer"
                >
                  <Edit2 className="w-3.5 h-3.5" />
                </button>
              </div>
              <div className="flex gap-2 mt-2">
                <span className="px-3 py-1 bg-accent/10 text-accent rounded-full text-xs font-bold uppercase">{myRecord?.role}</span>
                {myRecord?.roleName && <span className="px-3 py-1 bg-foreground/10 text-foreground rounded-full text-xs font-bold uppercase">{myRecord.roleName}</span>}
              </div>
            </div>
          </div>

          <div className="space-y-4">
            <h3 className="text-sm font-bold text-muted uppercase tracking-wider">Available Roles</h3>
            <div className="grid md:grid-cols-2 gap-4">
              {roles?.map(r => (
                <div key={r._id} className="p-4 rounded-xl border border-border hover:border-accent/50 transition-all flex justify-between items-center bg-background/50">
                  <div>
                    <p className="font-bold text-sm text-foreground">{r.name}</p>
                    <p className="text-xs text-muted mt-1">{r.description}</p>
                  </div>
                  {myRecord?.roleId === r._id ? (
                    <span className="text-xs font-bold text-green-500 bg-green-500/10 px-3 py-1 rounded-lg uppercase tracking-wider">Active</span>
                  ) : (
                    <button 
                      onClick={() => openRoleRequestModal(r._id, r.name)} 
                      className="px-4 py-2 bg-foreground text-background text-xs font-bold rounded-lg uppercase hover:opacity-90 shadow-sm transition-opacity"
                    >
                      Request
                    </button>
                  )}
                </div>
              ))}
              {roles?.length === 0 && (
                <div className="col-span-2 text-center py-8 text-muted text-sm italic">
                  No custom roles defined by administrators yet.
                </div>
              )}
            </div>
          </div>
        </section>
      )}

      {activeTab === 'system' && isAdmin && (
        <div className="animate-in fade-in duration-500 space-y-8">
          {/* BRANDING SECTION */}
          <section className="glass-panel p-8 rounded-[32px] border-border bg-background space-y-6">
            <h2 className="text-lg font-bold text-foreground">Organization Identity</h2>
            <div className="grid md:grid-cols-2 gap-6">
              <div className="space-y-2">
                <label className="text-xs font-bold text-muted uppercase">Company Name</label>
                <input className="input-field" value={name} onChange={(e) => setName(e.target.value)} />
              </div>
              <div className="space-y-2">
                <label className="text-xs font-bold text-muted uppercase">Logo URL</label>
                <input className="input-field" value={logo} onChange={(e) => setLogo(e.target.value)} />
              </div>
              <div className="md:col-span-2 space-y-2">
                <label className="text-xs font-bold text-muted uppercase">Description</label>
                <textarea className="input-field h-24" value={desc} onChange={(e) => setDesc(e.target.value)} />
              </div>
            </div>
            <div className="flex justify-end">
              <button onClick={handleUpdate} className="apple-button shadow-lg shadow-accent/20">
                <Save className="w-4 h-4" /> Save Changes
              </button>
            </div>
          </section>

          {/* DANGER ZONE */}
          <section className="glass-panel p-8 rounded-[32px] border-red-500/20 bg-red-500/[0.02] space-y-8">
            <div className="flex items-center gap-4 text-red-500">
              <AlertTriangle className="w-6 h-6" />
              <h2 className="text-lg font-bold">Danger Zone</h2>
            </div>
            
            <div className="grid md:grid-cols-2 gap-8">
              <div className="space-y-4">
                <h3 className="font-bold text-foreground text-sm">Transfer Ownership</h3>
                <p className="text-xs text-muted">Transfer root admin privileges to another user. This action is irreversible.</p>
                <div className="flex gap-2">
                  <select className="input-field text-xs" value={transferId} onChange={(e) => setTransferId(e.target.value)}>
                    <option value="">Select New Owner...</option>
                    {members?.map(m => <option key={m.userId} value={m.userId}>{m.user?.name}</option>)}
                  </select>
                  <button 
                    disabled={!transferId} 
                    className="px-6 py-2.5 bg-zinc-900 hover:bg-zinc-800 text-white dark:bg-white dark:text-black dark:hover:bg-zinc-200 font-bold text-xs rounded-xl uppercase disabled:opacity-50 transition-all shadow-sm"
                  >
                    Transfer
                  </button>
                </div>
              </div>

              <div className="space-y-4">
                <h3 className="font-bold text-red-500 text-sm">Dissolve Organization</h3>
                <p className="text-xs text-muted">Permanently delete all data, workspaces, and history. Cannot be undone.</p>
                <button onClick={handleDelete} className="w-full py-3 bg-red-600 hover:bg-red-700 text-white font-bold text-xs rounded-xl uppercase shadow-lg shadow-red-500/20 flex items-center justify-center gap-2">
                  <Trash2 className="w-4 h-4" /> Delete Organization
                </button>
              </div>
            </div>
          </section>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/providers/convex-provider.tsx">
"use client";

import { ReactNode } from "react";
import { ConvexReactClient } from "convex/react";
import { ConvexProviderWithClerk } from "convex/react-clerk";
import { ClerkProvider, useAuth } from "@clerk/nextjs";
import { ThemeProvider } from "next-themes";

const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

export const ConvexClientProvider = ({ children }: { children: ReactNode }) => {
  return (
    <ClerkProvider publishableKey={process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY!}>
      {/* FIX: Changed attribute from "data-theme" to "class" to match Tailwind */}
      <ThemeProvider attribute="class" defaultTheme="system" enableSystem>
        <ConvexProviderWithClerk client={convex} useAuth={useAuth}>
          {children}
        </ConvexProviderWithClerk>
      </ThemeProvider>
    </ClerkProvider>
  );
};
</file>

<file path="convex/workspaces.ts">
import { v } from "convex/values";
import { mutation, query } from "./_generated/server";

export const getByCompany = query({
  args: { companyId: v.id("companies") },
  handler: async (ctx, args) => {
    return await ctx.db
      .query("workspaces")
      .withIndex("by_company", (q) => q.eq("companyId", args.companyId))
      .collect();
  },
});

export const getMyMemberships = query({
  args: { companyId: v.id("companies") },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) return [];
    const user = await ctx.db.query("users").withIndex("by_clerkId", q => q.eq("clerkId", identity.subject)).unique();
    if (!user) return [];

    const memberships = await ctx.db.query("workspaceMembers").withIndex("by_user", q => q.eq("userId", user._id)).collect();
    const myWorkspaceIds = [];
    for (const m of memberships) {
      const ws = await ctx.db.get(m.workspaceId);
      if (ws && ws.companyId === args.companyId) {
        myWorkspaceIds.push(m.workspaceId);
      }
    }
    return myWorkspaceIds;
  }
});

export const requestAccess = mutation({
  args: { workspaceId: v.id("workspaces") },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");
    const user = await ctx.db.query("users").withIndex("by_clerkId", q => q.eq("clerkId", identity.subject)).unique();
    if (!user) throw new Error("User not found");

    const existing = await ctx.db.query("workspaceRequests")
      .withIndex("by_workspace", q => q.eq("workspaceId", args.workspaceId))
      .filter(q => q.eq(q.field("userId"), user._id))
      .first();
    
    if (existing) throw new Error("Request already pending or processed");

    await ctx.db.insert("workspaceRequests", {
      workspaceId: args.workspaceId,
      userId: user._id,
      status: "pending"
    });
  }
});

export const getRequests = query({
  args: { companyId: v.id("companies") },
  handler: async (ctx, args) => {
    const workspaces = await ctx.db.query("workspaces").withIndex("by_company", q => q.eq("companyId", args.companyId)).collect();
    const workspaceIds = workspaces.map(w => w._id);
    
    let allRequests = [];
    for (const wid of workspaceIds) {
      const reqs = await ctx.db.query("workspaceRequests").withIndex("by_workspace", q => q.eq("workspaceId", wid)).collect();
      const pending = reqs.filter(r => r.status === "pending");
      for (const r of pending) {
        const user = await ctx.db.get(r.userId);
        const ws = workspaces.find(w => w._id === r.workspaceId);
        allRequests.push({ ...r, user, workspaceName: ws?.name });
      }
    }
    return allRequests;
  }
});

export const resolveAccessRequest = mutation({
  args: { requestId: v.id("workspaceRequests"), approved: v.boolean() },
  handler: async (ctx, args) => {
    const req = await ctx.db.get(args.requestId);
    if (!req) throw new Error("Request not found");
    
    await ctx.db.patch(args.requestId, { status: args.approved ? "approved" : "rejected" });

    if (args.approved) {
      await ctx.db.insert("workspaceMembers", {
        workspaceId: req.workspaceId,
        userId: req.userId,
        role: "member"
      });
    }
  }
});

export const getMembers = query({
  args: { workspaceId: v.id("workspaces") },
  handler: async (ctx, args) => {
    const members = await ctx.db
      .query("workspaceMembers")
      .withIndex("by_workspace_and_user", (q) => q.eq("workspaceId", args.workspaceId))
      .collect();

    return await Promise.all(
      members.map(async (member) => {
        const user = await ctx.db.get(member.userId);
        return { ...member, user };
      })
    );
  },
});

export const getMyself = query({
  args: { workspaceId: v.id("workspaces") },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) return null;

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerkId", (q) => q.eq("clerkId", identity.subject))
      .unique();

    if (!user) return null;

    const workspace = await ctx.db.get(args.workspaceId);
    if (!workspace) return null;

    const wsMember = await ctx.db
      .query("workspaceMembers")
      .withIndex("by_workspace_and_user", (q) => q.eq("workspaceId", args.workspaceId).eq("userId", user._id))
      .unique();

    const companyMember = await ctx.db
      .query("companyMembers")
      .withIndex("by_company_and_user", (q) => q.eq("companyId", workspace.companyId).eq("userId", user._id))
      .unique();
    
    return {
      workspaceRole: wsMember?.role || null,
      companyRole: companyMember?.role || null,
      isOverallAdmin: companyMember?.role === "admin"
    };
  },
});

export const getMyAdminStats = query({
  args: { companyId: v.id("companies") },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) return { isOverallAdmin: false, adminWorkspaceIds: [] };

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerkId", (q) => q.eq("clerkId", identity.subject))
      .unique();

    if (!user) return { isOverallAdmin: false, adminWorkspaceIds: [] };

    const companyMember = await ctx.db
      .query("companyMembers")
      .withIndex("by_company_and_user", (q) => q.eq("companyId", args.companyId).eq("userId", user._id))
      .unique();

    const workspaceMemberships = await ctx.db
      .query("workspaceMembers")
      .withIndex("by_user", (q) => q.eq("userId", user._id))
      .collect();

    const adminWorkspaceIds = workspaceMemberships
      .filter(m => m.role === "admin")
      .map(m => m.workspaceId);

    return {
      isOverallAdmin: companyMember?.role === "admin",
      adminWorkspaceIds: adminWorkspaceIds,
      userId: user._id
    };
  },
});

export const create = mutation({
  args: {
    companyId: v.id("companies"),
    name: v.string(),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerkId", (q) => q.eq("clerkId", identity.subject))
      .unique();

    if (!user) throw new Error("User not found");

    const companyMember = await ctx.db
      .query("companyMembers")
      .withIndex("by_company_and_user", (q) => q.eq("companyId", args.companyId).eq("userId", user._id))
      .unique();

    if (companyMember?.role !== "admin") {
      throw new Error("Only Company Admins can provision new environments.");
    }

    const n = args.name.toLowerCase();
    let emoji = "Box"; 

    const map = [
      { keys: ["tech", "dev", "code", "stack", "engineer", "sys", "compute"], icon: "Terminal" },
      { keys: ["market", "growth", "seo", "ad", "brand", "content", "social"], icon: "TrendingUp" },
      { keys: ["sales", "rev", "money", "finance", "bill", "account", "tax"], icon: "BadgeDollarSign" },
      { keys: ["design", "art", "ui", "ux", "creative", "studio"], icon: "Palette" },
      { keys: ["legal", "law", "policy", "compliance", "audit"], icon: "Scale" },
      { keys: ["hr", "human", "people", "recruit", "talent", "culture"], icon: "Users" },
      { keys: ["ops", "operation", "logist", "supply", "admin"], icon: "Settings2" },
      { keys: ["support", "help", "customer", "service", "care"], icon: "LifeBuoy" },
      { keys: ["product", "roadmap", "feature", "spec"], icon: "Rocket" },
      { keys: ["data", "analytic", "science", "bi", "insight"], icon: "Database" },
      { keys: ["exec", "ceo", "board", "strategy"], icon: "Briefcase" },
      { keys: ["qa", "test", "quality", "bug"], icon: "Bug" },
      { keys: ["security", "sec", "cyber", "guard"], icon: "ShieldCheck" },
    ];

    for (const entry of map) {
      if (entry.keys.some(k => n.includes(k))) {
        emoji = entry.icon;
        break;
      }
    }

    const workspaceId = await ctx.db.insert("workspaces", {
      companyId: args.companyId,
      name: args.name,
      emoji: emoji, 
      workspaceHeadId: user._id,
      isDefault: false,
    });

    await ctx.db.insert("workspaceMembers", {
      workspaceId,
      userId: user._id,
      role: "admin",
    });

    return workspaceId;
  },
});

export const addMember = mutation({
  args: {
    workspaceId: v.id("workspaces"),
    userId: v.id("users"),
    role: v.union(v.literal("admin"), v.literal("member")),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");

    const existing = await ctx.db
      .query("workspaceMembers")
      .withIndex("by_workspace_and_user", (q) => q.eq("workspaceId", args.workspaceId).eq("userId", args.userId))
      .unique();

    if (existing) throw new Error("User is already a member of this workspace.");

    await ctx.db.insert("workspaceMembers", {
      workspaceId: args.workspaceId,
      userId: args.userId,
      role: args.role,
    });
  },
});

export const updateRole = mutation({
  args: {
    memberId: v.id("workspaceMembers"),
    role: v.union(v.literal("admin"), v.literal("member")),
  },
  handler: async (ctx, args) => {
    await ctx.db.patch(args.memberId, { role: args.role });
  },
});

export const updateDesignation = mutation({
  args: {
    memberId: v.id("workspaceMembers"),
    designation: v.string(),
  },
  handler: async (ctx, args) => {
     await ctx.db.patch(args.memberId, { designation: args.designation });
  },
});

export const removeMember = mutation({
  args: { memberId: v.id("workspaceMembers") },
  handler: async (ctx, args) => {
    await ctx.db.delete(args.memberId);
  },
});

export const deleteWorkspace = mutation({
  args: { workspaceId: v.id("workspaces") },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");

    const user = await ctx.db
      .query("users")
      .withIndex("by_clerkId", (q) => q.eq("clerkId", identity.subject))
      .unique();

    if (!user) throw new Error("User not found");

    const workspace = await ctx.db.get(args.workspaceId);
    if (!workspace) throw new Error("Workspace not found");

    const companyMember = await ctx.db
      .query("companyMembers")
      .withIndex("by_company_and_user", (q) => q.eq("companyId", workspace.companyId).eq("userId", user._id))
      .unique();

    if (companyMember?.role !== "admin") {
      throw new Error("Insufficient privileges to delete environment.");
    }

    // 1. Delete Workspace
    await ctx.db.delete(args.workspaceId);
    
    // 2. Cascade Delete Members
    const members = await ctx.db.query("workspaceMembers").withIndex("by_workspace", q => q.eq("workspaceId", args.workspaceId)).collect();
    for (const m of members) await ctx.db.delete(m._id);

    // 3. Cascade Delete Requests
    const requests = await ctx.db.query("workspaceRequests").withIndex("by_workspace", q => q.eq("workspaceId", args.workspaceId)).collect();
    for (const r of requests) await ctx.db.delete(r._id);

    // 4. Cascade Delete Tickets
    const tickets = await ctx.db.query("tickets").withIndex("by_workspace", q => q.eq("workspaceId", args.workspaceId)).collect();
    for (const t of tickets) await ctx.db.delete(t._id);

    // 5. Cascade Delete Messages (Chat)
    const messages = await ctx.db.query("messages").withIndex("by_workspace", q => q.eq("workspaceId", args.workspaceId)).collect();
    for (const m of messages) await ctx.db.delete(m._id);
  }
});
</file>

<file path="README.md">
# Axovanth | Enterprise Workspace Platform

<div align="center">

![Version](https://img.shields.io/badge/Version-2.4.0-blue?style=for-the-badge&logo=none)
![License](https://img.shields.io/badge/License-AGPL_v3-red?style=for-the-badge&logo=gnu)
![Status](https://img.shields.io/badge/System_Status-Operational-success?style=for-the-badge&logo=statuspage)

**The Neural Network for Modern Organizations.**<br>
Unified governance, granular access control, and seamless workflow automation.<br>
*Built for speed, security, and scale.*

[View Demo](https://axovanth-os.vercel.app) Â· [Report Bug](https://github.com/aadithya-vimal/axovanth/issues) Â· [Request Feature](https://github.com/aadithya-vimal/axovanth/issues)

</div>

---

## âš¡ Overview

**Axovanth** is a high-performance Enterprise Control Plane designed to replace disjointed SaaS tools with a single, real-time command center. It unifies **Identity Management (RBAC)**, **Project Workflow**, **Secure Asset Storage**, and **Encrypted Communication** into one interface.

Unlike traditional dashboards that require manual refreshes, Axovanth uses a **Real-Time Sync Protocol** (powered by Convex) to propagate state changes instantly across all active nodes in an organization.

---

## ðŸ›¡ï¸ Core Protocols (Features)

### 1. The Governance Kernel (RBAC)
A military-grade Identity Matrix for managing organizational hierarchy.
* **Identity Matrix:** High-density administrative console for managing thousands of users with zero latency.
* **Granular Privilege Control:** Define custom roles (e.g., `Super Admin`, `Workspace Lead`, `Auditor`) with specific logic scopes.
* **Terminal Actions:** Secure protocols for identity purging and role transitions, protected by confirmation guards.
* **Self-Revocation Guard:** Logic blocks preventing admins from accidentally locking themselves out.

### 2. Operational Flow Engine
A dynamic workflow system that treats tickets as "Living Assets."
* **Live Sync:** Updates to priority, status, or assignment reflect instantly for all users.
* **Audit Logging:** An immutable `Audit Log` records every action (transfer, resolve, reopen) for compliance.
* **Inter-Departmental Transfer:** Workspace Admins can securely transfer ticket ownership between isolated environments (e.g., *Engineering* â†’ *Legal*).

### 3. Global Communications Grid
* **Encrypted Chat:** Organization-wide broadcasting with real-time message streaming.
* **Signal Injection:** Context-aware commenting directly within workflow tickets.
* **Attachment Protocol:** Drag-and-drop file sharing securely stored in the Asset Vault.

### 4. Infrastructure (Workspaces)
* **Departmental Nodes:** Isolated environments with separate permission boundaries.
* **Asset Vault:** Centralized, secure storage for intellectual property using Convex Storage.
* **Instant Provisioning:** Admins can spin up new workspace nodes in seconds without server restarts.

---

## ðŸ› ï¸ Technology Stack

Axovanth is built on a **Bleeding Edge** stack designed for maximum performance.

| Component | Technology | Description |
| :--- | :--- | :--- |
| **Framework** | [Next.js 16](https://nextjs.org/) | The latest React framework with App Router and Turbopack. |
| **Backend** | [Convex](https://convex.dev/) | Real-time database function-as-a-service (FaaS). |
| **Identity** | [Clerk](https://clerk.com/) | Enterprise-grade user management and authentication. |
| **Styling** | [Tailwind CSS](https://tailwindcss.com/) | Utility-first CSS for high-density UI construction. |
| **Icons** | [Lucide React](https://lucide.dev/) | Consistent, lightweight vector iconography. |
| **Language** | [TypeScript](https://www.typescriptlang.org/) | Strict static typing for mission-critical logic. |

---

## ðŸš€ Initialization Protocol (Getting Started)

Follow these steps to deploy your local instance of Axovanth.

### Prerequisites
* Node.js 18+
* npm or yarn

### 1. Clone the Repository
```bash
git clone [https://github.com/aadithya-vimal/axovanth.git](https://github.com/aadithya-vimal/axovanth.git)
cd axovanth

```

### 2. Install Dependencies

```bash
npm install
# or
yarn install

```

### 3. Environment Configuration

Create a `.env.local` file in the root directory and populate it with your keys:

```env
# Deployment Public URL
CONVEX_DEPLOYMENT="dev:your-convex-deployment-name"
NEXT_PUBLIC_CONVEX_URL="[https://your-convex-instance.convex.cloud](https://your-convex-instance.convex.cloud)"

# Auth Configuration (Clerk)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY="pk_test_..."
CLERK_SECRET_KEY="sk_test_..."

```

### 4. Ignite the Kernel

You need to run two terminals simultaneously to sync the backend and frontend.

**Terminal A (Backend Sync):**

```bash
npx convex dev

```

**Terminal B (Frontend):**

```bash
npm run dev

```

Access the platform at `http://localhost:3000`.

---

## ðŸ“‚ Project Structure

```bash
axovanth/
â”œâ”€â”€ convex/               # The Backend Kernel (Database & Functions)
â”‚   â”œâ”€â”€ schema.ts         # Database Schema Definitions
â”‚   â”œâ”€â”€ tickets.ts        # Workflow Logic & Audit Logs
â”‚   â”œâ”€â”€ users.ts          # Identity Management
â”‚   â””â”€â”€ companies.ts      # Organization Logic
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/              # Next.js 16 App Router
â”‚   â”‚   â”œâ”€â”€ dashboard/    # Protected Application Interface
â”‚   â”‚   â”‚   â”œâ”€â”€ [companyId]/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ admin/    # Governance Console (RBAC)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ chat/     # Global Comms
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ws/       # Workspace Nodes
â”‚   â”‚   â””â”€â”€ onboarding/   # Organization Discovery Logic
â”‚   â””â”€â”€ components/       # Reusable UI Atoms
â””â”€â”€ public/               # Static Assets

```

---

## ðŸ“œ License: AGPL v3

This project is strictly licensed under the **GNU Affero General Public License v3.0 (AGPL-3.0)**.

**The "SaaS Loophole" is closed.**

* âœ… **You can** use this software for private or commercial purposes.
* âœ… **You can** modify the code.
* âš ï¸ **IF** you modify the code and provide it as a service (SaaS) to others over a network, you **MUST** release your modified source code to the community under the same license.
* âŒ **You cannot** close-source this project or its derivatives if you are distributing it or running it as a network service.

See the `LICENSE` file for the full legal text.

---

## ðŸ¤ Contribution

Transmissions (Pull Requests) are welcome. Please ensure all contributions adhere to the **High-Density Design System** and pass all security checks.

1. Fork the repository.
2. Create a feature branch (`git checkout -b feature/new-protocol`).
3. Commit your changes.
4. Push to the branch.
5. Open a Pull Request.

---

<div align="center">

**Engineered by Aadithya Vimal**




*System Status: Operational*

</div>

```

```
</file>

<file path="src/app/dashboard/[companyId]/admin/page.tsx">
"use client";

import { useQuery, useMutation } from "convex/react";
import { api } from "../../../../../convex/_generated/api";
import { useParams } from "next/navigation";
import { useState } from "react";
import { 
  ShieldCheck, UserCheck, UserMinus, Plus, 
  Settings2, Briefcase, LayoutGrid, Mail, Trash2,
  AlertTriangle, X, Loader2, Zap, Info, ChevronDown,
  ShieldAlert, UserCog, Building, Lock, Check,
  Activity, Globe, Fingerprint, Cpu, Database, Users, 
  ArrowRight, Edit2, Save, Layers, Inbox, UserPlus,
  // NEW ICONS
  Terminal, TrendingUp, BadgeDollarSign, Palette, Scale,
  LifeBuoy, Rocket, Bug, Box, FolderKanban
} from "lucide-react";
import { useUser } from "@clerk/nextjs";
import { Id } from "../../../../../convex/_generated/dataModel";

// Icon Registry (Must match Layout)
const WorkspaceIconMap: Record<string, any> = {
  Terminal, TrendingUp, BadgeDollarSign, Palette, Scale, Users, 
  Settings2, LifeBuoy, Rocket, Database, Briefcase, Bug, ShieldCheck, Box, FolderKanban
};

export default function AdminDashboard() {
  const params = useParams();
  const { user: clerkUser } = useUser();
  const companyId = params.companyId as any;

  // ----------------------------------------------------------------------
  // UI STATE MANAGEMENT
  // ----------------------------------------------------------------------
  const [activeTab, setActiveTab] = useState<'hierarchy' | 'workspaces' | 'roles' | 'requests'>('hierarchy');
  
  // Modal States
  const [memberToRemove, setMemberToRemove] = useState<any>(null);
  const [isCreateWorkspaceOpen, setIsCreateWorkspaceOpen] = useState(false);
  const [newWorkspaceName, setNewWorkspaceName] = useState("");
  const [workspaceToDelete, setWorkspaceToDelete] = useState<{ id: Id<"workspaces">, name: string } | null>(null);
  
  // Workspace Management State
  const [selectedWorkspaceId, setSelectedWorkspaceId] = useState<string | null>(null);
  
  // Custom Role Management State
  const [newRole, setNewRole] = useState({ name: "", color: "blue", description: "" });
  
  // Member Edit Modal State
  const [editMemberModal, setEditMemberModal] = useState<{
    isOpen: boolean;
    member: any;
  } | null>(null);
  const [tempDesignation, setTempDesignation] = useState("");
  const [tempRoleId, setTempRoleId] = useState("");
  const [tempSystemRole, setTempSystemRole] = useState("employee");
  
  // Request Decision Modal State
  const [decisionModal, setDecisionModal] = useState<{
    isOpen: boolean;
    type: 'role' | 'workspace';
    id: string; // requestId
    action: 'approve' | 'reject';
    userName: string;
    targetName: string; // Role name or Workspace name
  } | null>(null);
  
  // Dropdown UI State (for custom select inside modal)
  const [activeDropdown, setActiveDropdown] = useState<string | null>(null);

  // ----------------------------------------------------------------------
  // DATA FETCHING
  // ----------------------------------------------------------------------
  const members = useQuery(api.companies.getMembers, { companyId });
  const workspaces = useQuery(api.workspaces.getByCompany, { companyId });
  const roles = useQuery(api.roles.getRoles, { companyId });
  
  const roleRequests = useQuery(api.roles.getRequests, { companyId });
  const workspaceRequests = useQuery(api.workspaces.getRequests, { companyId });
  
  const workspaceMembers = useQuery(
    api.workspaces.getMembers, 
    selectedWorkspaceId ? { workspaceId: selectedWorkspaceId as any } : "skip"
  );

  // ----------------------------------------------------------------------
  // MUTATIONS
  // ----------------------------------------------------------------------
  const updateStatus = useMutation(api.companies.updateMemberStatus);
  const updateMemberProfile = useMutation(api.companies.updateMemberProfile);
  const removeMember = useMutation(api.companies.removeMember);
  
  const createWorkspace = useMutation(api.workspaces.create);
  const deleteWorkspace = useMutation(api.workspaces.deleteWorkspace);
  const addWorkspaceMember = useMutation(api.workspaces.addMember);
  const updateWorkspaceRole = useMutation(api.workspaces.updateRole);
  const removeWorkspaceMember = useMutation(api.workspaces.removeMember);
  const resolveWsRequest = useMutation(api.workspaces.resolveAccessRequest);

  const createRole = useMutation(api.roles.createRole);
  const deleteRole = useMutation(api.roles.deleteRole);
  const resolveRoleRequest = useMutation(api.roles.resolveRequest);

  // ----------------------------------------------------------------------
  // ACTION HANDLERS
  // ----------------------------------------------------------------------

  const confirmRemoval = async () => {
    if (memberToRemove) {
      if (memberToRemove.user?.clerkId === clerkUser?.id) {
        alert("Security Violation: Super-Admin cannot self-terminate.");
        setMemberToRemove(null);
        return;
      }
      try {
        await removeMember({ memberId: memberToRemove._id });
        setMemberToRemove(null);
      } catch (e: any) {
        alert(e.message);
      }
    }
  };

  const handleCreateWorkspace = async () => {
    if (!newWorkspaceName.trim()) return;
    try {
      await createWorkspace({ companyId, name: newWorkspaceName });
      setIsCreateWorkspaceOpen(false);
      setNewWorkspaceName("");
    } catch (e: any) {
      alert("Provisioning Failed: " + e.message);
    }
  };

  const handleDeleteWorkspace = async () => {
    if (!workspaceToDelete) return;
    try {
        await deleteWorkspace({ workspaceId: workspaceToDelete.id });
        setWorkspaceToDelete(null);
        if (selectedWorkspaceId === workspaceToDelete.id) setSelectedWorkspaceId(null);
    } catch (e: any) {
        alert("Deletion Failed: " + e.message);
    }
  }

  const openEditModal = (member: any) => {
    setTempDesignation(member.designation || "");
    setTempRoleId(member.roleId || "");
    setTempSystemRole(member.role || "employee");
    setEditMemberModal({ isOpen: true, member });
    setActiveDropdown(null);
  };

  const saveMemberProfile = async () => {
    if (!editMemberModal) return;
    try {
      await updateMemberProfile({
        memberId: editMemberModal.member._id,
        designation: tempDesignation,
        roleId: tempRoleId === "" ? undefined : (tempRoleId as any),
        role: tempSystemRole as "admin" | "employee"
      });
      setEditMemberModal(null);
    } catch (e: any) {
      alert("Update failed: " + e.message);
    }
  };

  const handleAddToWorkspace = async (userId: any, role: "admin" | "member") => {
    if (!selectedWorkspaceId) return;
    try {
      await addWorkspaceMember({ workspaceId: selectedWorkspaceId as any, userId, role });
    } catch (e: any) {
      alert(e.message);
    }
  };

  const handleCreateRole = async () => {
    if(!newRole.name) return;
    try {
      await createRole({ companyId, ...newRole });
      setNewRole({ name: "", color: "blue", description: "" });
    } catch (e: any) {
      alert(e.message);
    }
  }

  // --- NEW: Decision Handling ---
  const initiateDecision = (
    type: 'role' | 'workspace', 
    id: string, 
    action: 'approve' | 'reject', 
    userName: string, 
    targetName: string
  ) => {
    setDecisionModal({ isOpen: true, type, id, action, userName, targetName });
  };

  const confirmDecision = async () => {
    if (!decisionModal) return;
    
    try {
      const isApproved = decisionModal.action === 'approve';
      
      if (decisionModal.type === 'role') {
        await resolveRoleRequest({ requestId: decisionModal.id as Id<"roleRequests">, approved: isApproved });
      } else {
        await resolveWsRequest({ requestId: decisionModal.id as Id<"workspaceRequests">, approved: isApproved });
      }
      setDecisionModal(null);
    } catch (e: any) {
      alert("Processing failed: " + e.message);
    }
  };

  if (!members || !workspaces || !roles || !roleRequests || !workspaceRequests) return (
    <div className="flex items-center justify-center h-[70vh]">
      <Loader2 className="w-8 h-8 text-accent animate-spin" />
    </div>
  );

  const pendingMembers = members.filter(m => m.status === "pending");
  const activeMembers = members.filter(m => m.status === "active");
  const pendingRequestCount = roleRequests.length + workspaceRequests.filter(r => r.status === 'pending').length + pendingMembers.length;

  // ----------------------------------------------------------------------
  // CUSTOM DROPDOWN COMPONENT (Internal)
  // ----------------------------------------------------------------------
  const CustomDropdown = ({ label, value, options, onChange, id, disabled = false }: any) => {
    const isOpen = activeDropdown === id;
    const selectedLabel = options.find((o: any) => o.value === value)?.label || "Select...";

    return (
      <div className="relative">
        <label className="text-[10px] font-bold text-muted uppercase tracking-wider ml-1 mb-1 block">{label}</label>
        <button 
          onClick={() => !disabled && setActiveDropdown(isOpen ? null : id)}
          className={`w-full text-left px-3 py-2.5 rounded-xl border bg-background flex items-center justify-between transition-all ${
            isOpen ? 'border-accent ring-2 ring-accent/10' : 'border-border hover:border-accent/50'
          } ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
        >
          <span className="text-sm font-medium text-foreground">{selectedLabel}</span>
          <ChevronDown className={`w-4 h-4 text-muted transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && !disabled && (
          <div className="absolute top-full left-0 right-0 mt-2 p-1 bg-background border border-border rounded-xl shadow-xl z-50 max-h-48 overflow-y-auto custom-scrollbar animate-in fade-in slide-in-from-top-2">
            {options.map((opt: any) => (
              <button
                key={opt.value}
                onClick={() => {
                  onChange(opt.value);
                  setActiveDropdown(null);
                }}
                className={`w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-between group ${
                  value === opt.value ? 'bg-accent/10 text-accent' : 'hover:bg-foreground/5 text-foreground'
                }`}
              >
                {opt.label}
                {value === opt.value && <Check className="w-3.5 h-3.5" />}
              </button>
            ))}
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="max-w-7xl mx-auto space-y-12 pb-32 animate-in fade-in slide-in-from-bottom-4 duration-700 font-sans" onClick={() => { /* Close dropdowns if clicking background? Optional polish */ }}>
      
      {/* ---------------------------------------------------------------------- */}
      {/* WORKSPACE DELETE MODAL */}
      {/* ---------------------------------------------------------------------- */}
      {workspaceToDelete && (
        <div className="fixed inset-0 z-[400] flex items-center justify-center bg-black/60 backdrop-blur-md p-4">
          <div className="glass-panel max-w-sm w-full p-8 rounded-[32px] shadow-2xl border-red-500/20 bg-background animate-in zoom-in duration-200">
            <div className="w-16 h-16 bg-red-500/10 rounded-2xl flex items-center justify-center mb-6 mx-auto border border-red-500/20">
              <Trash2 className="text-red-600 w-8 h-8" />
            </div>
            <div className="text-center mb-8">
              <h3 className="text-xl font-bold mb-2 text-foreground tracking-tight">Destroy Environment?</h3>
              <p className="text-muted text-sm leading-relaxed px-2 font-normal">
                Permamently delete <span className="font-bold text-foreground">{workspaceToDelete.name}</span> and all its data? This cannot be undone.
              </p>
            </div>
            <div className="flex gap-3">
              <button 
                onClick={() => setWorkspaceToDelete(null)} 
                className="flex-1 py-3 rounded-xl bg-foreground/5 font-semibold text-xs uppercase tracking-wider border border-border cursor-pointer hover:bg-foreground/10"
              >
                Abort
              </button>
              <button 
                onClick={handleDeleteWorkspace} 
                className="flex-1 py-3 rounded-xl bg-red-600 text-white font-semibold text-xs uppercase tracking-wider shadow-lg shadow-red-600/20 cursor-pointer hover:bg-red-700"
              >
                Destroy
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ---------------------------------------------------------------------- */}
      {/* DECISION CONFIRMATION MODAL */}
      {/* ---------------------------------------------------------------------- */}
      {decisionModal && (
        <div className="fixed inset-0 z-[400] flex items-center justify-center bg-black/60 backdrop-blur-md p-4">
          <div className="glass-panel max-w-sm w-full p-8 rounded-[32px] shadow-2xl border-border bg-background animate-in zoom-in duration-200">
            <div className={`w-16 h-16 rounded-2xl flex items-center justify-center mb-6 mx-auto border ${decisionModal.action === 'approve' ? 'bg-green-500/10 border-green-500/20 text-green-600' : 'bg-red-500/10 border-red-500/20 text-red-600'}`}>
              {decisionModal.action === 'approve' ? <Check className="w-8 h-8" /> : <X className="w-8 h-8" />}
            </div>
            
            <div className="text-center mb-8">
              <h3 className="text-xl font-bold mb-2 text-foreground tracking-tight">Confirm Decision</h3>
              <p className="text-muted text-sm leading-relaxed px-2 font-normal">
                Are you sure you want to <strong>{decisionModal.action.toUpperCase()}</strong> the request for <span className="font-bold text-foreground">{decisionModal.userName}</span> to access <span className="text-accent">{decisionModal.targetName}</span>?
              </p>
            </div>
            
            <div className="flex gap-3">
              <button 
                onClick={() => setDecisionModal(null)} 
                className="flex-1 py-3 rounded-xl bg-foreground/5 font-semibold text-xs uppercase tracking-wider border border-border cursor-pointer hover:bg-foreground/10"
              >
                Cancel
              </button>
              <button 
                onClick={confirmDecision} 
                className={`flex-1 py-3 rounded-xl text-white font-semibold text-xs uppercase tracking-wider shadow-lg cursor-pointer ${
                  decisionModal.action === 'approve' 
                    ? 'bg-green-600 hover:bg-green-700 shadow-green-500/20' 
                    : 'bg-red-600 hover:bg-red-700 shadow-red-500/20'
                }`}
              >
                Confirm
              </button>
            </div>
          </div>
        </div>
      )}

      {/* EDIT MEMBER MODAL (Styled Dropdowns) */}
      {editMemberModal && (
        <div className="fixed inset-0 z-[300] flex items-center justify-center bg-black/40 backdrop-blur-md p-4">
          <div className="glass-panel max-w-sm w-full p-8 rounded-[32px] shadow-2xl border-border bg-background animate-in zoom-in duration-200">
            <div className="mb-6">
              <h3 className="text-xl font-bold text-foreground">Edit Member Profile</h3>
              <p className="text-sm text-muted mt-1">Assign roles and designations.</p>
            </div>
            
            <div className="space-y-5">
              {/* Custom Role Dropdown */}
              <CustomDropdown 
                id="role-dropdown"
                label="Custom Role"
                value={tempRoleId}
                onChange={setTempRoleId}
                options={[
                  { value: "", label: "No Custom Role" },
                  ...roles?.map(r => ({ value: r._id, label: r.name })) || []
                ]}
              />

              {/* System Role Dropdown */}
              <CustomDropdown 
                id="system-role-dropdown"
                label="System Permission"
                value={tempSystemRole}
                onChange={setTempSystemRole}
                disabled={editMemberModal.member.user?.clerkId === clerkUser?.id}
                options={[
                  { value: "employee", label: "Employee (Standard Access)" },
                  { value: "admin", label: "Admin (Full Control)" }
                ]}
              />

              <div>
                <label className="text-[10px] font-bold text-muted uppercase tracking-wider ml-1">Designation Title</label>
                <input 
                  className="input-field mt-1" 
                  value={tempDesignation} 
                  onChange={(e) => setTempDesignation(e.target.value)} 
                  placeholder="e.g. Senior Architect" 
                />
              </div>
              
              <div className="flex gap-3 pt-4">
                <button 
                  onClick={() => setEditMemberModal(null)} 
                  className="flex-1 py-3 rounded-xl bg-foreground/5 font-semibold text-xs uppercase tracking-wider border border-border cursor-pointer hover:bg-foreground/10 transition-colors"
                >
                  Cancel
                </button>
                <button 
                  onClick={saveMemberProfile} 
                  className="flex-1 py-3 rounded-xl bg-accent text-white font-semibold text-xs uppercase tracking-wider shadow-lg shadow-accent/20 cursor-pointer hover:bg-accent/90 transition-colors flex items-center justify-center gap-2"
                >
                  <Save className="w-3 h-3" /> Save Changes
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Security Removal Modal */}
      {memberToRemove && (
        <div className="fixed inset-0 z-[300] flex items-center justify-center bg-black/40 backdrop-blur-md p-4">
          <div className="glass-panel max-w-sm w-full p-8 rounded-[32px] shadow-2xl border-red-500/20 bg-background animate-in zoom-in duration-200">
             <div className="w-16 h-16 bg-red-500/10 rounded-2xl flex items-center justify-center mb-6 mx-auto border border-red-500/20">
              <AlertTriangle className="text-red-600 w-8 h-8" />
            </div>
            <div className="text-center mb-8">
              <h3 className="text-xl font-bold mb-2 text-foreground tracking-tight">Terminate Identity?</h3>
              <p className="text-muted text-sm leading-relaxed px-2 font-normal">
                Revoke all access for <span className="font-bold text-foreground">{memberToRemove.user?.name}</span>?
              </p>
            </div>
            <div className="flex gap-3">
              <button onClick={() => setMemberToRemove(null)} className="flex-1 py-3 rounded-xl bg-foreground/5 font-semibold text-xs uppercase tracking-wider border border-border cursor-pointer hover:bg-foreground/10">Abort</button>
              <button onClick={confirmRemoval} className="flex-1 py-3 rounded-xl bg-red-600 text-white font-semibold text-xs uppercase tracking-wider shadow-lg shadow-red-600/20 cursor-pointer hover:bg-red-700">Confirm</button>
            </div>
          </div>
        </div>
      )}

      {/* Create Workspace Modal */}
      {isCreateWorkspaceOpen && (
        <div className="fixed inset-0 z-[300] flex items-center justify-center bg-black/40 backdrop-blur-md p-4">
          <div className="glass-panel max-w-md w-full p-8 rounded-[32px] shadow-2xl border-border bg-background animate-in zoom-in duration-200">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-xl font-bold text-foreground">Provision Environment</h3>
              <button onClick={() => setIsCreateWorkspaceOpen(false)}><X className="w-5 h-5 text-muted hover:text-foreground cursor-pointer" /></button>
            </div>
            <div className="space-y-4">
               <div>
                 <label className="text-[10px] font-bold text-muted uppercase tracking-wider ml-1">Environment Name</label>
                 <input className="input-field mt-1" value={newWorkspaceName} onChange={(e) => setNewWorkspaceName(e.target.value)} placeholder="e.g. Legal Department" autoFocus />
               </div>
               <button onClick={handleCreateWorkspace} className="apple-button w-full mt-4 justify-center shadow-lg shadow-accent/20 cursor-pointer">Provision Node</button>
            </div>
          </div>
        </div>
      )}

      {/* ---------------------------------------------------------------------- */}
      {/* HEADER & NAVIGATION */}
      {/* ---------------------------------------------------------------------- */}
      <header className="flex flex-col md:flex-row md:items-end justify-between border-b border-border pb-8 gap-6">
        <div className="space-y-2">
          <div className="flex items-center gap-2 text-accent font-bold text-[10px] uppercase tracking-wider mb-2">
            <div className="w-2 h-2 rounded-full bg-accent animate-pulse" /> Kernel Level: Restricted
          </div>
          <h1 className="text-4xl font-semibold tracking-tight text-foreground leading-none">Governance</h1>
          <p className="text-muted font-medium text-sm mt-2">Axovanth Organizational Integrity Protocols</p>
        </div>
        
        {/* Tab Switcher */}
        <div className="flex items-center gap-1 bg-foreground/5 p-1.5 rounded-2xl overflow-hidden">
          <button 
            onClick={() => setActiveTab('hierarchy')}
            className={`px-5 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all duration-300 flex items-center gap-2 ${activeTab === 'hierarchy' ? 'bg-background shadow-md text-foreground' : 'text-muted hover:text-foreground hover:bg-foreground/5'}`}
          >
            <Users className="w-4 h-4" /> Hierarchy
          </button>
          <button 
            onClick={() => setActiveTab('workspaces')}
            className={`px-5 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all duration-300 flex items-center gap-2 ${activeTab === 'workspaces' ? 'bg-background shadow-md text-foreground' : 'text-muted hover:text-foreground hover:bg-foreground/5'}`}
          >
            <Building className="w-4 h-4" /> Workspaces
          </button>
          <button 
            onClick={() => setActiveTab('roles')}
            className={`px-5 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all duration-300 flex items-center gap-2 ${activeTab === 'roles' ? 'bg-background shadow-md text-foreground' : 'text-muted hover:text-foreground hover:bg-foreground/5'}`}
          >
            <UserCog className="w-4 h-4" /> Roles
          </button>
          <button 
            onClick={() => setActiveTab('requests')}
            className={`px-5 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all duration-300 flex items-center gap-2 ${activeTab === 'requests' ? 'bg-background shadow-md text-foreground' : 'text-muted hover:text-foreground hover:bg-foreground/5'}`}
          >
            <Inbox className="w-4 h-4" /> 
            Inbox
            {pendingRequestCount > 0 && <span className="ml-1 px-1.5 py-0.5 rounded-full bg-red-500 text-white text-[9px]">{pendingRequestCount}</span>}
          </button>
        </div>
      </header>

      {/* ---------------------------------------------------------------------- */}
      {/* TAB 1: HIERARCHY */}
      {/* ---------------------------------------------------------------------- */}
      {activeTab === 'hierarchy' && (
        <div className="space-y-8 animate-in fade-in duration-500">
          <section className="space-y-6">
            <div className="flex items-center justify-between px-2">
              <h2 className="text-xs font-bold flex items-center gap-3 text-muted uppercase tracking-wider">
                <ShieldAlert className="w-4 h-4 text-accent" /> Identity Matrix ({activeMembers.length})
              </h2>
            </div>
            
            <div className="glass-panel rounded-[32px] border-border shadow-sm bg-background overflow-visible">
              <table className="w-full text-left border-collapse">
                <thead className="bg-foreground/[0.02] border-b border-border">
                  <tr>
                    <th className="px-8 py-5 text-[10px] font-bold text-muted uppercase tracking-wider">Identity</th>
                    <th className="px-8 py-5 text-[10px] font-bold text-muted uppercase tracking-wider">Role Info</th>
                    <th className="px-8 py-5 text-[10px] font-bold text-muted uppercase tracking-wider text-right">Action</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-border">
                  {activeMembers.map((m) => {
                    const isSelf = m.user?.clerkId === clerkUser?.id;
                    return (
                      <tr key={m._id} className={`hover:bg-foreground/5 transition-all group ${isSelf ? 'bg-accent/[0.02]' : ''}`}>
                        
                        <td className="px-8 py-5 flex items-center gap-4">
                          <div className="relative">
                            <div className="w-10 h-10 bg-foreground/5 rounded-xl flex items-center justify-center font-bold text-sm border border-border text-muted">
                              {m.user?.name.substring(0, 1)}
                            </div>
                            {isSelf && <div className="absolute -top-1 -right-1 w-3 h-3 bg-accent rounded-full border-2 border-background flex items-center justify-center"><Info className="w-1.5 h-1.5 text-white" /></div>}
                          </div>
                          <div>
                            <p className="font-bold text-sm text-foreground tracking-tight">{m.user?.name}</p>
                            <p className="text-[10px] text-muted">{m.user?.email}</p>
                          </div>
                        </td>

                        <td className="px-8 py-5">
                          <div className="flex items-center gap-2">
                            <span className={`px-2 py-0.5 rounded-md text-[10px] font-bold uppercase ${m.role === 'admin' ? 'bg-red-500/10 text-red-500' : 'bg-blue-500/10 text-blue-500'}`}>
                              {m.role}
                            </span>
                            {m.roleName && (
                              <span className="px-2 py-0.5 rounded-md bg-foreground/5 text-foreground text-[10px] font-bold uppercase">
                                {m.roleName}
                              </span>
                            )}
                          </div>
                        </td>

                        <td className="px-8 py-5 text-right flex justify-end gap-2">
                          <button onClick={() => openEditModal(m)} className="p-2.5 bg-foreground/5 rounded-lg hover:bg-accent/10 hover:text-accent transition-all cursor-pointer">
                            <Edit2 className="w-4 h-4" />
                          </button>
                          {!isSelf ? (
                            <button onClick={() => setMemberToRemove(m)} className="p-2.5 bg-red-500/5 text-red-500 rounded-lg hover:bg-red-500 hover:text-white transition-all shadow-sm active:scale-95 cursor-pointer"><UserMinus className="w-4 h-4" /></button>
                          ) : (
                            <div className="p-2.5 bg-foreground/5 text-muted rounded-lg cursor-not-allowed opacity-30 inline-block"><Lock className="w-4 h-4" /></div>
                          )}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </section>
        </div>
      )}

      {/* ---------------------------------------------------------------------- */}
      {/* TAB 2: WORKSPACES */}
      {/* ---------------------------------------------------------------------- */}
      {activeTab === 'workspaces' && (
        <section className="space-y-6 animate-in fade-in duration-500">
          <h2 className="text-xs font-bold flex items-center gap-3 text-muted uppercase tracking-wider px-2">
             <Building className="w-4 h-4 text-accent" /> Departmental Access Control
          </h2>
          
          <div className="grid lg:grid-cols-12 gap-8">
             <div className="lg:col-span-4 space-y-4">
                <button 
                  onClick={() => setIsCreateWorkspaceOpen(true)}
                  className="w-full py-4 rounded-2xl border-2 border-dashed border-border hover:border-accent hover:bg-accent/5 transition-all flex flex-col items-center justify-center gap-2 group cursor-pointer"
                >
                   <Plus className="w-6 h-6 text-muted group-hover:text-accent" />
                   <span className="text-xs font-bold text-muted group-hover:text-accent uppercase tracking-wider">Provision Env</span>
                </button>
                
                <div className="space-y-2 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                  {workspaces.map(ws => {
                    const WsIcon = WorkspaceIconMap[ws.emoji] || Layers; // Dynamic Icon Rendering
                    return (
                      <div key={ws._id} className="relative group">
                        <button 
                          onClick={() => setSelectedWorkspaceId(ws._id)}
                          className={`w-full flex items-center justify-between p-4 rounded-2xl border transition-all cursor-pointer ${
                            selectedWorkspaceId === ws._id 
                            ? 'bg-accent text-white border-accent shadow-lg shadow-accent/20' 
                            : 'bg-background border-border hover:border-accent/50 text-foreground'
                          }`}
                        >
                          <div className="flex items-center gap-3">
                            <WsIcon className="w-5 h-5" />
                            <span className="font-bold text-sm">{ws.name}</span>
                          </div>
                          {selectedWorkspaceId === ws._id && <ChevronDown className="w-4 h-4 -rotate-90" />}
                        </button>
                        
                        {/* DELETE BUTTON - Only shows if not default */}
                        {!ws.isDefault && (
                          <button 
                            onClick={(e) => { e.stopPropagation(); setWorkspaceToDelete({ id: ws._id, name: ws.name }); }}
                            className="absolute top-1/2 -right-10 -translate-y-1/2 p-2 bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white rounded-xl transition-all opacity-0 group-hover:opacity-100 group-hover:right-2"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        )}
                      </div>
                    );
                  })}
                </div>
             </div>

             <div className="lg:col-span-8 glass-panel rounded-[32px] p-8 border-border bg-background min-h-[400px]">
                {!selectedWorkspaceId ? (
                  <div className="h-full flex flex-col items-center justify-center text-center opacity-40 gap-4">
                     <LayoutGrid className="w-12 h-12 text-muted" />
                     <p className="text-sm font-medium text-muted">Select a department node to configure access.</p>
                  </div>
                ) : (
                  <div className="space-y-6 animate-in fade-in duration-300">
                     <div className="flex items-center justify-between border-b border-border pb-6">
                        <div>
                          <h3 className="text-xl font-bold text-foreground">Member Roster</h3>
                          <p className="text-xs text-muted font-medium mt-1">Configure access levels for this environment.</p>
                        </div>
                     </div>

                     <div className="space-y-4">
                       {workspaceMembers === undefined ? (
                         <Loader2 className="w-6 h-6 animate-spin text-accent mx-auto" />
                       ) : workspaceMembers.length === 0 ? (
                         <p className="text-center text-sm text-muted italic py-10">No members assigned to this node.</p>
                       ) : (
                         workspaceMembers.map((wm: any) => (
                           <div key={wm._id} className="flex items-center justify-between p-4 bg-foreground/5 rounded-2xl border border-border">
                              <div className="flex items-center gap-4">
                                <div className="w-10 h-10 bg-background rounded-xl flex items-center justify-center font-bold text-xs border border-border">
                                  {wm.user?.name.substring(0, 1)}
                                </div>
                                <p className="font-bold text-sm text-foreground">{wm.user?.name}</p>
                              </div>
                              
                              <div className="flex items-center gap-2">
                                 <button 
                                   onClick={() => updateWorkspaceRole({ memberId: wm._id, role: wm.role === 'admin' ? 'member' : 'admin' })}
                                   className={`px-3 py-1.5 rounded-lg text-xs font-bold uppercase transition-all cursor-pointer ${
                                     wm.role === 'admin' ? 'bg-accent/10 text-accent' : 'bg-muted/10 text-muted hover:bg-muted/20'
                                   }`}
                                 >
                                   {wm.role}
                                 </button>
                                 <button 
                                   onClick={() => removeWorkspaceMember({ memberId: wm._id })}
                                   className="p-2 hover:bg-background rounded-lg text-muted hover:text-red-500 transition-colors cursor-pointer"
                                 >
                                   <X className="w-4 h-4" />
                                 </button>
                              </div>
                           </div>
                         ))
                       )}

                       <div className="pt-6 border-t border-border mt-8">
                          <p className="text-[10px] font-bold text-muted uppercase tracking-wider mb-4">Quick Add from Organization</p>
                          <div className="flex flex-wrap gap-2">
                             {activeMembers
                               .filter(am => !workspaceMembers?.some((wm: any) => wm.userId === am.userId))
                               .map(am => (
                                 <button 
                                   key={am._id}
                                   onClick={() => handleAddToWorkspace(am.userId, 'member')}
                                   className="flex items-center gap-2 px-3 py-2 bg-background border border-border rounded-xl hover:border-accent hover:text-accent transition-all text-xs font-semibold group cursor-pointer"
                                 >
                                   <Plus className="w-3 h-3 text-muted group-hover:text-accent" />
                                   {am.user?.name}
                                 </button>
                               ))
                             }
                          </div>
                       </div>
                     </div>
                  </div>
                )}
             </div>
          </div>
        </section>
      )}

      {/* ---------------------------------------------------------------------- */}
      {/* TAB 3: ROLES */}
      {/* ---------------------------------------------------------------------- */}
      {activeTab === 'roles' && (
        <section className="grid lg:grid-cols-3 gap-8 animate-in fade-in duration-500">
          <div className="glass-panel p-8 rounded-[32px] border-border bg-background space-y-6 h-fit">
            <div className="flex items-center gap-3 mb-2">
              <div className="w-10 h-10 bg-accent/10 rounded-xl flex items-center justify-center text-accent">
                <UserCog className="w-5 h-5" />
              </div>
              <h3 className="font-bold text-foreground">Define New Role</h3>
            </div>
            
            <div className="space-y-4">
              <div>
                <label className="text-[10px] font-bold text-muted uppercase tracking-wider ml-1">Role Name</label>
                <input 
                  className="input-field mt-1" 
                  placeholder="e.g. Senior Developer" 
                  value={newRole.name} 
                  onChange={(e) => setNewRole({...newRole, name: e.target.value})} 
                />
              </div>
              
              <div>
                <label className="text-[10px] font-bold text-muted uppercase tracking-wider ml-1">Description</label>
                <textarea 
                  className="input-field mt-1 h-20 resize-none" 
                  placeholder="Responsibilities..." 
                  value={newRole.description} 
                  onChange={(e) => setNewRole({...newRole, description: e.target.value})} 
                />
              </div>

              <div>
                <label className="text-[10px] font-bold text-muted uppercase tracking-wider ml-1">Color Code</label>
                <div className="flex gap-2 mt-2">
                  {['blue', 'green', 'purple', 'orange', 'red'].map(c => (
                    <button 
                      key={c}
                      onClick={() => setNewRole({...newRole, color: c})}
                      className={`w-6 h-6 rounded-full border-2 transition-all ${newRole.color === c ? 'border-foreground scale-110' : 'border-transparent'}`}
                      style={{ backgroundColor: `var(--color-${c}-500, ${c})` }} 
                    />
                  ))}
                </div>
              </div>

              <button 
                onClick={handleCreateRole} 
                disabled={!newRole.name}
                className="apple-button w-full justify-center mt-4"
              >
                Create Role Definitions
              </button>
            </div>
          </div>

          <div className="lg:col-span-2 space-y-4">
            <h2 className="text-xs font-bold text-muted uppercase tracking-wider px-2">Active Role Definitions</h2>
            
            {roles.length === 0 ? (
              <div className="p-12 text-center border-2 border-dashed border-border rounded-[32px]">
                <p className="text-muted text-sm font-medium">No custom roles defined yet.</p>
              </div>
            ) : (
              <div className="grid md:grid-cols-2 gap-4">
                {roles.map(r => (
                  <div key={r._id} className="glass-panel p-6 rounded-2xl flex flex-col justify-between border-border hover:border-accent/50 transition-all group min-h-[140px]">
                    <div>
                      <div className="flex justify-between items-start mb-2">
                        <h4 className="font-bold text-foreground text-lg">{r.name}</h4>
                        <button onClick={() => deleteRole({ roleId: r._id })} className="p-2 -mr-2 -mt-2 hover:bg-red-500/10 text-muted hover:text-red-500 rounded-xl opacity-0 group-hover:opacity-100 transition-all">
                          <X className="w-4 h-4" />
                        </button>
                      </div>
                      <p className="text-sm text-muted leading-relaxed line-clamp-2">{r.description || "No description provided."}</p>
                    </div>
                    <div className="mt-4 pt-4 border-t border-border flex items-center gap-2">
                      <div className={`w-2 h-2 rounded-full bg-${r.color}-500`} />
                      <span className="text-[10px] font-bold uppercase tracking-wider text-muted">{r.color} Tag</span>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </section>
      )}

      {/* ---------------------------------------------------------------------- */}
      {/* TAB 4: REQUEST INBOX */}
      {/* ---------------------------------------------------------------------- */}
      {activeTab === 'requests' && (
        <div className="grid gap-8 animate-in fade-in duration-500">
          
          {/* Section 1: Company Join Requests */}
          <section className="space-y-4">
            <h2 className="text-sm font-bold text-muted uppercase tracking-wider flex gap-2 items-center px-2">
              <UserPlus className="w-4 h-4" /> Company Join Requests
            </h2>
            {pendingMembers.length === 0 ? (
              <div className="p-8 glass-panel rounded-2xl border-border text-center">
                <p className="text-sm text-muted italic">No pending company join requests.</p>
              </div>
            ) : (
              pendingMembers.map(m => (
                <div key={m._id} className="glass-panel p-4 rounded-xl flex justify-between items-center border-border hover:border-accent/30 transition-all">
                  <div className="flex gap-4 items-center">
                    <div className="w-10 h-10 bg-foreground/5 rounded-full flex items-center justify-center font-bold text-sm text-muted">
                      {m.user?.name[0]}
                    </div>
                    <div>
                      <p className="text-sm font-bold text-foreground">
                        {m.user?.name} <span className="font-normal text-muted">requests to join</span>
                      </p>
                      <p className="text-[10px] text-muted uppercase tracking-wider mt-0.5">{m.user?.email}</p>
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={() => removeMember({ memberId: m._id })} className="px-4 py-2 bg-red-500/10 text-red-600 rounded-lg text-xs font-bold uppercase hover:bg-red-500 hover:text-white transition-all">Decline</button>
                    <button onClick={() => updateStatus({ memberId: m._id, status: "active" })} className="px-4 py-2 bg-green-500/10 text-green-600 rounded-lg text-xs font-bold uppercase hover:bg-green-500 hover:text-white transition-all">Admit</button>
                  </div>
                </div>
              ))
            )}
          </section>

          {/* Section 2: Role Requests */}
          <section className="space-y-4">
            <h2 className="text-sm font-bold text-muted uppercase tracking-wider flex gap-2 items-center px-2">
              <UserCog className="w-4 h-4" /> Role Assignment Requests
            </h2>
            {roleRequests.length === 0 ? (
              <div className="p-8 glass-panel rounded-2xl border-border text-center">
                <p className="text-sm text-muted italic">No pending role requests.</p>
              </div>
            ) : (
              roleRequests.map(r => (
                <div key={r._id} className="glass-panel p-4 rounded-xl flex justify-between items-center border-border hover:border-accent/30 transition-all">
                  <div className="flex gap-4 items-center">
                    <div className="w-10 h-10 bg-foreground/5 rounded-full flex items-center justify-center font-bold text-sm text-muted">
                      {r.user?.name[0]}
                    </div>
                    <div>
                      <p className="text-sm font-bold text-foreground">
                        {r.user?.name} <span className="font-normal text-muted">requests</span> <span className="text-accent">{r.role?.name}</span>
                      </p>
                      <p className="text-[10px] text-muted uppercase tracking-wider mt-0.5">Submitted {new Date(r._creationTime).toLocaleDateString()}</p>
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <button 
                      onClick={() => initiateDecision('role', r._id, 'reject', r.user?.name || "Unknown User", r.role?.name || "Unknown Role")} 
                      className="px-4 py-2 bg-red-500/10 text-red-600 rounded-lg text-xs font-bold uppercase hover:bg-red-500 hover:text-white transition-all"
                    >
                      Reject
                    </button>
                    <button 
                      onClick={() => initiateDecision('role', r._id, 'approve', r.user?.name || "Unknown User", r.role?.name || "Unknown Role")} 
                      className="px-4 py-2 bg-green-500/10 text-green-600 rounded-lg text-xs font-bold uppercase hover:bg-green-500 hover:text-white transition-all"
                    >
                      Approve
                    </button>
                  </div>
                </div>
              ))
            )}
          </section>

          {/* Section 3: Workspace Access Requests */}
          <section className="space-y-4">
            <h2 className="text-sm font-bold text-muted uppercase tracking-wider flex gap-2 items-center px-2">
              <Lock className="w-4 h-4" /> Workspace Access Requests
            </h2>
            {workspaceRequests.length === 0 ? (
              <div className="p-8 glass-panel rounded-2xl border-border text-center">
                <p className="text-sm text-muted italic">No pending workspace requests.</p>
              </div>
            ) : (
              workspaceRequests.map((r: any) => (
                <div key={r._id} className="glass-panel p-4 rounded-xl flex justify-between items-center border-border hover:border-accent/30 transition-all">
                  <div className="flex gap-4 items-center">
                    <div className="w-10 h-10 bg-foreground/5 rounded-full flex items-center justify-center font-bold text-sm text-muted">
                      {r.user?.name[0]}
                    </div>
                    <div>
                      <p className="text-sm font-bold text-foreground">
                        {r.user?.name} <span className="font-normal text-muted">requests access to</span> <span className="text-accent">{r.workspaceName || "Unknown Workspace"}</span>
                      </p>
                      <p className="text-[10px] text-muted uppercase tracking-wider mt-0.5">Submitted {new Date(r._creationTime).toLocaleDateString()}</p>
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <button 
                      onClick={() => initiateDecision('workspace', r._id, 'reject', r.user?.name || "Unknown User", r.workspaceName || "Unknown Workspace")} 
                      className="px-4 py-2 bg-red-500/10 text-red-600 rounded-lg text-xs font-bold uppercase hover:bg-red-500 hover:text-white transition-all"
                    >
                      Reject
                    </button>
                    <button 
                      onClick={() => initiateDecision('workspace', r._id, 'approve', r.user?.name || "Unknown User", r.workspaceName || "Unknown Workspace")} 
                      className="px-4 py-2 bg-green-500/10 text-green-600 rounded-lg text-xs font-bold uppercase hover:bg-green-500 hover:text-white transition-all"
                    >
                      Approve
                    </button>
                  </div>
                </div>
              ))
            )}
          </section>

        </div>
      )}
    </div>
  );
}
</file>

<file path="src/app/dashboard/[companyId]/workflow/page.tsx">
"use client";

import { useState, useRef, useEffect } from "react";
import { useQuery, useMutation } from "convex/react";
import { api } from "../../../../../convex/_generated/api";
import { useParams } from "next/navigation";
import { 
  Ticket, Hash, Loader2, ArrowRightLeft, X, Send, AlertCircle, ChevronRight, 
  User, RefreshCw, Check, Calendar, Flag, Clock, History, MessageSquare, AlertTriangle, Plus,
  Layout, List
} from "lucide-react";
import { useUser } from "@clerk/nextjs";

// NEW: Explicit Type Definition to fix Build Error
interface AdminStats {
  isOverallAdmin: boolean;
  adminWorkspaceIds: string[];
}

export default function OperationalWorkflow() {
  const params = useParams();
  const companyId = params.companyId as any;
  const { user: clerkUser } = useUser();

  // Global Data
  const tickets = useQuery(api.tickets.getAll, { companyId });
  const workspaces = useQuery(api.workspaces.getByCompany, { companyId });
  
  // FIX: Cast the result to the explicit type
  const adminStats = useQuery(api.workspaces.getMyAdminStats, { companyId }) as AdminStats | undefined;
  
  const members = useQuery(api.companies.getMembers, { companyId });

  // Mutations
  const transferTicket = useMutation(api.tickets.transfer);
  const resolveTicket = useMutation(api.tickets.resolve);
  const reopenTicket = useMutation(api.tickets.reopen);
  const addComment = useMutation(api.tickets.addComment);
  const updatePriority = useMutation(api.tickets.updatePriority);
  const assignTicket = useMutation(api.tickets.assign);
  const setDueDate = useMutation(api.tickets.setDueDate);

  // UI State
  const [selectedTicketId, setSelectedTicketId] = useState<string | null>(null);
  const [tab, setTab] = useState<'chat' | 'audit'>('chat');
  const [viewMode, setViewMode] = useState<'list' | 'board'>('list'); // Kanban Toggle
  const [confirmAction, setConfirmAction] = useState<{type: 'resolve' | 'reopen' | 'transfer', targetId?: string} | null>(null);
  const [commentText, setCommentText] = useState("");
  const [isTransferring, setIsTransferring] = useState(false);
  const [targetWs, setTargetWs] = useState("");

  const scrollRef = useRef<HTMLDivElement>(null);
  
  const selectedTicket = tickets?.find((t: any) => t._id === selectedTicketId) || null;
  const comments = useQuery(api.tickets.getComments, selectedTicketId ? { ticketId: selectedTicketId as any } : "skip");
  const events = useQuery(api.tickets.getEvents, selectedTicketId ? { ticketId: selectedTicketId as any } : "skip");

  // Permission Logic
  const canEdit = (ticketWsId: string) => {
    if (!adminStats) return false;
    if (adminStats.isOverallAdmin) return true;
    return adminStats.adminWorkspaceIds.includes(ticketWsId);
  };

  const hasEditRights = selectedTicket ? canEdit(selectedTicket.workspaceId) : false;

  const handleComment = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!commentText.trim() || !selectedTicket) return;
    try {
      await addComment({ ticketId: selectedTicket._id, content: commentText });
      setCommentText("");
      if(tab === 'chat') setTimeout(() => scrollRef.current?.scrollIntoView({ behavior: "smooth" }), 100);
    } catch (e) { console.error(e); }
  };

  const executeAction = async () => {
    if (!confirmAction || !selectedTicket) return;
    
    try {
      if (confirmAction.type === 'resolve') await resolveTicket({ ticketId: selectedTicket._id });
      if (confirmAction.type === 'reopen') await reopenTicket({ ticketId: selectedTicket._id });
      if (confirmAction.type === 'transfer' && targetWs) {
        await transferTicket({ ticketId: selectedTicket._id, targetWorkspaceId: targetWs as any });
        setIsTransferring(false);
        setTargetWs("");
      }
      setConfirmAction(null);
    } catch (e: any) {
      alert(e.message);
    }
  };

  if (!tickets || !workspaces || !adminStats) return (
    <div className="h-[60vh] flex flex-col items-center justify-center gap-4">
      <Loader2 className="w-8 h-8 text-accent animate-spin" />
      <p className="text-muted text-sm font-medium animate-pulse">Synchronizing Global Workflow...</p>
    </div>
  );

  const KanbanColumn = ({ status, label }: { status: string, label: string }) => {
    const columnTickets = tickets.filter(t => t.status === status);
    
    return (
      <div className="flex-1 min-w-[300px] flex flex-col gap-4">
        <div className="flex items-center justify-between px-2">
          <h3 className="text-xs font-bold uppercase tracking-wider text-muted flex items-center gap-2">
            <span className={`w-2 h-2 rounded-full ${status === 'open' ? 'bg-blue-500' : status === 'in_progress' ? 'bg-orange-500' : 'bg-green-500'}`} />
            {label} ({columnTickets.length})
          </h3>
        </div>
        <div className="flex-1 bg-foreground/[0.02] rounded-2xl p-2 space-y-3 min-h-[500px] border border-border/50">
          {columnTickets.map(ticket => (
            <div 
              key={ticket._id}
              onClick={() => setSelectedTicketId(ticket._id)}
              className="p-4 rounded-xl bg-background border border-border hover:border-accent/50 cursor-pointer shadow-sm group transition-all"
            >
              <div className="flex justify-between items-start mb-2">
                <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${
                  ticket.priority === 'high' ? 'bg-red-500/10 text-red-500' : 'bg-blue-500/10 text-blue-500'
                }`}>
                  {ticket.priority}
                </span>
                <span className="text-[10px] text-muted">{ticket.workspace?.name}</span>
              </div>
              <h4 className="text-sm font-bold text-foreground mb-2 line-clamp-2">{ticket.title}</h4>
              <div className="flex items-center justify-between mt-3 pt-3 border-t border-border/50">
                <div className="flex items-center gap-2">
                   <div className="w-5 h-5 rounded-full bg-foreground/10 flex items-center justify-center text-[9px] font-bold">
                     {ticket.assignee?.name?.[0] || "?"}
                   </div>
                </div>
                <span className="text-[10px] text-muted">{new Date(ticket._creationTime).toLocaleDateString()}</span>
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  };

  return (
    <div className="max-w-7xl mx-auto space-y-8 pb-32 animate-in fade-in duration-700 font-sans h-full">
      
      {/* GLOBAL HEADER */}
      <header className="flex flex-col md:flex-row md:items-end justify-between border-b border-border pb-8 gap-6">
        <div className="space-y-2">
          <div className="flex items-center gap-2 text-accent font-bold text-[10px] uppercase tracking-wider mb-2">
             <div className="w-2 h-2 rounded-full bg-accent animate-pulse" /> Global Overview
          </div>
          <h1 className="text-4xl font-semibold tracking-tight text-foreground">Operational Workflow</h1>
          <p className="text-muted text-lg font-normal">Centralized command for all departmental tickets.</p>
        </div>
        
        <div className="flex bg-foreground/5 p-1 rounded-xl">
          <button 
            onClick={() => setViewMode('list')}
            className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider flex items-center gap-2 transition-all ${viewMode === 'list' ? 'bg-background shadow-sm text-foreground' : 'text-muted hover:text-foreground'}`}
          >
            <List className="w-4 h-4" /> List
          </button>
          <button 
            onClick={() => setViewMode('board')}
            className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider flex items-center gap-2 transition-all ${viewMode === 'board' ? 'bg-background shadow-sm text-foreground' : 'text-muted hover:text-foreground'}`}
          >
            <Layout className="w-4 h-4" /> Board
          </button>
        </div>
      </header>

      {/* VIEW SWITCHER */}
      {viewMode === 'list' ? (
        <div className="space-y-4">
          {tickets.length === 0 ? (
            <div className="p-12 text-center border-2 border-dashed border-border rounded-3xl">
              <p className="text-muted text-sm font-medium">No active flows in the system.</p>
            </div>
          ) : (
            tickets.map((ticket) => (
              <div 
                key={ticket._id}
                onClick={() => setSelectedTicketId(ticket._id)}
                className="glass-panel p-6 rounded-2xl border border-border hover:border-accent/50 hover:bg-accent/[0.02] transition-all cursor-pointer group flex items-center justify-between"
              >
                <div className="flex items-center gap-6">
                  <div className={`w-12 h-12 rounded-xl flex items-center justify-center text-xl bg-foreground/5 border border-border`}>
                    {ticket.workspace?.emoji || "ðŸ“‚"}
                  </div>
                  <div>
                    <h3 className="font-semibold text-foreground tracking-tight">{ticket.title}</h3>
                    <div className="flex items-center gap-3 mt-1">
                      <span className="text-xs text-muted">{ticket.workspace?.name}</span>
                      <span className="w-1 h-1 rounded-full bg-border" />
                      <span className={`text-[10px] font-bold uppercase tracking-wider ${
                        ticket.priority === 'high' ? 'text-red-500' : ticket.priority === 'medium' ? 'text-orange-500' : 'text-green-500'
                      }`}>{ticket.priority}</span>
                    </div>
                  </div>
                </div>
                <div className="flex items-center gap-4">
                  <div className="text-right hidden md:block">
                    <p className="text-xs font-bold text-foreground">{ticket.assignee?.name || "Unassigned"}</p>
                    <p className="text--[10px] text-muted uppercase tracking-wider">Assignee</p>
                  </div>
                  <div className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider border ${
                    ticket.status === 'open' ? 'bg-accent/10 text-accent border-accent/20' : 'bg-green-500/10 text-green-600 border-green-500/20'
                  }`}>
                    {ticket.status}
                  </div>
                  <ChevronRight className="w-4 h-4 text-muted group-hover:text-accent" />
                </div>
              </div>
            ))
          )}
        </div>
      ) : (
        <div className="flex gap-6 overflow-x-auto pb-6">
          <KanbanColumn status="open" label="Open" />
          <KanbanColumn status="in_progress" label="In Progress" />
          <KanbanColumn status="resolved" label="Resolved" />
        </div>
      )}

      {/* ENHANCED DRAWER */}
      {selectedTicket && (
        <div className="fixed inset-0 z-[150] flex items-center justify-end bg-black/40 backdrop-blur-md p-4 transition-all">
          <div className="glass-panel w-full max-w-5xl h-full rounded-[32px] shadow-2xl animate-in slide-in-from-right duration-500 overflow-hidden flex flex-col border-border bg-background">
            
            {/* CONFIRMATION MODAL */}
            {confirmAction && (
              <div className="absolute inset-0 z-[200] bg-background/80 backdrop-blur-sm flex items-center justify-center p-4">
                <div className="bg-background border border-border p-8 rounded-3xl shadow-2xl max-w-sm w-full animate-in zoom-in-95">
                  <div className="w-12 h-12 bg-red-500/10 text-red-500 rounded-xl flex items-center justify-center mb-4 mx-auto">
                    <AlertTriangle className="w-6 h-6" />
                  </div>
                  <h3 className="text-center text-lg font-bold text-foreground mb-2">Confirm Critical Action</h3>
                  <p className="text-center text-sm text-muted mb-6">
                    Are you sure you want to <strong>{confirmAction.type}</strong> this ticket? This action will be logged.
                  </p>
                  <div className="flex gap-3">
                    <button onClick={() => setConfirmAction(null)} className="flex-1 py-2 rounded-xl border border-border text-xs font-bold uppercase hover:bg-foreground/5">Cancel</button>
                    <button onClick={executeAction} className="flex-1 py-2 rounded-xl bg-red-500 text-white text-xs font-bold uppercase shadow-lg shadow-red-500/20 hover:bg-red-600">Confirm</button>
                  </div>
                </div>
              </div>
            )}

            <header className="px-8 py-5 border-b border-border bg-background/50 backdrop-blur-xl flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="w-10 h-10 bg-accent/10 rounded-xl flex items-center justify-center text-accent border border-accent/20">
                  <Hash className="w-5 h-5" />
                </div>
                <div>
                  <h2 className="text-xl font-bold text-foreground truncate w-96 tracking-tight">{selectedTicket.title}</h2>
                  <p className="text-xs text-muted font-medium">{selectedTicket.workspace?.name} Workspace</p>
                </div>
              </div>
              <button onClick={() => setSelectedTicketId(null)} className="p-2 hover:bg-foreground/5 rounded-full text-muted hover:text-foreground">
                <X className="w-6 h-6" />
              </button>
            </header>

            <div className="flex-1 flex overflow-hidden">
              <div className="flex-1 flex flex-col border-r border-border min-w-0">
                
                {/* TABS */}
                <div className="flex items-center border-b border-border px-8">
                  <button 
                    onClick={() => setTab('chat')} 
                    className={`py-4 text-xs font-bold uppercase tracking-wider border-b-2 px-4 transition-all ${tab === 'chat' ? 'border-accent text-foreground' : 'border-transparent text-muted hover:text-foreground'}`}
                  >
                    <MessageSquare className="w-3 h-3 inline mr-2" /> Discussion
                  </button>
                  <button 
                    onClick={() => setTab('audit')} 
                    className={`py-4 text-xs font-bold uppercase tracking-wider border-b-2 px-4 transition-all ${tab === 'audit' ? 'border-accent text-foreground' : 'border-transparent text-muted hover:text-foreground'}`}
                  >
                    <History className="w-3 h-3 inline mr-2" /> Audit Log
                  </button>
                </div>

                <div className="flex-1 overflow-y-auto p-8 custom-scrollbar">
                  {tab === 'chat' ? (
                    <div className="space-y-6">
                      <div className="p-6 bg-foreground/[0.02] rounded-2xl border border-border">
                        <p className="text-foreground text-sm leading-relaxed">{selectedTicket.description}</p>
                      </div>
                      <div className="space-y-4">
                        {comments?.map((c) => {
                          const isMe = c.author?.clerkId === clerkUser?.id;
                          return (
                            <div key={c._id} className={`flex gap-3 ${isMe ? "flex-row-reverse" : "flex-row"}`}>
                              <div className="w-8 h-8 rounded-lg bg-foreground/5 flex items-center justify-center text-xs font-bold text-muted shrink-0">
                                {c.author?.name?.[0]}
                              </div>
                              <div className={`max-w-[80%] ${isMe ? "items-end" : "items-start"} flex flex-col gap-1`}>
                                <div className={`px-4 py-2.5 rounded-2xl text-sm font-medium leading-relaxed border ${
                                  isMe ? "bg-accent text-white border-accent/50 rounded-tr-sm" : "bg-white dark:bg-white/5 text-foreground border-border rounded-tl-sm"
                                }`}>
                                  {c.content}
                                </div>
                                <span className="text-[9px] text-muted opacity-60">{new Date(c._creationTime).toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'})} â€¢ {c.author?.name}</span>
                              </div>
                            </div>
                          );
                        })}
                        <div ref={scrollRef} />
                      </div>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {events?.map((e, idx) => (
                        <div key={idx} className="flex gap-4 p-4 rounded-xl bg-foreground/[0.02] border border-border">
                          <div className="mt-1">
                            {e.type === 'created' && <Plus className="w-4 h-4 text-blue-500" />}
                            {e.type === 'status_change' && <Check className="w-4 h-4 text-green-500" />}
                            {e.type === 'priority_update' && <Flag className="w-4 h-4 text-orange-500" />}
                            {e.type === 'transferred' && <ArrowRightLeft className="w-4 h-4 text-purple-500" />}
                            {e.type.includes('update') && <RefreshCw className="w-4 h-4 text-muted" />}
                          </div>
                          <div>
                            <p className="text-sm font-medium text-foreground">{e.metadata}</p>
                            <div className="flex items-center gap-2 mt-1">
                              <span className="text-xs text-muted">{e.actor?.name}</span>
                              <span className="text-[10px] text-muted opacity-50">{new Date(e._creationTime).toLocaleString()}</span>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {tab === 'chat' && (
                  <form onSubmit={handleComment} className="p-4 border-t border-border bg-background/50 backdrop-blur-md">
                    <div className="flex gap-2">
                      <input placeholder="Transmit update..." className="input-field py-2.5 text-sm" value={commentText} onChange={(e) => setCommentText(e.target.value)} />
                      <button type="submit" className="p-3 bg-accent hover:bg-accent/90 text-white rounded-xl shadow-lg shadow-accent/20"><Send className="w-4 h-4" /></button>
                    </div>
                  </form>
                )}
              </div>

              {/* SIDEBAR */}
              <div className="w-80 bg-background/50 backdrop-blur-xl p-6 space-y-8 overflow-y-auto custom-scrollbar border-l border-border">
                <div className={`space-y-8 ${!hasEditRights ? "opacity-50 pointer-events-none grayscale" : ""}`}>
                  
                  {/* Priority */}
                  <div className="space-y-4">
                    <h3 className="text-xs font-bold text-muted uppercase tracking-wider flex items-center gap-2"><Flag className="w-3.5 h-3.5" /> Priority</h3>
                    <div className="flex bg-foreground/5 p-1 rounded-xl">
                      {['low', 'medium', 'high'].map((p) => (
                        <button
                          key={p}
                          onClick={() => updatePriority({ ticketId: selectedTicket._id, priority: p as any })}
                          className={`flex-1 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all ${
                            selectedTicket.priority === p ? 'bg-white shadow-sm text-foreground' : 'text-muted'
                          }`}
                        >
                          {p}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Assignee */}
                  <div className="space-y-4">
                    <h3 className="text-xs font-bold text-muted uppercase tracking-wider flex items-center gap-2"><User className="w-3.5 h-3.5" /> Assignee</h3>
                    <select 
                      className="w-full bg-background border border-border rounded-xl px-3 py-2 text-sm"
                      value={selectedTicket.assigneeId || ""}
                      onChange={(e) => assignTicket({ ticketId: selectedTicket._id, assigneeId: e.target.value === "" ? undefined : e.target.value as any })}
                    >
                      <option value="">Unassigned</option>
                      {members?.map((m: any) => (
                        <option key={m.user._id} value={m.user._id}>{m.user.name}</option>
                      ))}
                    </select>
                  </div>

                  {/* Due Date */}
                  <div className="space-y-4">
                    <h3 className="text-xs font-bold text-muted uppercase tracking-wider flex items-center gap-2"><Clock className="w-3.5 h-3.5" /> Target Date</h3>
                    <input 
                      type="date" 
                      className="w-full bg-background border border-border rounded-xl px-3 py-2 text-sm"
                      value={selectedTicket.dueDate ? new Date(selectedTicket.dueDate).toISOString().split('T')[0] : ""}
                      onChange={(e) => setDueDate({ ticketId: selectedTicket._id, dueDate: e.target.value ? new Date(e.target.value).getTime() : undefined })}
                    />
                  </div>
                </div>

                {/* Admin Actions */}
                <div className="pt-6 border-t border-border space-y-3">
                  <h3 className="text-xs font-bold text-muted uppercase tracking-wider flex items-center gap-2"><AlertCircle className="w-3.5 h-3.5" /> Controls</h3>
                  
                  {!hasEditRights && <p className="text-xs text-red-500 font-medium bg-red-500/10 p-2 rounded-lg">Read Only Access</p>}

                  {hasEditRights && (
                    <>
                      {selectedTicket.status === 'open' ? (
                        <button onClick={() => setConfirmAction({type: 'resolve'})} className="w-full py-2 bg-green-500/10 text-green-600 border border-green-500/20 rounded-xl text-xs font-bold uppercase hover:bg-green-500 hover:text-white transition-all">Mark Resolved</button>
                      ) : (
                        <button onClick={() => setConfirmAction({type: 'reopen'})} className="w-full py-2 bg-foreground/5 text-foreground border border-border rounded-xl text-xs font-bold uppercase hover:bg-foreground/10 transition-all flex items-center justify-center gap-2"><RefreshCw className="w-3 h-3" /> Reopen</button>
                      )}

                      {!isTransferring ? (
                        <button onClick={() => setIsTransferring(true)} className="w-full py-2 bg-background border border-border text-muted rounded-xl text-xs font-bold uppercase hover:border-accent hover:text-accent transition-all">Transfer Node</button>
                      ) : (
                        <div className="space-y-2 animate-in fade-in">
                          <select className="w-full bg-background border border-border rounded-xl px-2 py-1.5 text-xs" onChange={(e) => setTargetWs(e.target.value)}>
                            <option value="">Select Department...</option>
                            {workspaces?.filter(ws => ws._id !== selectedTicket.workspaceId).map(ws => (
                              <option key={ws._id} value={ws._id}>{ws.emoji} {ws.name}</option>
                            ))}
                          </select>
                          <div className="flex gap-2">
                            <button onClick={() => setIsTransferring(false)} className="flex-1 py-1 bg-foreground/5 rounded-lg text-[10px] font-bold uppercase">Cancel</button>
                            <button onClick={() => setConfirmAction({type: 'transfer', targetId: targetWs})} disabled={!targetWs} className="flex-1 py-1 bg-accent text-white rounded-lg text-[10px] font-bold uppercase">Confirm</button>
                          </div>
                        </div>
                      )}
                    </>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/app/dashboard/[companyId]/ws/[workspaceId]/page.tsx">
"use client";

import { useState, useRef, useEffect } from "react";
import { useQuery, useMutation } from "convex/react";
import { api } from "../../../../../../convex/_generated/api";
import { useParams } from "next/navigation";
import { 
  Ticket, Plus, Hash, UploadCloud, File as FileIcon, Download, 
  Loader2, ArrowRightLeft, X, Send, AlertCircle, ChevronRight, 
  User, RefreshCw, BarChart3, Check, Calendar, Flag, Clock, History, MessageSquare, AlertTriangle,
  Layout, List, MessageCircle, Paperclip, Smile
} from "lucide-react";
import { useUser } from "@clerk/nextjs";

export default function WorkspacePage() {
  const params = useParams();
  const workspaceId = params.workspaceId as any;
  const companyId = params.companyId as any;
  const { user: clerkUser } = useUser();

  // Data
  const tickets = useQuery(api.tickets.getByWorkspace, { workspaceId });
  const assets = useQuery(api.files.getByWorkspace, { workspaceId });
  const workspaces = useQuery(api.workspaces.getByCompany, { companyId });
  const members = useQuery(api.workspaces.getMembers, { workspaceId });
  const myPermissions = useQuery(api.workspaces.getMyself, { workspaceId });
  const chatMessages = useQuery(api.chat.getMessages, { companyId, workspaceId }); // Workspace Chat
  
  // Mutations
  const createTicket = useMutation(api.tickets.create);
  const transferTicket = useMutation(api.tickets.transfer);
  const resolveTicket = useMutation(api.tickets.resolve);
  const reopenTicket = useMutation(api.tickets.reopen);
  const addComment = useMutation(api.tickets.addComment);
  const updatePriority = useMutation(api.tickets.updatePriority);
  const assignTicket = useMutation(api.tickets.assign);
  const setDueDate = useMutation(api.tickets.setDueDate);
  const generateUploadUrl = useMutation(api.files.generateUploadUrl);
  const sendFile = useMutation(api.files.sendFile);
  const sendChatMessage = useMutation(api.chat.send); // Chat Mutation

  // UI State
  const [activeTab, setActiveTab] = useState<'overview' | 'board' | 'chat' | 'assets'>('overview');
  const [selectedTicketId, setSelectedTicketId] = useState<string | null>(null);
  const [drawerTab, setDrawerTab] = useState<'chat' | 'audit'>('chat');
  
  // FIX: Added targetId as optional string to type definition
  const [confirmAction, setConfirmAction] = useState<{type: 'resolve' | 'reopen' | 'transfer', targetId?: string} | null>(null);
  
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isUploading, setIsUploading] = useState(false);
  const [commentText, setCommentText] = useState("");
  const [newTicket, setNewTicket] = useState({ title: "", description: "", priority: "medium" as const, type: "task" as const });
  const [isTransferring, setIsTransferring] = useState(false);
  const [targetWs, setTargetWs] = useState("");
  
  // Chat State
  const [chatInput, setChatInput] = useState("");
  const chatScrollRef = useRef<HTMLDivElement>(null);

  const scrollRef = useRef<HTMLDivElement>(null);
  const selectedTicket = tickets?.find((t: any) => t._id === selectedTicketId) || null;
  const comments = useQuery(api.tickets.getComments, selectedTicketId ? { ticketId: selectedTicketId as any } : "skip");
  const events = useQuery(api.tickets.getEvents, selectedTicketId ? { ticketId: selectedTicketId as any } : "skip");

  const hasAdminRights = myPermissions?.isOverallAdmin || myPermissions?.workspaceRole === "admin";

  const handleTicketCreate = async () => {
    if (!newTicket.title.trim()) return;
    await createTicket({ companyId, workspaceId, ...newTicket });
    setIsModalOpen(false);
    setNewTicket({ title: "", description: "", priority: "medium", type: "task" });
  };

  const executeAction = async () => {
    if (!confirmAction || !selectedTicket) return;
    try {
      if (confirmAction.type === 'resolve') await resolveTicket({ ticketId: selectedTicket._id });
      if (confirmAction.type === 'reopen') await reopenTicket({ ticketId: selectedTicket._id });
      if (confirmAction.type === 'transfer' && confirmAction.targetId) {
        await transferTicket({ ticketId: selectedTicket._id, targetWorkspaceId: confirmAction.targetId as any });
        setIsTransferring(false);
        setTargetWs("");
      }
      setConfirmAction(null);
    } catch (e: any) { alert(e.message); }
  };

  const handleComment = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!commentText.trim() || !selectedTicket) return;
    try {
      await addComment({ ticketId: selectedTicket._id, content: commentText });
      setCommentText("");
      if(drawerTab === 'chat') setTimeout(() => scrollRef.current?.scrollIntoView({ behavior: "smooth" }), 100);
    } catch (e) { console.error(e); }
  };

  const handleSendChat = async (e: React.FormEvent) => {
    e.preventDefault();
    if(!chatInput.trim()) return;
    try {
        await sendChatMessage({ companyId, workspaceId, content: chatInput });
        setChatInput("");
        setTimeout(() => chatScrollRef.current?.scrollIntoView({ behavior: "smooth" }), 100);
    } catch(e) { console.error(e); }
  }

  const onFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    setIsUploading(true);
    try {
      const postUrl = await generateUploadUrl();
      const result = await fetch(postUrl, { method: "POST", headers: { "Content-Type": file.type }, body: file });
      const { storageId } = await result.json();
      await sendFile({ storageId, workspaceId, fileName: file.name, fileType: file.type });
    } catch (error) { console.error(error); } finally { setIsUploading(false); }
  };

  if (!tickets || !workspaces || myPermissions === undefined || !members) return (
    <div className="h-[60vh] flex flex-col items-center justify-center gap-4">
      <Loader2 className="w-8 h-8 text-accent animate-spin" />
    </div>
  );

  const highPriority = tickets.filter(t => t.priority === 'high' && t.status === 'open').length;
  const openCount = tickets.filter(t => t.status === 'open').length;
  const resolvedCount = tickets.filter(t => t.status === 'resolved').length;

  const KanbanColumn = ({ status, label }: { status: string, label: string }) => {
    const columnTickets = tickets.filter(t => t.status === status);
    return (
      <div className="flex-1 min-w-[300px] flex flex-col gap-4">
        <div className="flex items-center justify-between px-2">
          <h3 className="text-xs font-bold uppercase tracking-wider text-muted flex items-center gap-2">
            <span className={`w-2 h-2 rounded-full ${status === 'open' ? 'bg-blue-500' : status === 'resolved' ? 'bg-green-500' : 'bg-orange-500'}`} />
            {label} ({columnTickets.length})
          </h3>
        </div>
        <div className="flex-1 bg-foreground/[0.02] rounded-2xl p-2 space-y-3 min-h-[500px] border border-border/50">
          {columnTickets.map(ticket => (
            <div 
              key={ticket._id}
              onClick={() => setSelectedTicketId(ticket._id)}
              className="p-4 rounded-xl bg-background border border-border hover:border-accent/50 cursor-pointer shadow-sm group transition-all"
            >
              <div className="flex justify-between items-start mb-2">
                <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${
                  ticket.priority === 'high' ? 'bg-red-500/10 text-red-500' : 'bg-blue-500/10 text-blue-500'
                }`}>
                  {ticket.priority}
                </span>
              </div>
              <h4 className="text-sm font-bold text-foreground mb-2 line-clamp-2">{ticket.title}</h4>
              <div className="flex items-center justify-between mt-3 pt-3 border-t border-border/50">
                <div className="w-5 h-5 rounded-full bg-foreground/10 flex items-center justify-center text-[9px] font-bold">
                    {ticket.assignee?.name?.[0] || "?"}
                </div>
                <span className="text-[10px] text-muted">{new Date(ticket._creationTime).toLocaleDateString()}</span>
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  };

  return (
    <div className="max-w-7xl mx-auto space-y-8 pb-32 animate-in fade-in duration-700 font-sans h-full">
      
      {/* HEADER */}
      <header className="flex flex-col md:flex-row md:items-end justify-between border-b border-border pb-8 gap-6">
        <div className="space-y-2">
          <div className="flex items-center gap-2 text-accent font-bold text-[10px] uppercase tracking-wider mb-2">
             <div className="w-2 h-2 rounded-full bg-accent animate-pulse" /> Active Node
          </div>
          <h1 className="text-4xl font-semibold tracking-tight text-foreground">Workspace Hub</h1>
          <p className="text-muted text-lg font-normal">Manage departmental flows and assets.</p>
        </div>
        
        <div className="flex items-center gap-4">
            <div className="flex bg-foreground/5 p-1 rounded-xl">
                <button onClick={() => setActiveTab('overview')} className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${activeTab === 'overview' ? 'bg-background shadow-sm text-foreground' : 'text-muted hover:text-foreground'}`}>Overview</button>
                <button onClick={() => setActiveTab('board')} className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${activeTab === 'board' ? 'bg-background shadow-sm text-foreground' : 'text-muted hover:text-foreground'}`}>Board</button>
                <button onClick={() => setActiveTab('chat')} className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${activeTab === 'chat' ? 'bg-background shadow-sm text-foreground' : 'text-muted hover:text-foreground'}`}>Chat</button>
                <button onClick={() => setActiveTab('assets')} className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${activeTab === 'assets' ? 'bg-background shadow-sm text-foreground' : 'text-muted hover:text-foreground'}`}>Assets</button>
            </div>
            <button onClick={() => setIsModalOpen(true)} className="apple-button shadow-lg shadow-accent/20">
            <Plus className="w-5 h-5" /> New Ticket
            </button>
        </div>
      </header>

      {/* OVERVIEW TAB */}
      {activeTab === 'overview' && (
        <div className="space-y-8 animate-in fade-in">
            {/* MATRIX */}
            <section className="grid grid-cols-3 gap-4">
                <div className="glass-panel p-6 rounded-3xl flex items-center gap-4 border-border">
                    <div className="w-12 h-12 bg-red-500/10 rounded-2xl flex items-center justify-center text-red-600"><AlertCircle className="w-6 h-6" /></div>
                    <div><p className="text-2xl font-bold text-foreground">{highPriority}</p><p className="text-xs font-bold text-muted uppercase tracking-wider">Critical Load</p></div>
                </div>
                <div className="glass-panel p-6 rounded-3xl flex items-center gap-4 border-border">
                    <div className="w-12 h-12 bg-blue-500/10 rounded-2xl flex items-center justify-center text-blue-600"><BarChart3 className="w-6 h-6" /></div>
                    <div><p className="text-2xl font-bold text-foreground">{openCount}</p><p className="text-xs font-bold text-muted uppercase tracking-wider">Active Flows</p></div>
                </div>
                <div className="glass-panel p-6 rounded-3xl flex items-center gap-4 border-border">
                    <div className="w-12 h-12 bg-green-500/10 rounded-2xl flex items-center justify-center text-green-600"><Check className="w-6 h-6" /></div>
                    <div><p className="text-2xl font-bold text-foreground">{resolvedCount}</p><p className="text-xs font-bold text-muted uppercase tracking-wider">Resolved</p></div>
                </div>
            </section>

            {/* LIST */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {tickets.map((ticket) => (
                <div 
                    key={ticket._id} 
                    onClick={() => setSelectedTicketId(ticket._id)}
                    className="glass-panel p-6 rounded-3xl border border-border hover:border-accent/50 hover:bg-accent/[0.02] transition-all duration-300 cursor-pointer group shadow-sm hover:shadow-xl"
                >
                    <div className="flex items-center justify-between mb-6">
                    <span className={`px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider border ${
                        ticket.priority === "high" ? "bg-red-500/10 text-red-600 border-red-200 dark:border-red-900" : 
                        ticket.priority === "medium" ? "bg-orange-500/10 text-orange-600 border-orange-200 dark:border-orange-900" :
                        "bg-green-500/10 text-green-600 border-green-200 dark:border-green-900"
                    }`}>
                        {ticket.priority}
                    </span>
                    <div className="w-8 h-8 rounded-full bg-foreground/5 flex items-center justify-center text-muted group-hover:text-accent transition-colors">
                        <ChevronRight className="w-4 h-4" />
                    </div>
                    </div>
                    <h3 className="font-semibold text-lg text-foreground mb-2 truncate tracking-tight">{ticket.title}</h3>
                    <p className="text-muted text-sm font-normal line-clamp-2 mb-6 leading-relaxed">{ticket.description}</p>
                    <div className="flex items-center justify-between pt-4 border-t border-border">
                    <div className="flex items-center gap-2 text-muted text-[10px] font-bold uppercase tracking-wider">
                        <User className="w-3 h-3" /> {ticket.assignee ? ticket.assignee.name.split(' ')[0] : 'Unassigned'}
                    </div>
                    <span className={`text-[10px] font-bold uppercase tracking-wider ${
                        ticket.status === 'resolved' ? 'text-green-600' : 'text-accent'
                    }`}>
                        {ticket.status}
                    </span>
                    </div>
                </div>
                ))}
            </div>
        </div>
      )}

      {/* BOARD TAB (Kanban) */}
      {activeTab === 'board' && (
        <div className="flex gap-6 overflow-x-auto pb-6 animate-in fade-in">
            <KanbanColumn status="open" label="Backlog" />
            <KanbanColumn status="in_progress" label="In Progress" />
            <KanbanColumn status="resolved" label="Done" />
        </div>
      )}

      {/* CHAT TAB */}
      {activeTab === 'chat' && (
        <div className="h-[600px] flex flex-col glass-panel rounded-[32px] overflow-hidden border border-border animate-in fade-in">
            <div className="flex-1 overflow-y-auto p-6 space-y-4 flex flex-col-reverse bg-background/50">
                <div ref={chatScrollRef} />
                {chatMessages?.map((msg, idx) => {
                    const isMe = msg.user?.clerkId === clerkUser?.id;
                    return (
                        <div key={msg._id} className={`flex gap-3 ${isMe ? "flex-row-reverse" : "flex-row"}`}>
                            <div className="w-8 h-8 rounded-lg bg-foreground/5 flex items-center justify-center text-xs font-bold shrink-0">{msg.user?.name?.[0]}</div>
                            <div className={`max-w-[70%] px-4 py-2 rounded-2xl text-sm font-medium ${isMe ? "bg-accent text-white" : "bg-white dark:bg-white/10"}`}>
                                {msg.content}
                            </div>
                        </div>
                    )
                })}
            </div>
            <form onSubmit={handleSendChat} className="p-4 bg-background border-t border-border flex gap-2">
                <input 
                    className="flex-1 input-field" 
                    placeholder="Message workspace..." 
                    value={chatInput} 
                    onChange={(e) => setChatInput(e.target.value)} 
                />
                <button type="submit" className="p-3 bg-accent text-white rounded-xl shadow-lg hover:scale-105 transition-transform"><Send className="w-4 h-4" /></button>
            </form>
        </div>
      )}

      {/* ASSETS TAB */}
      {activeTab === 'assets' && (
        <div className="space-y-8 animate-in fade-in">
            <label className="relative glass-panel rounded-3xl border-2 border-dashed border-border p-8 flex flex-col items-center justify-center gap-4 cursor-pointer hover:border-accent hover:bg-accent/[0.02] transition-all group">
            <input type="file" className="hidden" onChange={onFileUpload} disabled={isUploading} />
            <div className="w-16 h-16 bg-background rounded-2xl flex items-center justify-center shadow-sm border border-border group-hover:scale-105 transition-transform">
                {isUploading ? <Loader2 className="w-6 h-6 text-accent animate-spin" /> : <UploadCloud className="w-6 h-6 text-accent" />}
            </div>
            <div className="text-center">
                <p className="text-sm font-semibold text-foreground">Upload Asset</p>
                <p className="text-xs text-muted font-medium mt-1">Drag & drop or click to browse</p>
            </div>
            </label>

            <div className="space-y-4">
            {assets?.map((asset) => (
                <div key={asset._id} className="flex items-center gap-4 p-4 glass-panel rounded-2xl border border-border hover:bg-foreground/5 transition-all group">
                <div className="w-10 h-10 bg-accent/10 rounded-xl flex items-center justify-center border border-accent/20">
                    <FileIcon className="w-5 h-5 text-accent" />
                </div>
                <div className="flex-1 min-w-0">
                    <p className="text-sm font-semibold text-foreground truncate">{asset.fileName}</p>
                    <p className="text-[10px] text-muted font-bold uppercase tracking-wider mt-0.5">{asset.fileType.split('/')[1]}</p>
                </div>
                <a href={asset.url || "#"} target="_blank" className="p-2 text-muted hover:text-accent transition-colors rounded-lg hover:bg-accent/10">
                    <Download className="w-4 h-4" />
                </a>
                </div>
            ))}
            </div>
        </div>
      )}

      {/* TICKET DRAWER & CONFIRM MODALS (Reused from original) */}
      {selectedTicket && (
        <div className="fixed inset-0 z-[150] flex items-center justify-end bg-black/40 backdrop-blur-md p-4 transition-all">
          <div className="glass-panel w-full max-w-4xl h-full rounded-[32px] shadow-2xl animate-in slide-in-from-right duration-500 overflow-hidden flex flex-col border-border bg-background">
            
            {confirmAction && (
              <div className="absolute inset-0 z-[200] bg-background/80 backdrop-blur-sm flex items-center justify-center p-4">
                <div className="bg-background border border-border p-8 rounded-3xl shadow-2xl max-w-sm w-full animate-in zoom-in-95">
                  <div className="w-12 h-12 bg-red-500/10 text-red-500 rounded-xl flex items-center justify-center mb-4 mx-auto">
                    <AlertTriangle className="w-6 h-6" />
                  </div>
                  <h3 className="text-center text-lg font-bold text-foreground mb-2">Confirm Action</h3>
                  <p className="text-center text-sm text-muted mb-6">Are you sure you want to <strong>{confirmAction.type}</strong> this ticket?</p>
                  <div className="flex gap-3">
                    <button onClick={() => setConfirmAction(null)} className="flex-1 py-2 rounded-xl border border-border text-xs font-bold uppercase hover:bg-foreground/5">Cancel</button>
                    <button onClick={executeAction} className="flex-1 py-2 rounded-xl bg-red-500 text-white text-xs font-bold uppercase shadow-lg shadow-red-500/20 hover:bg-red-600">Confirm</button>
                  </div>
                </div>
              </div>
            )}

            <header className="px-8 py-5 border-b border-border bg-background/50 backdrop-blur-xl flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="w-10 h-10 bg-accent/10 rounded-xl flex items-center justify-center text-accent border border-accent/20">
                  <Hash className="w-5 h-5" />
                </div>
                <div>
                  <div className="flex items-center gap-2 mb-1">
                    <span className="text-[10px] font-bold uppercase tracking-wider text-muted">ID: {selectedTicket._id.substring(0,8)}</span>
                    <span className={`text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-full ${selectedTicket.status === 'open' ? 'bg-accent/10 text-accent' : 'bg-green-500/10 text-green-600'}`}>{selectedTicket.status}</span>
                  </div>
                  <h2 className="text-xl font-bold text-foreground truncate w-96 tracking-tight">{selectedTicket.title}</h2>
                </div>
              </div>
              <button onClick={() => setSelectedTicketId(null)} className="p-2 hover:bg-foreground/5 rounded-full text-muted hover:text-foreground">
                <X className="w-6 h-6" />
              </button>
            </header>

            <div className="flex-1 flex overflow-hidden">
              <div className="flex-1 flex flex-col border-r border-border min-w-0">
                <div className="flex items-center border-b border-border px-8">
                  <button onClick={() => setDrawerTab('chat')} className={`py-4 text-xs font-bold uppercase tracking-wider border-b-2 px-4 transition-all ${drawerTab === 'chat' ? 'border-accent text-foreground' : 'border-transparent text-muted'}`}>Discussion</button>
                  <button onClick={() => setDrawerTab('audit')} className={`py-4 text-xs font-bold uppercase tracking-wider border-b-2 px-4 transition-all ${drawerTab === 'audit' ? 'border-accent text-foreground' : 'border-transparent text-muted'}`}>Audit Log</button>
                </div>

                <div className="flex-1 overflow-y-auto p-8 custom-scrollbar">
                  {drawerTab === 'chat' ? (
                    <div className="space-y-6">
                      <div className="p-6 bg-foreground/[0.02] rounded-2xl border border-border">
                        <p className="text-foreground text-sm leading-relaxed whitespace-pre-wrap">{selectedTicket.description}</p>
                      </div>
                      <div className="space-y-2 flex flex-col">
                        {comments?.map((c) => (
                          <div key={c._id} className={`flex gap-3 ${c.author?.clerkId === clerkUser?.id ? "flex-row-reverse" : "flex-row"}`}>
                            <div className="w-8 h-8 rounded-lg bg-foreground/5 flex items-center justify-center text-xs font-bold text-muted shrink-0">{c.author?.name?.[0]}</div>
                            <div className={`max-w-[80%] ${c.author?.clerkId === clerkUser?.id ? "items-end" : "items-start"} flex flex-col`}>
                              <div className={`px-4 py-2.5 rounded-2xl text-sm font-medium leading-relaxed border ${c.author?.clerkId === clerkUser?.id ? "bg-accent text-white border-accent/50 rounded-tr-sm" : "bg-white dark:bg-white/5 text-foreground border-border rounded-tl-sm"}`}>{c.content}</div>
                            </div>
                          </div>
                        ))}
                        <div ref={scrollRef} />
                      </div>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {events?.map((e, idx) => (
                        <div key={idx} className="flex gap-4 p-4 rounded-xl bg-foreground/[0.02] border border-border">
                          <div className="mt-1">
                            {e.type === 'created' && <Plus className="w-4 h-4 text-blue-500" />}
                            {e.type.includes('update') && <RefreshCw className="w-4 h-4 text-muted" />}
                          </div>
                          <div>
                            <p className="text-sm font-medium text-foreground">{e.metadata}</p>
                            <span className="text-[10px] text-muted opacity-50">{new Date(e._creationTime).toLocaleString()} â€¢ {e.actor?.name}</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {drawerTab === 'chat' && (
                  <form onSubmit={handleComment} className="p-4 border-t border-border bg-background/50 backdrop-blur-md">
                    <div className="flex gap-2">
                      <input placeholder="Transmit update..." className="input-field py-2.5 text-sm" value={commentText} onChange={(e) => setCommentText(e.target.value)} />
                      <button type="submit" className="p-3 bg-accent hover:bg-accent/90 text-white rounded-xl shadow-lg shadow-accent/20"><Send className="w-4 h-4" /></button>
                    </div>
                  </form>
                )}
              </div>

              {/* SIDEBAR META */}
              <div className={`w-80 bg-background/50 backdrop-blur-xl p-6 space-y-8 overflow-y-auto custom-scrollbar ${!hasAdminRights && "opacity-60 pointer-events-none grayscale"}`}>
                <div className="space-y-4">
                  <h3 className="text-xs font-bold text-muted uppercase tracking-wider flex items-center gap-2"><Flag className="w-3.5 h-3.5" /> Classification</h3>
                  <div className="flex bg-foreground/5 p-1 rounded-xl">
                    {['low', 'medium', 'high'].map((p) => (
                      <button key={p} onClick={() => updatePriority({ ticketId: selectedTicket._id, priority: p as any })} className={`flex-1 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all ${selectedTicket.priority === p ? 'bg-white shadow-sm text-foreground' : 'text-muted'}`}>{p}</button>
                    ))}
                  </div>
                </div>

                <div className="space-y-4">
                  <h3 className="text-xs font-bold text-muted uppercase tracking-wider flex items-center gap-2"><User className="w-3.5 h-3.5" /> Assignment</h3>
                  <select className="w-full bg-background border border-border rounded-xl px-3 py-2 text-sm" value={selectedTicket.assigneeId || ""} onChange={(e) => assignTicket({ ticketId: selectedTicket._id, assigneeId: e.target.value === "" ? undefined : e.target.value as any })}>
                    <option value="">Unassigned</option>
                    {members?.map((m: any) => <option key={m.user._id} value={m.user._id}>{m.user.name}</option>)}
                  </select>
                </div>

                <div className="space-y-4">
                  <h3 className="text-xs font-bold text-muted uppercase tracking-wider flex items-center gap-2"><Clock className="w-3.5 h-3.5" /> Target Date</h3>
                  <input type="date" className="w-full bg-background border border-border rounded-xl px-3 py-2 text-sm" value={selectedTicket.dueDate ? new Date(selectedTicket.dueDate).toISOString().split('T')[0] : ""} onChange={(e) => setDueDate({ ticketId: selectedTicket._id, dueDate: e.target.value ? new Date(e.target.value).getTime() : undefined })} />
                </div>

                <div className="pt-6 border-t border-border space-y-3">
                  <h3 className="text-xs font-bold text-muted uppercase tracking-wider flex items-center gap-2"><AlertCircle className="w-3.5 h-3.5" /> Controls</h3>
                  {hasAdminRights ? (
                    <>
                      {selectedTicket.status === 'open' ? (
                        <button onClick={() => setConfirmAction({type: 'resolve'})} className="w-full py-2 bg-green-500/10 text-green-600 border border-green-500/20 rounded-xl text-xs font-bold uppercase hover:bg-green-500 hover:text-white transition-all">Mark Resolved</button>
                      ) : (
                        <button onClick={() => setConfirmAction({type: 'reopen'})} className="w-full py-2 bg-foreground/5 text-foreground border border-border rounded-xl text-xs font-bold uppercase hover:bg-foreground/10 transition-all flex items-center justify-center gap-2"><RefreshCw className="w-3 h-3" /> Reopen</button>
                      )}
                      {!isTransferring ? (
                        <button onClick={() => setIsTransferring(true)} className="w-full py-2 bg-background border border-border text-muted rounded-xl text-xs font-bold uppercase hover:border-accent hover:text-accent transition-all">Transfer Node</button>
                      ) : (
                        <div className="space-y-2 animate-in fade-in">
                          <select className="w-full bg-background border border-border rounded-xl px-2 py-1.5 text-xs" onChange={(e) => setTargetWs(e.target.value)}>
                            <option value="">Select Department...</option>
                            {workspaces?.filter(ws => ws._id !== workspaceId).map(ws => (
                              <option key={ws._id} value={ws._id}>{ws.emoji} {ws.name}</option>
                            ))}
                          </select>
                          <div className="flex gap-2">
                            <button onClick={() => setIsTransferring(false)} className="flex-1 py-1 bg-foreground/5 rounded-lg text-[10px] font-bold uppercase">Cancel</button>
                            <button onClick={() => setConfirmAction({type: 'transfer', targetId: targetWs})} disabled={!targetWs} className="flex-1 py-1 bg-accent text-white rounded-lg text-[10px] font-bold uppercase">Confirm</button>
                          </div>
                        </div>
                      )}
                    </>
                  ) : (
                    <p className="text-xs text-center text-muted font-medium bg-foreground/5 p-2 rounded-lg">Admin access required for critical actions.</p>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* NEW FLOW MODAL */}
      {isModalOpen && (
        <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/60 backdrop-blur-xl p-4 animate-in fade-in duration-200">
          <div className="glass-panel max-w-lg w-full p-8 rounded-[40px] shadow-2xl border-border bg-background relative animate-in zoom-in-95 duration-200">
            <button onClick={() => setIsModalOpen(false)} className="absolute top-6 right-6 p-2 bg-foreground/5 rounded-full hover:bg-foreground/10 transition-colors">
               <X className="w-4 h-4 text-foreground" />
            </button>
            <div className="mb-8"><h2 className="text-2xl font-bold text-foreground tracking-tight mb-2">Create Ticket</h2><p className="text-muted text-sm font-normal">Define the requirements for this operation.</p></div>
            <div className="space-y-6">
              <div className="space-y-2"><label className="text-xs font-bold text-muted uppercase tracking-wider ml-1">Title</label><input placeholder="E.g. Update Security Protocol" className="input-field" value={newTicket.title} onChange={(e) => setNewTicket({...newTicket, title: e.target.value})} autoFocus /></div>
              <div className="space-y-2"><label className="text-xs font-bold text-muted uppercase tracking-wider ml-1">Type</label><div className="flex gap-2">{['task', 'bug', 'feature'].map((t) => (<button key={t} onClick={() => setNewTicket({...newTicket, type: t as any})} className={`flex-1 py-2 rounded-xl text-xs font-bold uppercase tracking-wider border transition-all ${newTicket.type === t ? 'bg-accent text-white border-accent' : 'bg-background text-muted border-border hover:border-accent/50'}`}>{t}</button>))}</div></div>
              <div className="space-y-2"><label className="text-xs font-bold text-muted uppercase tracking-wider ml-1">Description</label><textarea placeholder="Detailed requirements..." className="input-field h-32 resize-none leading-relaxed" value={newTicket.description} onChange={(e) => setNewTicket({...newTicket, description: e.target.value})} /></div>
              <div className="space-y-2"><label className="text-xs font-bold text-muted uppercase tracking-wider ml-1">Priority Level</label><div className="flex gap-2">{['low', 'medium', 'high'].map((p) => (<button key={p} onClick={() => setNewTicket({...newTicket, priority: p as any})} className={`flex-1 py-2 rounded-xl text-xs font-bold uppercase tracking-wider border transition-all ${newTicket.priority === p ? 'bg-accent text-white border-accent' : 'bg-background text-muted border-border hover:border-accent/50'}`}>{p}</button>))}</div></div>
              <div className="pt-4"><button onClick={handleTicketCreate} className="apple-button w-full shadow-lg shadow-accent/20">Create Ticket</button></div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/app/onboarding/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { useMutation, useQuery } from "convex/react";
import { api } from "../../../convex/_generated/api";
import { useRouter } from "next/navigation";
import { SignOutButton, useUser } from "@clerk/nextjs";
import { useTheme } from "next-themes";
import { Plus, Search, ArrowRight, Loader2, LogOut, CheckCircle2, AlertCircle, Sun, Moon, LayoutGrid } from "lucide-react";
import { Id } from "../../../convex/_generated/dataModel";

export default function OnboardingPage() {
  const [companyName, setCompanyName] = useState("");
  const [isCreating, setIsCreating] = useState(false);
  const [requestStatus, setRequestStatus] = useState<Record<string, string>>({});
  
  const createCompany = useMutation(api.companies.create);
  const requestAccess = useMutation(api.companies.requestAccess);
  const companies = useQuery(api.companies.getAll);
  const myMemberships = useQuery(api.companies.getMyMemberships);
  
  const router = useRouter();
  const { user } = useUser();
  const { theme, setTheme } = useTheme();
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  const handleCreate = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!companyName.trim()) return;
    
    setIsCreating(true);
    try {
      const result = await createCompany({ name: companyName });
      router.push(`/dashboard/${result.companyId}/ws/${result.workspaceId}`);
    } catch (error) {
      console.error("Failed to create company:", error);
      setIsCreating(false);
    }
  };

  const handleJoin = async (companyId: string) => {
    setRequestStatus(prev => ({ ...prev, [companyId]: 'loading' }));
    try {
      // FIX: Explicitly cast the string to the Convex ID type
      await requestAccess({ companyId: companyId as Id<"companies"> });
      setRequestStatus(prev => ({ ...prev, [companyId]: 'success' }));
    } catch (error: any) {
      if (error.message.includes("Membership already exists")) {
        setRequestStatus(prev => ({ ...prev, [companyId]: 'joined' }));
      } else {
        setRequestStatus(prev => ({ ...prev, [companyId]: 'error' }));
        alert("Could not join: " + error.message);
      }
    }
  };

  const handleEnter = (companyId: string) => {
    router.push(`/dashboard/${companyId}`);
  };

  if (!mounted) return null;

  return (
    <div className="min-h-screen bg-background text-foreground p-8 flex flex-col items-center relative transition-colors duration-500 font-sans">
      
      {/* HEADER CONTROLS */}
      <div className="absolute top-6 right-8 z-50 flex items-center gap-3">
        <button 
          onClick={() => setTheme(theme === "dark" ? "light" : "dark")}
          className="p-2.5 rounded-xl bg-background border border-border hover:bg-foreground/5 transition-colors text-muted"
        >
          {theme === "dark" ? <Sun className="w-4 h-4" /> : <Moon className="w-4 h-4" />}
        </button>

        <SignOutButton>
          <button className="flex items-center gap-2 text-sm font-bold text-muted hover:text-red-500 transition-colors bg-background px-4 py-2 rounded-xl border border-border shadow-sm cursor-pointer hover:bg-red-500/5">
            <LogOut className="w-4 h-4" />
            Sign Out
          </button>
        </SignOutButton>
      </div>

      <div className="max-w-4xl w-full mt-10">
        <header className="mb-12 text-center">
          <h1 className="text-3xl font-bold tracking-tight text-foreground">Setup your workspace</h1>
          <p className="text-muted mt-2 italic font-medium">Axovanth Enterprise Initialization</p>
          <div className="mt-4 inline-block px-4 py-1 bg-accent/10 text-accent rounded-full text-xs font-bold uppercase tracking-widest border border-accent/20">
            Identity: {user?.fullName || "Verified User"}
          </div>
        </header>

        <div className="grid md:grid-cols-2 gap-8">
          {/* Create Company Section */}
          <div className="glass-panel p-8 rounded-[32px] flex flex-col h-full shadow-sm border border-border hover:border-accent/30 transition-all">
            <div className="w-12 h-12 bg-accent/10 rounded-2xl flex items-center justify-center mb-6 border border-accent/20">
              <Plus className="text-accent w-6 h-6" />
            </div>
            <h2 className="text-xl font-bold mb-2 text-foreground">Create Organization</h2>
            <p className="text-sm text-muted font-medium mb-8">Establish a new multi-tenant instance for your team.</p>
            
            <form onSubmit={handleCreate} className="mt-auto">
              <input
                type="text"
                placeholder="Company Name"
                className="input-field mb-4"
                value={companyName}
                onChange={(e) => setCompanyName(e.target.value)}
                disabled={isCreating}
              />
              <button 
                type="submit" 
                className="apple-button w-full cursor-pointer disabled:cursor-not-allowed disabled:opacity-50 shadow-lg shadow-accent/20"
                disabled={isCreating || !companyName.trim()}
              >
                {isCreating ? <Loader2 className="animate-spin w-4 h-4" /> : "Create Workspace"}
                {!isCreating && <ArrowRight className="w-4 h-4 ml-2" />}
              </button>
            </form>
          </div>

          {/* Join Company Section */}
          <div className="glass-panel p-8 rounded-[32px] flex flex-col h-full shadow-sm border border-border hover:border-accent/30 transition-all">
            <div className="w-12 h-12 bg-foreground/5 rounded-2xl flex items-center justify-center mb-6 border border-border">
              <Search className="text-muted w-6 h-6" />
            </div>
            <h2 className="text-xl font-bold mb-2 text-foreground">Join Organization</h2>
            <p className="text-sm text-muted font-medium mb-4">Discovery: Browse and request access to an existing organization.</p>
            
            <div className="space-y-3 overflow-y-auto max-h-[250px] pr-2 custom-scrollbar">
              {companies === undefined || myMemberships === undefined ? (
                <div className="animate-pulse space-y-3">
                  {[1, 2].map((i) => <div key={i} className="h-16 bg-foreground/5 rounded-2xl w-full" />)}
                </div>
              ) : companies.length === 0 ? (
                <p className="text-center text-muted py-10 text-sm italic">No organizations found</p>
              ) : (
                companies.map((company) => {
                   const membership = myMemberships.find(m => m.companyId === company._id);
                   const status = requestStatus[company._id] || 'idle';
                   const isJoined = status === 'joined' || status === 'success';
                   
                   const isMember = membership?.status === "active";
                   const isPending = membership?.status === "pending" || isJoined;

                   return (
                    <div 
                      key={company._id} 
                      className="flex items-center justify-between p-4 bg-background rounded-2xl border border-border hover:border-accent/50 transition-all group"
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-foreground/5 rounded-xl flex items-center justify-center font-bold text-muted uppercase text-xs border border-border">
                          {company.name.substring(0, 2)}
                        </div>
                        <span className="font-bold text-foreground text-sm">{company.name}</span>
                      </div>
                      
                      {isMember ? (
                        <button 
                          onClick={() => handleEnter(company._id)}
                          className="text-xs font-bold uppercase tracking-wider flex items-center gap-1 px-3 py-1.5 rounded-lg transition-all text-green-600 bg-green-500/10 hover:bg-green-500/20 cursor-pointer"
                        >
                          Launch <LayoutGrid className="w-3 h-3" />
                        </button>
                      ) : (
                        <button 
                          onClick={() => !isPending && handleJoin(company._id)}
                          disabled={status === 'loading' || isPending}
                          className={`text-xs font-bold uppercase tracking-wider flex items-center gap-1 px-3 py-1.5 rounded-lg transition-all
                            ${isPending 
                              ? "text-orange-500 bg-orange-500/10 cursor-not-allowed" 
                              : "text-accent hover:bg-accent/10 opacity-0 group-hover:opacity-100 cursor-pointer"
                            }
                          `}
                        >
                          {status === 'loading' && <Loader2 className="w-3 h-3 animate-spin" />}
                          {isPending && <>Pending <CheckCircle2 className="w-3 h-3" /></>}
                          {!isPending && status === 'idle' && <>Request <ArrowRight className="w-3 h-3" /></>}
                          {status === 'error' && <AlertCircle className="w-3 h-3 text-red-500" />}
                        </button>
                      )}
                    </div>
                  );
                })
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./src/*"
      ]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts",
    "convex/auth.config.js"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="src/app/dashboard/[companyId]/layout.tsx">
"use client";

import { useState, useEffect } from "react";
import { useQuery, useMutation } from "convex/react";
import { api } from "../../../../convex/_generated/api";
import { useParams, useRouter, usePathname } from "next/navigation";
import { useTheme } from "next-themes";
import { 
  PlusCircle, Ticket, FolderRoot, ChevronRight, MessageSquare,
  ShieldAlert, Building2, Layers, Search, Command, Globe, Zap, Loader2,
  Menu, X, Sun, Moon, Settings, LogOut, Lock, ArrowRight, UserCog,
  // IMPORT NEW ICONS FOR WORKSPACES
  Terminal, TrendingUp, BadgeDollarSign, Palette, Scale, Users, Settings2,
  LifeBuoy, Rocket, Database, Briefcase, Bug, ShieldCheck, Box, FolderKanban
} from "lucide-react";
import { UserButton, SignOutButton } from "@clerk/nextjs";
import { Id } from "../../../../convex/_generated/dataModel";

// Icon Mapping Registry
const WorkspaceIconMap: Record<string, any> = {
  Terminal, TrendingUp, BadgeDollarSign, Palette, Scale, Users, 
  Settings2, LifeBuoy, Rocket, Database, Briefcase, Bug, ShieldCheck, Box, FolderKanban
};

export default function DashboardLayout({ children }: { children: React.ReactNode }) {
  const params = useParams();
  const router = useRouter();
  const pathname = usePathname();
  const { theme, setTheme } = useTheme();
  const companyId = params.companyId as any;

  const [isSearchOpen, setIsSearchOpen] = useState(false);
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  
  // Modal State for Locked Workspaces
  const [accessRequestModal, setAccessRequestModal] = useState<{
    isOpen: boolean;
    workspaceId: Id<"workspaces"> | null;
    workspaceName: string;
  }>({ isOpen: false, workspaceId: null, workspaceName: "" });

  const company = useQuery(api.companies.getById, { id: companyId });
  const workspaces = useQuery(api.workspaces.getByCompany, { companyId });
  const userMember = useQuery(api.companies.getMemberRecord, { companyId });
  
  // Lock Logic
  const myWsIds = useQuery(api.workspaces.getMyMemberships, { companyId });
  const requestAccess = useMutation(api.workspaces.requestAccess);

  useEffect(() => {
    const down = (e: KeyboardEvent) => {
      if (e.key === "k" && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        setIsSearchOpen((open) => !open);
      }
    };
    document.addEventListener("keydown", down);
    return () => document.removeEventListener("keydown", down);
  }, []);

  const handleLockClick = (wsId: Id<"workspaces">, wsName: string) => {
    setAccessRequestModal({ isOpen: true, workspaceId: wsId, workspaceName: wsName });
  };

  const confirmRequest = async () => {
    if (!accessRequestModal.workspaceId) return;
    try {
      await requestAccess({ workspaceId: accessRequestModal.workspaceId });
      alert("Request transmitted to workspace administrators.");
      setAccessRequestModal({ isOpen: false, workspaceId: null, workspaceName: "" });
    } catch (e: any) {
      alert(e.message);
    }
  };

  if (!company || !workspaces || !myWsIds) return (
    <div className="h-screen w-full flex items-center justify-center bg-background">
      <Loader2 className="w-6 h-6 animate-spin text-accent" />
    </div>
  );

  const defaultWsId = workspaces.find(w => w.isDefault)?._id || workspaces[0]?._id;

  // Helper function to resolve icon string to component
  const getWsIcon = (iconName: string) => {
    return WorkspaceIconMap[iconName] || Layers; // Fallback to Layers
  };

  const NavItem = ({ icon: Icon, label, href, active, badge, locked, onClick }: any) => (
    <button
      onClick={() => {
        if (locked) {
          onClick();
        } else {
          router.push(href);
          setIsSidebarOpen(false);
        }
      }}
      className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all duration-300 group cursor-pointer ${
        active 
          ? "bg-white dark:bg-white/10 shadow-sm text-accent ring-1 ring-black/5 dark:ring-white/5" 
          : "text-muted hover:bg-white/50 dark:hover:bg-white/5 hover:text-foreground"
      } ${locked ? "opacity-70 grayscale" : ""}`}
    >
      {locked ? <Lock className="w-4 h-4 text-muted" /> : <Icon className={`w-4 h-4 ${active ? "text-accent" : "opacity-50 group-hover:opacity-100"}`} />}
      <span className="flex-1 text-left truncate">{label}</span>
      {badge && <span className="bg-accent/10 text-accent px-1.5 py-0.5 rounded-lg text-[10px] font-bold">{badge}</span>}
    </button>
  );

  return (
    <div className="flex h-screen bg-background overflow-hidden font-sans">
      
      {/* ---------------------------------------------------------------------- */}
      {/* ACCESS REQUEST MODAL */}
      {/* ---------------------------------------------------------------------- */}
      {accessRequestModal.isOpen && (
        <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/60 backdrop-blur-md p-4 animate-in fade-in duration-200">
          <div className="glass-panel max-w-sm w-full p-8 rounded-[32px] shadow-2xl border-border bg-background relative animate-in zoom-in-95">
            <button 
              onClick={() => setAccessRequestModal({ ...accessRequestModal, isOpen: false })} 
              className="absolute top-4 right-4 p-2 bg-foreground/5 rounded-full hover:bg-foreground/10 transition-colors"
            >
              <X className="w-4 h-4 text-foreground" />
            </button>
            
            <div className="w-12 h-12 bg-accent/10 text-accent rounded-2xl flex items-center justify-center mb-6 mx-auto border border-accent/20">
              <Lock className="w-6 h-6" />
            </div>
            
            <div className="text-center mb-8">
              <h3 className="text-xl font-bold mb-2 text-foreground tracking-tight">Restricted Access</h3>
              <p className="text-muted text-sm leading-relaxed px-2 font-normal">
                You do not have clearance for <span className="font-bold text-foreground">{accessRequestModal.workspaceName}</span>.
                Request entry from the administrators?
              </p>
            </div>
            
            <button 
              onClick={confirmRequest} 
              className="apple-button w-full justify-center shadow-lg shadow-accent/20 mb-3"
            >
              Send Access Request <ArrowRight className="w-4 h-4 ml-2" />
            </button>
            
            <button 
              onClick={() => setAccessRequestModal({ ...accessRequestModal, isOpen: false })} 
              className="w-full py-3 rounded-xl bg-foreground/5 font-semibold text-xs uppercase tracking-wider border border-border hover:bg-foreground/10 transition-colors"
            >
              Cancel
            </button>
          </div>
        </div>
      )}

      {/* OMNIBAR */}
      {isSearchOpen && (
        <div className="fixed inset-0 z-[100] flex items-start justify-center pt-[15vh] bg-black/40 backdrop-blur-md p-4">
          <div className="glass-panel w-full max-w-xl rounded-3xl shadow-2xl border border-white/10 overflow-hidden animate-in fade-in zoom-in duration-200">
            <div className="p-4 flex items-center gap-3 border-b border-white/5">
              <Search className="w-5 h-5 text-muted" />
              <input autoFocus placeholder="Search Axovanth..." className="bg-transparent border-none outline-none w-full text-lg font-medium text-foreground" />
              <div className="px-2 py-1 bg-foreground/5 rounded text-[10px] font-bold text-muted">ESC</div>
            </div>
            <div className="p-4 space-y-1">
              <div className="text-[10px] font-bold text-muted uppercase tracking-widest px-2 mb-2">Quick Actions</div>
              <button onClick={() => { setIsSearchOpen(false); router.push(`/dashboard/${companyId}/admin`); }} className="w-full flex items-center gap-3 p-3 hover:bg-accent hover:text-white rounded-2xl transition-all group cursor-pointer">
                <ShieldAlert className="w-4 h-4" />
                <span className="text-sm font-bold text-foreground group-hover:text-white">Jump to Admin Center</span>
              </button>
            </div>
          </div>
        </div>
      )}

      {/* SIDEBAR */}
      <aside className={`
        fixed inset-y-0 left-0 z-40 w-72 m-4 lg:relative lg:flex lg:m-4 
        glass-panel rounded-[32px] flex-col transition-all duration-500 border border-black/5 dark:border-white/10
        ${isSidebarOpen ? "translate-x-0" : "-translate-x-[120%] lg:translate-x-0"}
      `}>
        <div className="p-6 flex items-center justify-between border-b border-black/5 dark:border-white/5">
          <div className="flex items-center gap-3">
             <div className="w-10 h-10 bg-accent rounded-2xl flex items-center justify-center overflow-hidden border border-accent/20 shadow-lg shadow-accent/20">
               {company.logoUrl ? <img src={company.logoUrl} className="w-full h-full object-cover" /> : <span className="text-white font-bold">{company.name.substring(0, 1).toUpperCase()}</span>}
             </div>
             <div className="min-w-0">
               <h2 className="font-bold text-foreground text-sm truncate leading-tight">{company.name}</h2>
               {/* RENAMED: Premium OS -> Premium Platform */}
               <span className="text-[10px] text-accent font-bold uppercase tracking-widest">
                 Premium Platform
               </span>
             </div>
          </div>
        </div>

        <div className="p-3">
          <button 
            onClick={() => setIsSearchOpen(true)}
            className="w-full flex items-center justify-between px-3 py-2 bg-gray-100/50 hover:bg-gray-100 dark:bg-white/5 dark:hover:bg-white/10 rounded-xl transition-all group cursor-pointer"
          >
            <div className="flex items-center gap-2 text-gray-400">
              <Search className="w-3.5 h-3.5" />
              <span className="text-xs font-medium">Command + K</span>
            </div>
            <Command className="w-3 h-3 text-gray-300" />
          </button>
        </div>

        <nav className="flex-1 p-4 space-y-8 overflow-y-auto custom-scrollbar">
          {/* DEPARTMENTS SECTION */}
          <div className="space-y-1">
            <span className="text-[10px] font-bold text-muted uppercase tracking-widest px-3 mb-2 block">Departments</span>
            {workspaces.map(ws => {
              const isLocked = !myWsIds.includes(ws._id);
              // DYNAMIC ICON LOOKUP
              const WsIcon = getWsIcon(ws.emoji);

              return (
                <NavItem 
                  key={ws._id} 
                  icon={WsIcon} 
                  label={ws.name} 
                  href={`/dashboard/${companyId}/ws/${ws._id}`} 
                  active={pathname === `/dashboard/${companyId}/ws/${ws._id}`}
                  locked={isLocked}
                  onClick={() => handleLockClick(ws._id, ws.name)}
                />
              );
            })}
          </div>

          {/* SYSTEM HUB SECTION */}
          <div className="space-y-1">
            <span className="text-[10px] font-bold text-muted uppercase tracking-widest px-3 mb-2 block">System Hub</span>
            <NavItem 
              icon={MessageSquare} 
              label="General Chat" 
              href={`/dashboard/${companyId}/chat`} 
              active={pathname.includes('/chat')}
              badge="Live" 
            />
            <NavItem 
              icon={Ticket} 
              label="Operation Flow" 
              href={`/dashboard/${companyId}/workflow`} 
              active={pathname.includes('/workflow')} 
            />
            <NavItem 
              icon={FolderRoot} 
              label="Asset Vault" 
              href={`/dashboard/${companyId}/assets`} 
              active={pathname.includes('/assets')}
            />
          </div>

          {/* ADMINISTRATION SECTION */}
          <div className="space-y-1">
            <span className="text-[10px] font-bold text-muted uppercase tracking-widest px-3 mb-2 block">Governance</span>
            
            {/* AVAILABLE TO ALL */}
            <NavItem 
              icon={Settings} 
              label="Settings" 
              href={`/dashboard/${companyId}/settings`} 
              active={pathname.includes("/settings")}
            />

            {/* ADMIN ONLY */}
            {userMember?.role === "admin" && (
              <NavItem 
                icon={ShieldAlert} 
                label="Admin Center" 
                href={`/dashboard/${companyId}/admin`} 
                active={pathname.includes("/admin")} 
              />
            )}
          </div>
        </nav>

        {/* BOTTOM SECTION WITH LOGOUT */}
        <div className="p-4 bg-foreground/[0.02] border-t border-black/5 dark:border-white/5 flex flex-col gap-3 rounded-b-[32px]">
          <div className="flex items-center justify-between">
             <div className="flex items-center gap-3">
              <UserButton appearance={{ elements: { avatarBox: "w-9 h-9 rounded-xl shadow-sm" } }} />
              <div className="hidden lg:block">
                <p className="text-xs font-bold text-foreground truncate w-24">Active Session</p>
                <p className="text-[9px] text-muted font-bold uppercase">v2.1.8-Premium</p>
              </div>
            </div>
            <button 
              onClick={() => setTheme(theme === "dark" ? "light" : "dark")}
              className="p-2.5 bg-background rounded-xl border border-black/5 dark:border-white/10 hover:scale-110 transition-transform active:scale-95 shadow-sm cursor-pointer"
            >
              {theme === "dark" ? <Sun className="w-4 h-4 text-orange-400" /> : <Moon className="w-4 h-4 text-accent" />}
            </button>
          </div>
          
          <SignOutButton>
             <button className="w-full flex items-center justify-center gap-2 p-3 rounded-xl bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white transition-all text-xs font-bold uppercase tracking-widest cursor-pointer">
               <LogOut className="w-3.5 h-3.5" /> Terminate Session
             </button>
          </SignOutButton>
        </div>
      </aside>

      <main className="flex-1 overflow-y-auto lg:p-12 p-6 pt-24 lg:pt-12 transition-all duration-500 relative z-0">
        <div className="max-w-7xl mx-auto">
          {children}
        </div>
      </main>
    </div>
  );
}
</file>

<file path="src/app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: #fbfbfd;
    --foreground: #1d1d1f;
    --glass: rgba(255, 255, 255, 0.75);
    --border: rgba(0, 0, 0, 0.08);
    --muted: #86868b;
    --accent: #0071e3;
    
    /* Font Variable Backup */
    --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }

  .dark {
    --background: #000000;
    --foreground: #f5f5f7;
    --glass: rgba(22, 22, 23, 0.8);
    --border: rgba(255, 255, 255, 0.15);
    --muted: #a1a1a6;
    --accent: #2997ff;
  }
}

@layer base {
  body {
    @apply bg-background text-foreground font-sans antialiased;
    font-feature-settings: "cv02", "cv03", "cv04", "cv11";
    transition: background-color 0.4s ease, color 0.4s ease;
  }
}

@layer components {
  .glass-panel {
    background: var(--glass);
    backdrop-filter: saturate(180%) blur(24px);
    -webkit-backdrop-filter: saturate(180%) blur(24px);
    border: 1px solid var(--border);
  }

  .apple-button {
    @apply px-6 py-3 rounded-full transition-all duration-300 active:scale-95 font-semibold flex items-center justify-center gap-2 text-white;
    background-color: var(--accent);
    font-size: 0.95rem; 
    letter-spacing: -0.01em;
  }
  
  .apple-button:hover {
    filter: brightness(1.1);
    box-shadow: 0 4px 12px rgba(0, 113, 227, 0.15);
  }

  .input-field {
    @apply w-full px-4 py-3.5 rounded-xl border bg-white/50 dark:bg-white/5 outline-none transition-all;
    border-color: var(--border);
    color: var(--foreground);
    font-size: 0.95rem;
  }

  .input-field:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1); 
  }
  
  /* Custom Scrollbar */
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: var(--muted);
    border-radius: 20px;
    opacity: 0.2;
  }
}
</file>

<file path="src/app/layout.tsx">
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import { ConvexClientProvider } from "@/components/providers/convex-provider";

// THE GOD-TIER FIX: Enforce Edge Runtime for the entire OS
export const runtime = "edge";

const inter = Inter({ 
  subsets: ["latin"],
  variable: "--font-inter", 
});

export const metadata: Metadata = {
  title: "Axovanth | Enterprise Workspace Platform",
  description: "Centralized company operations and role-based access control.",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body className={`${inter.variable} antialiased`}>
        <ConvexClientProvider>
          {children}
        </ConvexClientProvider>
      </body>
    </html>
  );
}
</file>

<file path="src/app/page.tsx">
"use client";

import { useConvexAuth, useMutation } from "convex/react";
import { api } from "../../convex/_generated/api";
import { SignInButton, SignedIn, SignedOut } from "@clerk/nextjs";
import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { useTheme } from "next-themes";
import { 
  ShieldCheck, Zap, Globe, Lock, ArrowRight, Sun, Moon, 
  LayoutGrid, Users, Command, Terminal, Cpu, CheckCircle2, Play, 
  Layers, BarChart3, Activity, Star, Code2, Database, Server, 
  Smartphone, MessageSquare, GitBranch, Workflow
} from "lucide-react";

export default function LandingPage() {
  const { isAuthenticated } = useConvexAuth();
  const storeUser = useMutation(api.users.store);
  const router = useRouter();
  const { theme, setTheme } = useTheme();
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
    if (isAuthenticated) {
      storeUser();
    }
  }, [isAuthenticated, storeUser]);

  if (!mounted) return null;

  return (
    <main className="min-h-screen bg-background text-foreground overflow-x-hidden font-sans selection:bg-blue-500/30">
      
      {/* NAVIGATION */}
      <nav className="fixed top-0 left-0 right-0 z-50 bg-background/80 backdrop-blur-xl transition-all border-b border-border/40 supports-[backdrop-filter]:bg-background/60">
        <div className="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
          <div className="flex items-center gap-3 cursor-pointer group" onClick={() => router.push("/")}>
            <div className="w-9 h-9 rounded-xl flex items-center justify-center transition-transform group-hover:scale-105 shadow-sm bg-zinc-900 dark:bg-white text-white dark:text-black border border-black/5 dark:border-white/10 overflow-hidden">
              <img src="/logo.png" alt="Axovanth Logo" className="w-full h-full object-cover" />
            </div>
            <span className="font-bold text-lg tracking-tight">Axovanth</span>
          </div>
          
          <div className="hidden md:flex items-center gap-8 text-sm font-medium text-muted-foreground">
            <a href="#features" className="hover:text-foreground transition-colors">Platform</a>
            <a href="#security" className="hover:text-foreground transition-colors">Security</a>
            {/* This link will now work */}
            <a href="#enterprise" className="hover:text-foreground transition-colors">Enterprise</a>
          </div>

          <div className="flex items-center gap-4">
            <button 
              onClick={() => setTheme(theme === "dark" ? "light" : "dark")}
              className="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors text-muted-foreground hover:text-foreground"
            >
              {theme === "dark" ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
            </button>

            <div className="h-5 w-px bg-border/50 hidden sm:block" />

            <SignedOut>
              <SignInButton mode="modal">
                <button className="text-sm font-semibold text-muted-foreground hover:text-foreground transition-colors px-2">Log In</button>
              </SignInButton>
              <SignInButton mode="modal">
                <button className="bg-zinc-900 hover:bg-zinc-800 text-white dark:bg-white dark:text-black dark:hover:bg-zinc-200 h-9 px-5 rounded-full text-sm font-bold shadow-lg transition-all transform hover:scale-105">
                  Get Started
                </button>
              </SignInButton>
            </SignedOut>
            
            <SignedIn>
              <button 
                onClick={() => router.push("/onboarding")}
                className="bg-blue-600 text-white hover:bg-blue-700 h-9 px-5 rounded-full text-sm font-bold shadow-lg shadow-blue-500/20 transition-all flex items-center gap-2"
              >
                Dashboard <ArrowRight className="w-4 h-4" />
              </button>
            </SignedIn>
          </div>
        </div>
      </nav>

      {/* HERO SECTION */}
      <section className="relative pt-24 pb-20 lg:pt-36 lg:pb-32 overflow-hidden">
        <div className="absolute top-0 left-1/2 -translate-x-1/2 w-[1000px] h-[600px] bg-blue-500/10 rounded-[100%] blur-[120px] -z-10 animate-pulse duration-[5000ms]" />
        
        <div className="max-w-5xl mx-auto px-6 text-center relative z-10">
          <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-blue-500/20 bg-blue-500/5 text-blue-600 dark:text-blue-400 text-[11px] font-bold uppercase tracking-widest mb-8 animate-in fade-in slide-in-from-bottom-4 duration-700">
            <span className="relative flex h-2 w-2">
              <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
              <span className="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
            </span>
            Axovanth 2.4 Enterprise
          </div>
          
          <h1 className="text-5xl md:text-7xl font-bold tracking-tight leading-[1.1] mb-8 animate-in fade-in slide-in-from-bottom-6 duration-1000 text-foreground">
            The Neural Network <br />
            for <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-indigo-500 to-purple-600 animate-gradient">Modern Enterprise.</span>
          </h1>
          
          <p className="text-lg md:text-xl text-muted-foreground max-w-2xl mx-auto leading-relaxed mb-10 font-medium animate-in fade-in slide-in-from-bottom-8 duration-1000 delay-100">
            Unified governance, granular access control, and seamless workflow automation. 
            Stop managing disjointed tools. Start commanding your organization.
          </p>

          <div className="flex flex-col sm:flex-row items-center justify-center gap-4 animate-in fade-in slide-in-from-bottom-10 duration-1000 delay-200">
            <SignedOut>
              <SignInButton mode="modal">
                <button className="h-12 px-8 rounded-full bg-blue-600 hover:bg-blue-700 text-white font-bold text-sm transition-all shadow-xl shadow-blue-600/20 flex items-center gap-2 group hover:scale-105 active:scale-95">
                  Initialize System <ArrowRight className="w-4 h-4 group-hover:translate-x-1 transition-transform" />
                </button>
              </SignInButton>
              <button className="h-12 px-8 rounded-full bg-transparent border border-zinc-200 dark:border-zinc-700 hover:bg-zinc-100 dark:hover:bg-zinc-800 text-foreground font-bold text-sm transition-all flex items-center gap-2">
                <Play className="w-4 h-4 fill-current" /> Watch Demo
              </button>
            </SignedOut>
            <SignedIn>
              <button 
                onClick={() => router.push("/onboarding")}
                className="h-12 px-8 rounded-full bg-blue-600 hover:bg-blue-700 text-white font-bold text-sm transition-all shadow-xl shadow-blue-600/20 flex items-center gap-2 group"
              >
                Launch Console <ArrowRight className="w-4 h-4 group-hover:translate-x-1 transition-transform" />
              </button>
            </SignedIn>
          </div>

          <div className="mt-12 flex flex-col items-center justify-center gap-4 opacity-100 transition-all duration-500">
             <p className="text-[10px] font-bold text-muted-foreground uppercase tracking-widest">Trusted by innovative teams at</p>
             <div className="flex items-center gap-2 bg-white dark:bg-zinc-800/50 px-6 py-2 rounded-full border border-zinc-200 dark:border-zinc-700 shadow-sm">
               <span className="font-bold text-xl tracking-tight text-zinc-900 dark:text-white">Zaphics</span>
               <div className="w-1.5 h-1.5 rounded-full bg-blue-500" />
               <span className="text-xs font-medium text-muted-foreground">Enterprise</span>
             </div>
          </div>
        </div>
      </section>

      {/* 3D INTERFACE PREVIEW */}
      <section className="px-6 pb-24 overflow-hidden">
        <div className="max-w-6xl mx-auto">
          <div className="relative group perspective-1000 animate-in fade-in zoom-in-95 duration-1000 delay-300">
            <div className="absolute inset-0 bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-[32px] blur-3xl opacity-30 group-hover:opacity-50 transition-opacity duration-500 scale-95 translate-y-8" />
            
            <div className="relative bg-zinc-50 dark:bg-zinc-900 rounded-[24px] border-[6px] border-white/50 dark:border-white/10 shadow-2xl overflow-hidden aspect-[16/10] transform transition-transform duration-700 hover:scale-[1.005] hover:rotate-x-1">
              <div className="h-10 bg-white/50 dark:bg-black/20 border-b border-border flex items-center px-4 gap-1.5 backdrop-blur-md">
                <div className="flex gap-1.5">
                  <div className="w-2.5 h-2.5 rounded-full bg-red-400" />
                  <div className="w-2.5 h-2.5 rounded-full bg-yellow-400" />
                  <div className="w-2.5 h-2.5 rounded-full bg-green-400" />
                </div>
                <div className="mx-auto h-6 w-64 bg-black/5 dark:bg-white/5 rounded-md flex items-center justify-center border border-black/5 dark:border-white/5 shadow-sm">
                  <span className="text-[10px] text-muted-foreground font-medium flex items-center gap-1">
                    <Lock className="w-2.5 h-2.5" /> app.axovanth.com
                  </span>
                </div>
              </div>

              <div className="relative w-full h-full bg-white/50 dark:bg-black/50 p-6 overflow-hidden">
                 <div className="grid grid-cols-12 gap-4 h-full relative z-10">
                    <div className="col-span-2 hidden lg:flex flex-col gap-3 h-full border-r border-border pr-4">
                       <div className="h-8 w-8 bg-blue-600 rounded-lg mb-6 shadow-sm" />
                       {[1,2,3,4,5].map(i => (
                         <div key={i} className={`h-8 w-full rounded-lg ${i === 1 ? 'bg-zinc-200 dark:bg-zinc-800' : 'bg-transparent'}`} />
                       ))}
                    </div>
                    <div className="col-span-12 lg:col-span-10 grid grid-cols-4 gap-4">
                       <div className="col-span-4 h-12 flex justify-between items-center mb-2">
                          <div className="h-8 w-48 bg-zinc-200 dark:bg-zinc-800 rounded-lg" />
                          <div className="h-8 w-8 rounded-full bg-zinc-200 dark:bg-zinc-800" />
                       </div>
                       <div className="col-span-3 h-64 bg-white dark:bg-zinc-900 border border-border rounded-2xl p-6 relative overflow-hidden shadow-sm">
                          <div className="flex justify-between items-center mb-6">
                             <div className="h-4 w-24 bg-zinc-100 dark:bg-zinc-800 rounded-full" />
                             <BarChart3 className="text-blue-500 w-4 h-4" />
                          </div>
                          <div className="flex items-end gap-3 h-32 w-full">
                             {[40, 70, 50, 90, 60, 80, 45, 30, 60, 75].map((h, i) => (
                               <div key={i} className="flex-1 bg-blue-500 rounded-t opacity-90" style={{ height: `${h}%` }} />
                             ))}
                          </div>
                       </div>
                       <div className="col-span-1 h-64 flex flex-col gap-4">
                          <div className="flex-1 bg-white dark:bg-zinc-900 border border-border rounded-2xl p-4 flex flex-col justify-center items-center shadow-sm">
                             <Activity className="w-8 h-8 text-purple-500 mb-3" />
                             <div className="h-6 w-16 bg-zinc-100 dark:bg-zinc-800 rounded mb-1" />
                             <span className="text-[10px] text-muted-foreground uppercase font-bold">Load</span>
                          </div>
                          <div className="flex-1 bg-zinc-900 dark:bg-blue-600 rounded-2xl p-4 flex flex-col justify-center items-center shadow-md text-white">
                             <Users className="w-8 h-8 mb-3" />
                             <div className="h-6 w-16 bg-white/20 rounded mb-1" />
                             <span className="text-[10px] uppercase font-bold opacity-80">Users</span>
                          </div>
                       </div>
                       <div className="col-span-2 h-32 bg-white dark:bg-zinc-900 border border-border rounded-2xl p-4 shadow-sm flex items-center gap-3">
                          <div className="w-12 h-12 rounded-xl bg-orange-100 dark:bg-orange-900/20 flex items-center justify-center">
                             <Zap className="w-6 h-6 text-orange-500" />
                          </div>
                          <div>
                             <div className="h-4 w-24 bg-zinc-100 dark:bg-zinc-800 rounded mb-1.5" />
                             <div className="h-3 w-32 bg-zinc-50 dark:bg-zinc-800/50 rounded" />
                          </div>
                       </div>
                       <div className="col-span-2 h-32 bg-white dark:bg-zinc-900 border border-border rounded-2xl p-4 shadow-sm flex items-center gap-3">
                          <div className="w-12 h-12 rounded-xl bg-green-100 dark:bg-green-900/20 flex items-center justify-center">
                             <Globe className="w-6 h-6 text-green-500" />
                          </div>
                          <div>
                             <div className="h-4 w-24 bg-zinc-100 dark:bg-zinc-800 rounded mb-1.5" />
                             <div className="h-3 w-32 bg-zinc-50 dark:bg-zinc-800/50 rounded" />
                          </div>
                       </div>
                    </div>
                 </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* INTEGRATIONS TICKER */}
      <section className="py-12 border-y border-border bg-background/50">
        <div className="max-w-7xl mx-auto px-6">
          <p className="text-center text-xs font-bold text-muted-foreground uppercase tracking-widest mb-8">Seamlessly Integrates With Your Stack</p>
          <div className="flex flex-wrap justify-center gap-12 opacity-60 grayscale hover:grayscale-0 transition-all duration-500">
             {[
                { icon: Code2, label: "GitHub" },
                { icon: MessageSquare, label: "Slack" },
                { icon: Database, label: "Postgres" },
                { icon: Server, label: "AWS" },
                { icon: Smartphone, label: "Mobile" },
                { icon: GitBranch, label: "Jira" },
             ].map((item, i) => (
                <div key={i} className="flex items-center gap-2 group">
                   <item.icon className="w-6 h-6 text-foreground group-hover:text-blue-500 transition-colors" />
                   <span className="font-semibold text-sm">{item.label}</span>
                </div>
             ))}
          </div>
        </div>
      </section>

      {/* ARCHITECTURE BENTO (Enterprise/Security Section) */}
      {/* FIX: Added id="enterprise" here as well so the link works */}
      <section className="py-32" id="enterprise">
        {/* Helper span to also catch #security anchor if needed, though only one ID per element is valid in HTML. 
            We point the Enterprise link to this section. */}
        <div id="security" className="absolute -mt-32" />
        
        <div className="max-w-6xl mx-auto px-6">
          <div className="mb-20 text-center max-w-2xl mx-auto">
            <h2 className="text-3xl md:text-5xl font-bold mb-6 tracking-tight">Engineered for Scale.</h2>
            <p className="text-muted-foreground text-lg">Built on a distributed edge network designed for 99.99% uptime and <br /> sub-millisecond latency.</p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 auto-rows-[300px]">
             
             {/* Large Left Card - DARK MODE FORCED */}
             <div className="md:col-span-2 rounded-[32px] bg-zinc-900 border border-zinc-800 p-8 relative overflow-hidden group hover:border-blue-500/20 transition-all shadow-sm">
                <div className="absolute top-0 right-0 p-8 opacity-20 group-hover:opacity-40 transition-opacity">
                   <Activity className="w-48 h-48 text-blue-500" />
                </div>
                <div className="relative z-10 flex flex-col h-full justify-between">
                   <div className="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center mb-4">
                      <Zap className="w-6 h-6 text-blue-400" />
                   </div>
                   <div>
                      <h3 className="text-2xl font-bold mb-2 text-white">Real-Time Sync Protocol</h3>
                      <p className="text-zinc-400">Changes propagate instantly across all active nodes. No manual refreshing, no stale data. State management solved.</p>
                   </div>
                </div>
             </div>

             {/* Small Right Card - Security First - DARK MODE FORCED */}
             <div className="md:col-span-1 rounded-[32px] bg-zinc-900 border border-zinc-800 p-8 flex flex-col justify-between relative overflow-hidden group shadow-sm hover:border-blue-500/30 transition-all">
                <div className="absolute -bottom-4 -right-4 w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full blur-2xl opacity-10 group-hover:scale-150 transition-transform duration-700" />
                <Lock className="w-10 h-10 text-blue-400 opacity-80" />
                <div>
                   <div className="text-2xl font-bold mb-1 text-white">Security First</div>
                   <p className="text-xs font-bold uppercase tracking-wider text-zinc-400">Developed with security in mind</p>
                </div>
             </div>

             {/* Small Left Card - DARK MODE FORCED */}
             <div className="md:col-span-1 rounded-[32px] bg-zinc-900 border border-zinc-800 p-8 flex flex-col justify-between group hover:border-purple-500/20 transition-all shadow-sm">
                <div className="flex gap-2">
                   <div className="w-3 h-3 rounded-full bg-red-500" />
                   <div className="w-3 h-3 rounded-full bg-yellow-500" />
                   <div className="w-3 h-3 rounded-full bg-green-500" />
                </div>
                <div>
                   <h3 className="text-xl font-bold mb-2 text-white">Global Edge CDN</h3>
                   <p className="text-sm text-zinc-400">Assets served from 200+ edge locations worldwide.</p>
                </div>
             </div>

             {/* Large Right Card - DARK MODE FORCED */}
             <div className="md:col-span-2 rounded-[32px] bg-zinc-900 border border-zinc-800 p-8 relative overflow-hidden group hover:border-green-500/20 transition-all shadow-sm">
                <div className="absolute -right-10 top-10 opacity-10 group-hover:opacity-20 transition-opacity">
                   <Workflow className="w-64 h-64 text-green-500" />
                </div>
                <div className="relative z-10 flex flex-col h-full justify-between">
                   <div className="w-12 h-12 rounded-2xl bg-green-500/10 flex items-center justify-center mb-4">
                      <LayoutGrid className="w-6 h-6 text-green-400" />
                   </div>
                   <div>
                      <h3 className="text-2xl font-bold mb-2 text-white">Workspace Isolation</h3>
                      <p className="text-zinc-400">Keep Engineering, Sales, and Legal contexts completely separate with granular permission barriers.</p>
                   </div>
                </div>
             </div>
          </div>
        </div>
      </section>

      {/* FEATURES LIST */}
      <section className="py-24 border-t border-border bg-zinc-50 dark:bg-background" id="features">
        <div className="max-w-6xl mx-auto px-6">
          <div className="grid md:grid-cols-3 gap-8">
            <FeatureCard 
              icon={Lock}
              color="blue"
              title="Identity Kernel"
              desc="Role-Based Access Control (RBAC) with granular permissions. Secure your hierarchy from the root level down."
            />
            <FeatureCard 
              icon={Globe}
              color="green"
              title="Global Comms"
              desc="Encrypted organizational chat and broadcasting. Keep your team aligned across all timezones."
            />
            <FeatureCard 
              icon={Cpu}
              color="red"
              title="Asset Vault"
              desc="Centralized, secure storage for critical intellectual property. Drag-and-drop with version control."
            />
          </div>
        </div>
      </section>

      {/* FOOTER */}
      <footer className="py-20 border-t border-border bg-background">
        <div className="max-w-7xl mx-auto px-6">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-8 mb-16">
             <div className="col-span-2 md:col-span-1">
                <div className="flex items-center gap-2 mb-4">
                   <div className="w-6 h-6 rounded-md bg-zinc-900 dark:bg-white text-white dark:text-black flex items-center justify-center">
                      <ShieldCheck className="w-3.5 h-3.5" />
                   </div>
                   <span className="font-bold text-sm">Axovanth</span>
                </div>
                <p className="text-xs text-muted-foreground leading-relaxed">
                   The operating system for modern enterprises. Built for speed, security, and scale.
                </p>
             </div>
             <div>
                <h4 className="font-bold text-sm mb-4">Product</h4>
                <ul className="space-y-2 text-xs text-muted-foreground">
                   <li><a href="#" className="hover:text-foreground">Features</a></li>
                   <li><a href="#" className="hover:text-foreground">Integrations</a></li>
                   <li><a href="#" className="hover:text-foreground">Enterprise</a></li>
                   <li><a href="#" className="hover:text-foreground">Security</a></li>
                </ul>
             </div>
             <div>
                <h4 className="font-bold text-sm mb-4">Company</h4>
                <ul className="space-y-2 text-xs text-muted-foreground">
                   <li><a href="#" className="hover:text-foreground">About Us</a></li>
                   <li><a href="#" className="hover:text-foreground">Careers</a></li>
                   <li><a href="#" className="hover:text-foreground">Blog</a></li>
                   <li><a href="#" className="hover:text-foreground">Contact</a></li>
                </ul>
             </div>
             <div>
                <h4 className="font-bold text-sm mb-4">Legal</h4>
                <ul className="space-y-2 text-xs text-muted-foreground">
                   <li><a href="#" className="hover:text-foreground">Privacy Policy</a></li>
                   <li><a href="#" className="hover:text-foreground">Terms of Service</a></li>
                   <li><a href="#" className="hover:text-foreground">Cookie Policy</a></li>
                </ul>
             </div>
          </div>
          <div className="pt-8 border-t border-border flex flex-col md:flex-row justify-between items-center gap-4">
             <p className="text-muted-foreground text-[10px] font-medium uppercase tracking-wider">
                Â© 2026 Axovanth Inc. All rights reserved.
             </p>
          </div>
        </div>
      </footer>
    </main>
  );
}

// Feature Card - Updated to forced Dark Theme
function FeatureCard({ icon: Icon, title, desc }: any) {
  return (
    <div className="p-6 rounded-[24px] bg-zinc-900 border border-zinc-800 hover:border-zinc-700 hover:shadow-lg transition-all group duration-300">
      <div className="w-10 h-10 rounded-xl bg-zinc-800 flex items-center justify-center mb-4 group-hover:bg-blue-600 group-hover:text-white transition-colors">
        <Icon className="w-5 h-5 text-white" />
      </div>
      <h3 className="text-base font-bold mb-2 text-white tracking-tight">{title}</h3>
      <p className="text-zinc-400 leading-relaxed font-medium text-xs">{desc}</p>
    </div>
  );
}
</file>

<file path="package.json">
{
  "name": "axovanth",
  "version": "2.4.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "pages:build": "npx @cloudflare/next-on-pages",
    "convex:dev": "npx convex dev",
    "convex:deploy": "npx convex deploy"
  },
  "dependencies": {
    "@clerk/nextjs": "^6.0.0",
    "convex": "^1.17.0",
    "lucide-react": "^0.454.0",
    "next": "15.1.0",
    "next-themes": "^0.4.3",
    "react": "^19.0.0",
    "react-dom": "^19.0.0"
  },
  "devDependencies": {
    "@cloudflare/next-on-pages": "^1.13.5",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.19",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.1",
    "tailwindcss-animate": "^1.0.7",
    "typescript": "^5"
  },
  "overrides": {
    "react": "$react",
    "react-dom": "$react-dom"
  }
}
</file>

</files>
